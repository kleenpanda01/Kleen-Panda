<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kleen Panda Laundromat</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--kp-teal:#1B9AAA;--kp-teal-dark:#158393;--kp-black:#1A1A1A;--kp-gray:#6B7280;--kp-light-gray:#E5E7EB;--kp-cream:#F8F9FA;--kp-green:#10B981;--kp-red:#EF4444;--kp-yellow:#FBBF24}
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Poppins',sans-serif;background:#fff;color:#2D2D2D;line-height:1.6;font-size:1rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1.5rem;font-weight:600;border-radius:8px;border:none;cursor:pointer;font-size:1rem;transition:all .2s}
    .btn-primary{background:var(--kp-teal);color:#fff}.btn-primary:hover{background:var(--kp-teal-dark)}
    .btn-secondary{background:var(--kp-black);color:#fff}.btn-success{background:var(--kp-green);color:#fff}.btn-danger{background:var(--kp-red);color:#fff}
    .btn-outline{background:transparent;border:2px solid var(--kp-teal);color:var(--kp-teal)}.btn-outline:hover{background:var(--kp-teal);color:#fff}
    .btn-sm{padding:.4rem .8rem;font-size:.9rem}.btn-lg{padding:1rem 2rem;font-size:1.2rem}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:1.25rem}
    input,select,textarea{width:100%;padding:.75rem;border:2px solid var(--kp-light-gray);border-radius:8px;font-family:inherit;font-size:1rem}
    input:focus,select:focus{outline:none;border-color:var(--kp-teal)}
    .form-group{margin-bottom:1rem}.form-label{display:block;font-weight:600;margin-bottom:.3rem}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .badge{display:inline-block;padding:.25rem .6rem;border-radius:20px;font-size:.8rem;font-weight:600;text-transform:uppercase}
    .badge-received{background:#DBEAFE;color:#1D4ED8}.badge-cleaned{background:#D1FAE5;color:#047857}.badge-ready{background:#FEF3C7;color:#D97706}.badge-delivered{background:#E0E7FF;color:#4338CA}.badge-collected{background:#DDD6FE;color:#7C3AED}
    .dashboard-layout{display:flex;min-height:100vh}
    .sidebar{width:220px;background:var(--kp-black);color:#fff;padding:1rem;display:flex;flex-direction:column}
    .sidebar-logo{display:flex;align-items:center;gap:.5rem;padding-bottom:1rem;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:1rem}
    .sidebar-logo img{height:32px}
    .sidebar-nav{flex:1;display:flex;flex-direction:column}.sidebar-nav button.sidebar-btn{display:flex;align-items:center;gap:.5rem;padding:.6rem;color:rgba(255,255,255,.7);text-decoration:none;border-radius:8px;margin-bottom:.25rem;font-size:.95rem;background:none;border:none;cursor:pointer;text-align:left;width:100%}
    .sidebar-nav button.sidebar-btn:hover,.sidebar-nav button.sidebar-btn.active{background:rgba(27,154,170,.2);color:#fff}.sidebar-nav button.sidebar-btn.active{background:var(--kp-teal)}
    .main-content{flex:1;padding:1.5rem;background:var(--kp-cream);overflow-y:auto}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
    .pos-layout{display:grid;grid-template-columns:1fr 400px;gap:1rem;height:calc(100vh - 60px);font-size:1.3rem}
    .category-tabs{display:flex;gap:.3rem;margin-bottom:.75rem;flex-wrap:wrap}
    .category-tab{padding:.5rem 1rem;background:#fff;border:2px solid var(--kp-light-gray);border-radius:20px;cursor:pointer;font-weight:500;font-size:1.1rem}
    .category-tab.active{background:var(--kp-teal);color:#fff;border-color:var(--kp-teal)}
    .service-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.5rem}
    .service-btn{padding:.5rem;background:#fff;border:2px solid var(--kp-light-gray);border-radius:8px;cursor:pointer;text-align:center;font-size:1rem}
    .service-btn:hover{border-color:var(--kp-teal)}
    .subcat-header{font-weight:600;color:#fff;background:var(--kp-teal);text-align:center;padding:.5rem;border-radius:6px;margin-bottom:.5rem;font-size:1rem}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:.5rem 0;border-bottom:1px solid var(--kp-light-gray);font-size:1rem}
    .cart-item-qty{display:flex;align-items:center;gap:.3rem}
    .cart-item-qty button{width:30px;height:30px;border-radius:4px;border:none;background:var(--kp-light-gray);cursor:pointer;font-weight:600;font-size:1.1rem}
    .customer-panel{background:var(--kp-cream);border-radius:8px;padding:.75rem;margin-bottom:.75rem}
    table{width:100%;border-collapse:collapse}th,td{padding:.6rem;text-align:left}
    th{background:var(--kp-black);color:#fff;font-weight:600;font-size:.8rem;text-transform:uppercase}
    tr:not(:last-child) td{border-bottom:1px solid var(--kp-light-gray)}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{background:#fff;border-radius:12px;padding:1.5rem;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--kp-gray)}
    .toast{position:fixed;top:1rem;right:1rem;background:var(--kp-black);color:#fff;padding:.75rem 1.25rem;border-radius:8px;z-index:9999}
    .top-header{position:sticky;top:0;z-index:100;background:#fff;padding:.75rem 0;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .stars{color:var(--kp-yellow);font-size:1.2rem}
    .how-it-works-step{text-align:center;padding:1.5rem}
    .how-it-works-step .step-icon{font-size:3rem;margin-bottom:1rem}
    .how-it-works-step h3{color:var(--kp-teal);margin-bottom:.5rem}
    .review-badge{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem 1rem;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .lang-toggle{display:flex;gap:.25rem;background:var(--kp-light-gray);border-radius:20px;padding:2px}
    .lang-toggle button{padding:.25rem .75rem;border:none;background:transparent;border-radius:18px;cursor:pointer;font-size:.85rem}
    .lang-toggle button.active{background:var(--kp-teal);color:#fff}
    .subscription-card{border:2px solid var(--kp-light-gray);border-radius:12px;padding:1.5rem;text-align:center;transition:all .2s}
    .subscription-card:hover{border-color:var(--kp-teal);transform:translateY(-4px)}
    .subscription-card.featured{border-color:var(--kp-teal);background:linear-gradient(135deg,#E0F7FA,#fff)}
    .subscription-card .price{font-size:2rem;font-weight:700;color:var(--kp-teal)}
    .toast.success{border-left:4px solid var(--kp-green)}.toast.error{border-left:4px solid var(--kp-red)}
    .tabs{display:flex;gap:.25rem;margin-bottom:1rem;border-bottom:2px solid var(--kp-light-gray)}
    .tab{padding:.6rem 1rem;cursor:pointer;font-weight:500;color:var(--kp-gray);border-bottom:2px solid transparent;margin-bottom:-2px}
    .tab.active{color:var(--kp-teal);border-color:var(--kp-teal)}
    .pickup-option{display:flex;align-items:center;gap:1rem;padding:1rem;border:3px solid var(--kp-light-gray);border-radius:12px;cursor:pointer;margin-bottom:.75rem}
    .pickup-option:hover,.pickup-option.selected{border-color:var(--kp-teal);background:rgba(27,154,170,.05)}
    .pickup-option input{width:auto}
    @media(max-width:1024px){.pos-layout{grid-template-columns:1fr;height:auto}}
    @media(max-width:768px){.dashboard-layout{flex-direction:column}.sidebar{width:100%}.form-row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div id="app"></div>
<script>
let state={page:'home',user:null,customer:null,customerOrders:[],token:localStorage.getItem('token'),customerToken:localStorage.getItem('customerToken'),services:[],customers:[],cart:[],orders:[],selectedCustomer:null,activeCategory:'Wash & Fold',modal:null,clockedIn:false,reportPeriod:'today',selectedOrder:null,paymentMethod:'cash',adjustment:0,editingCustomer:null,customerSearch:'',photoData:null,photoOrderId:null,users:[],settings:{},editingUser:null,selectedPickupDate:null,lang:localStorage.getItem('lang')||'en',smsConsent:false,customerPaymentMethod:'pay_later',orderType:'walk-in',editingOrder:null,otherStaff:null,feedbackRating:0,viewingPhoto:null,paymentOrderId:null,paymentAmount:0,collectPaymentMethod:'cash',editingCustomerOrder:null,cancellingOrder:null,reportStartDate:'',reportEndDate:'',reportCompare:'prior_period'};

// Translations
const T={
en:{welcome:'Welcome Back',login:'Sign In',register:'Create Account',phone:'Phone',password:'Password',name:'Name',email:'Email',address:'Address',newCustomer:'New? Register',schedulePickup:'Schedule Pickup',myOrders:'My Orders',logout:'Logout',home:'Home',pickupDate:'Pickup Date',notes:'Notes',payment:'Payment',confirmPickup:'Confirm Pickup',howItWorks:'How It Works',step1Title:'Schedule',step1Desc:'Pick a date & time that works for you',step2Title:'We Pick Up',step2Desc:'Our driver collects your laundry',step3Title:'We Clean',step3Desc:'Professional wash & fold service',step4Title:'We Deliver',step4Desc:'Fresh clothes back to your door',imagineTitle:'Imagine the things you can do with your time',smsConsent:'I want to receive text updates about promos and specials to the phone number provided. Message & Data rates may apply. Message frequency may vary. Text HELP for help and STOP to cancel.',washFold:'Wash & Fold',dryCleaning:'Dry Cleaning',pickups:'Pickups',deliveries:'Deliveries',collected:'Mark Collected',delivered:'Mark Delivered',getStarted:'Get Started',subscriptions:'Membership Plans',perLb:'/lb',perMonth:'/month',weekly:'Weekly Pickup',biweekly:'Bi-Weekly Pickup',noSubscription:'Pay As You Go',payAfterPickup:'Pay After Pickup',ourServices:'Our Services',familyTime:'Family Time',exercise:'Exercise',learning:'Learning',rest:'Rest',spendTime:'Spend more time with family, hobbies, and what matters most. Let us handle your laundry.',saveMoney:'Save money with our membership plans',priorityScheduling:'Priority scheduling',flexibleScheduling:'Flexible scheduling',onDemand:'On-demand pickup',payPerOrder:'Pay per order',noMinimum:'No minimum orders',subscribe:'Subscribe',creditCard:'Credit Card',paypal:'PayPal',zelle:'Zelle',payLater:'Pay After Service',back:'Back',yourOrders:'Your Orders',noOrders:'No orders yet!',hi:'Hi',placeOrder:'Place New Order',cardNumber:'Card Number',expiry:'Expiry',cvv:'CVV',paymentMethod:'Payment Method',newOrder:'New Order',orders:'Orders',customers:'Customers',staff:'Staff',reports:'Reports',services:'Services',settings:'Settings',clockIn:'Clock In',clockOut:'Clock Out',cashDrawer:'Cash Drawer',opening:'Opening',closing:'Closing',expense:'Expense',submit:'Submit',save:'Save',cancel:'Cancel',delete:'Delete',edit:'Edit',search:'Search',received:'Received',cleaned:'Cleaned',ready:'Ready',forDelivery:'For Delivery'},
es:{welcome:'Bienvenido',login:'Iniciar SesiÃ³n',register:'Crear Cuenta',phone:'TelÃ©fono',password:'ContraseÃ±a',name:'Nombre',email:'Correo',address:'DirecciÃ³n',newCustomer:'Â¿Nuevo? RegÃ­strate',schedulePickup:'Programar Recogida',myOrders:'Mis Pedidos',logout:'Salir',home:'Inicio',pickupDate:'Fecha de Recogida',notes:'Notas',payment:'Pago',confirmPickup:'Confirmar Recogida',howItWorks:'CÃ³mo Funciona',step1Title:'Programa',step1Desc:'Elige una fecha y hora que te convenga',step2Title:'Recogemos',step2Desc:'Nuestro conductor recoge tu ropa',step3Title:'Limpiamos',step3Desc:'Servicio profesional de lavado',step4Title:'Entregamos',step4Desc:'Ropa limpia a tu puerta',imagineTitle:'Imagina lo que puedes hacer con tu tiempo',smsConsent:'Quiero recibir actualizaciones de texto sobre promociones. Pueden aplicarse tarifas de mensajes y datos. La frecuencia puede variar. EnvÃ­a HELP para ayuda y STOP para cancelar.',washFold:'Lavar y Doblar',dryCleaning:'TintorerÃ­a',pickups:'Recogidas',deliveries:'Entregas',collected:'Marcar Recogido',delivered:'Marcar Entregado',getStarted:'Comenzar',subscriptions:'Planes de MembresÃ­a',perLb:'/lb',perMonth:'/mes',weekly:'Recogida Semanal',biweekly:'Recogida Quincenal',noSubscription:'Pago por Uso',payAfterPickup:'Pagar DespuÃ©s de Recogida',ourServices:'Nuestros Servicios',familyTime:'Tiempo en Familia',exercise:'Ejercicio',learning:'Aprendizaje',rest:'Descanso',spendTime:'Pasa mÃ¡s tiempo con tu familia, pasatiempos y lo que mÃ¡s importa. Nosotros nos encargamos de tu ropa.',saveMoney:'Ahorra dinero con nuestros planes de membresÃ­a',priorityScheduling:'ProgramaciÃ³n prioritaria',flexibleScheduling:'ProgramaciÃ³n flexible',onDemand:'Recogida a demanda',payPerOrder:'Pago por pedido',noMinimum:'Sin pedido mÃ­nimo',subscribe:'Suscribirse',creditCard:'Tarjeta de CrÃ©dito',paypal:'PayPal',zelle:'Zelle',payLater:'Pagar DespuÃ©s del Servicio',back:'Volver',yourOrders:'Tus Pedidos',noOrders:'Â¡AÃºn no hay pedidos!',hi:'Hola',placeOrder:'Hacer Nuevo Pedido',cardNumber:'NÃºmero de Tarjeta',expiry:'Vencimiento',cvv:'CVV',paymentMethod:'MÃ©todo de Pago',newOrder:'Nuevo Pedido',orders:'Pedidos',customers:'Clientes',staff:'Personal',reports:'Reportes',services:'Servicios',settings:'Ajustes',clockIn:'Entrada',clockOut:'Salida',cashDrawer:'Caja',opening:'Apertura',closing:'Cierre',expense:'Gasto',submit:'Enviar',save:'Guardar',cancel:'Cancelar',delete:'Eliminar',edit:'Editar',search:'Buscar',received:'Recibido',cleaned:'Limpiado',ready:'Listo',forDelivery:'Para Entrega'}
};
const t=k=>T[state.lang]?.[k]||T.en[k]||k;
const setLang=l=>{state.lang=l;localStorage.setItem('lang',l);render();};


const api=async(ep,opt={})=>{const h={'Content-Type':'application/json'};if(state.token)h['Authorization']='Bearer '+state.token;if(state.customerToken&&!state.token)h['Authorization']='Bearer '+state.customerToken;const r=await fetch('/api'+ep,{...opt,headers:h,body:opt.body?JSON.stringify(opt.body):undefined});if(!r.ok)throw new Error((await r.json().catch(()=>({}))).error||'Error');return r.json();};
const toast=(m,t='success')=>{const e=document.createElement('div');e.className='toast '+t;e.textContent=m;document.body.appendChild(e);setTimeout(()=>e.remove(),3000);};
const formatCurrency=a=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(a||0);
const formatDate=d=>d?new Date(d).toLocaleDateString():'N/A';
const formatPhone=p=>{if(!p)return'N/A';const d=p.replace(/\D/g,'');if(d.length===10)return d.slice(0,3)+'-'+d.slice(3,6)+'-'+d.slice(6);if(d.length===11)return d.slice(1,4)+'-'+d.slice(4,7)+'-'+d.slice(7);return p;};
const isAdmin=()=>state.user?.role==='admin';
const isDriver=()=>state.user?.role==='driver';
const navigate=(p,pushHistory=true)=>{state.page=p;state.modal=null;if(pushHistory)history.pushState({page:p},'','/'+p);render();window.scrollTo(0,0);return false;};
const goHome=()=>navigate('home');
const logout=()=>{state.token=null;state.user=null;state.customer=null;state.customerToken=null;localStorage.removeItem('token');localStorage.removeItem('customerToken');navigate('home');return false;};
const closeModal=()=>{state.modal=null;render();};

// Handle browser back/forward buttons
window.addEventListener('popstate',(e)=>{if(e.state?.page){state.page=e.state.page;state.modal=null;render();}else{state.page='home';render();}});

const render=()=>{
  const app=document.getElementById('app');
  if(state.user&&isDriver()&&state.page!=='driver')state.page='driver';
  if(['pos','orders','staff','reports','services-admin','customers','settings'].includes(state.page)&&(!state.user||isDriver()))state.page='login';
  if(['my-orders','place-order'].includes(state.page)&&!state.customer)state.page='login';
  switch(state.page){
    case'login':app.innerHTML=renderLogin();break;
    case'register':app.innerHTML=renderRegister();break;
    case'my-orders':app.innerHTML=renderMyOrders();loadCustomerOrders();break;
    case'place-order':app.innerHTML=renderPlaceOrder();loadSettings();break;
    case'driver':app.innerHTML=renderDriverView();loadDriverOrders();break;
    case'pos':app.innerHTML=renderPOS();loadPOSData();break;
    case'orders':app.innerHTML=renderOrders();loadOrders();break;
    case'customers':app.innerHTML=renderCustomers();loadCustomers();break;
    case'reports':app.innerHTML=renderReports();loadReports();break;
    case'staff':app.innerHTML=renderStaff();loadStaffData();break;
    case'services-admin':app.innerHTML=renderServicesAdmin();loadServices();break;
    case'settings':app.innerHTML=renderSettings();loadSettingsPage();break;
    case'contact':app.innerHTML=renderContact();break;
    default:app.innerHTML=renderHome();loadServices();
  }
};

function getNextDates(days,n){const dm={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};const dn=days.map(d=>dm[d.trim()]).filter(x=>x!==undefined);const r=[];const t=new Date();for(let i=1;i<=30&&r.length<n;i++){const d=new Date(t);d.setDate(t.getDate()+i);if(dn.includes(d.getDay()))r.push({day:d.toLocaleDateString('en-US',{weekday:'long'}),display:d.toLocaleDateString('en-US',{month:'long',day:'numeric'}),iso:d.toISOString().slice(0,10)});}return r;}

const renderHome=()=>'<header class="top-header"><div style="max-width:1200px;margin:0 auto;padding:0 1rem;display:flex;justify-content:space-between;align-items:center"><img src="/images/logo.png" style="height:45px;cursor:pointer" onclick="goHome()"><nav style="display:flex;gap:.75rem;align-items:center"><div class="lang-toggle"><button class="'+(state.lang==='en'?'active':'')+'" onclick="setLang(\'en\')">English</button><button class="'+(state.lang==='es'?'active':'')+'" onclick="setLang(\'es\')">EspaÃ±ol</button></div>'+(state.customer?'<span>'+t('hi')+', '+state.customer.name+'</span><button type="button" class="btn-link" style="color:var(--kp-teal);font-weight:600;background:none;border:none;cursor:pointer" onclick="navigate(\'my-orders\')">'+t('myOrders')+'</button><button type="button" class="btn btn-outline btn-sm" onclick="logout()">'+t('logout')+'</button>':state.user?'<span>'+t('hi')+', '+state.user.name+'</span><button type="button" class="btn btn-primary btn-sm" onclick="navigate(\'pos\')">ğŸ›’ Dashboard</button><button type="button" class="btn btn-outline btn-sm" onclick="logout()">'+t('logout')+'</button>':'<button type="button" class="btn btn-primary btn-sm" onclick="navigate(\'login\')">'+t('login')+'</button>')+'</nav></div></header>'+
'<section style="padding:3rem 0;background:linear-gradient(135deg,#E0F7FA 0%,#fff 100%)"><div style="max-width:1200px;margin:0 auto;padding:0 1rem;display:grid;grid-template-columns:1fr 1fr;gap:2rem;align-items:center"><div><h1 style="font-size:2.5rem;margin-bottom:1rem;color:var(--kp-black)">NYC Premier Laundry<br>Pick-Up & Delivery</h1><p style="color:var(--kp-gray);font-size:1.2rem;margin-bottom:1.5rem">Professional wash & fold. <strong style="color:var(--kp-teal)">Lowest price in NYC.</strong></p><div style="display:flex;gap:1rem;margin-bottom:1.5rem"><div class="review-badge"><span class="stars">â˜…â˜…â˜…â˜…â˜†</span><span><strong>4.4</strong> Yelp</span></div><div class="review-badge"><span class="stars">â˜…â˜…â˜…â˜…â˜†</span><span><strong>4.2</strong> Google</span></div></div>'+(state.customer?'<button type="button" onclick="navigate(\'place-order\')" class="btn btn-success btn-lg">ğŸ“¦ '+t('schedulePickup')+'</button>':'<button type="button" onclick="navigate(\'register\')" class="btn btn-primary btn-lg">'+t('getStarted')+'</button>')+'</div><div style="text-align:center"><img src="/images/logo.png" style="max-width:300px;opacity:.9"></div></div></section>'+
'<section style="padding:3rem 0"><div style="max-width:1200px;margin:0 auto;padding:0 1rem"><h2 style="text-align:center;margin-bottom:2rem;color:var(--kp-teal)">'+t('howItWorks')+'</h2><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem"><div class="how-it-works-step"><div class="step-icon">ğŸ“…</div><h3>'+t('step1Title')+'</h3><p style="color:var(--kp-gray)">'+t('step1Desc')+'</p></div><div class="how-it-works-step"><div class="step-icon">ğŸšš</div><h3>'+t('step2Title')+'</h3><p style="color:var(--kp-gray)">'+t('step2Desc')+'</p></div><div class="how-it-works-step"><div class="step-icon">âœ¨</div><h3>'+t('step3Title')+'</h3><p style="color:var(--kp-gray)">'+t('step3Desc')+'</p></div><div class="how-it-works-step"><div class="step-icon">ğŸ“¦</div><h3>'+t('step4Title')+'</h3><p style="color:var(--kp-gray)">'+t('step4Desc')+'</p></div></div></div></section>'+
'<section style="padding:3rem 0;background:var(--kp-cream)"><div style="max-width:1200px;margin:0 auto;padding:0 1rem"><h2 style="text-align:center;margin-bottom:.5rem">'+t('subscriptions')+'</h2><p style="text-align:center;color:var(--kp-gray);margin-bottom:2rem">'+t('saveMoney')+'</p><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem"><div class="subscription-card featured"><h3 style="color:var(--kp-teal)">'+t('weekly')+'</h3><div class="price">$1.20<span style="font-size:1rem;font-weight:400">'+t('perLb')+'</span></div><p style="color:var(--kp-gray);margin:1rem 0">$75'+t('perMonth')+'</p><ul style="text-align:left;list-style:none;margin:1rem 0"><li>âœ“ '+t('weekly')+'</li><li>âœ“ 7am-2pm / 5pm-9pm</li><li>âœ“ '+t('priorityScheduling')+'</li></ul><button type="button" onclick="navigate(\'register\')" class="btn btn-primary" style="width:100%">'+t('subscribe')+'</button></div><div class="subscription-card"><h3>'+t('biweekly')+'</h3><div class="price">$1.20<span style="font-size:1rem;font-weight:400">'+t('perLb')+'</span></div><p style="color:var(--kp-gray);margin:1rem 0">$100'+t('perMonth')+'</p><ul style="text-align:left;list-style:none;margin:1rem 0"><li>âœ“ '+t('biweekly')+'</li><li>âœ“ 7am-2pm / 5pm-9pm</li><li>âœ“ '+t('flexibleScheduling')+'</li></ul><button type="button" onclick="navigate(\'register\')" class="btn btn-outline" style="width:100%">'+t('subscribe')+'</button></div><div class="subscription-card"><h3>'+t('noSubscription')+'</h3><div class="price">$1.50<span style="font-size:1rem;font-weight:400">'+t('perLb')+'</span></div><p style="color:var(--kp-gray);margin:1rem 0">No commitment</p><ul style="text-align:left;list-style:none;margin:1rem 0"><li>âœ“ '+t('onDemand')+'</li><li>âœ“ '+t('payPerOrder')+'</li><li>âœ“ '+t('noMinimum')+'</li></ul><button type="button" onclick="navigate(\'register\')" class="btn btn-outline" style="width:100%">'+t('getStarted')+'</button></div></div></div></section>'+
'<section style="padding:3rem 0;background:linear-gradient(135deg,var(--kp-teal),var(--kp-teal-dark));color:#fff"><div style="max-width:900px;margin:0 auto;padding:0 1rem;text-align:center"><h2 style="font-size:2rem;margin-bottom:1rem">'+t('imagineTitle')+'</h2><p style="font-size:1.2rem;opacity:.9;margin-bottom:2rem">'+t('spendTime')+'</p><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem"><div style="padding:1rem"><span style="font-size:2.5rem">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span><p>'+t('familyTime')+'</p></div><div style="padding:1rem"><span style="font-size:2.5rem">ğŸ’ª</span><p>'+t('exercise')+'</p></div><div style="padding:1rem"><span style="font-size:2.5rem">ğŸ“š</span><p>'+t('learning')+'</p></div><div style="padding:1rem"><span style="font-size:2.5rem">ğŸ˜´</span><p>'+t('rest')+'</p></div></div></div></section>'+
'<section style="padding:2rem 0;background:var(--kp-cream)"><div style="max-width:1200px;margin:0 auto;padding:0 1rem"><h2 style="text-align:center;margin-bottom:1.5rem">'+t('ourServices')+'</h2><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;max-width:600px;margin:0 auto">'+(state.customer?'<button type="button" onclick="navigate(\'place-order\')" class="btn btn-primary btn-lg" style="padding:2rem">ğŸ§º '+t('washFold')+'</button><button type="button" onclick="navigate(\'place-order\')" class="btn btn-outline btn-lg" style="padding:2rem">ğŸ‘” '+t('dryCleaning')+'</button>':'<button type="button" onclick="navigate(\'register\')" class="btn btn-primary btn-lg" style="padding:2rem">ğŸ§º '+t('washFold')+'</button><button type="button" onclick="navigate(\'register\')" class="btn btn-outline btn-lg" style="padding:2rem">ğŸ‘” '+t('dryCleaning')+'</button>')+'</div></div></section>'+
'<section style="padding:2rem 0;background:#fff"><div style="max-width:600px;margin:0 auto;padding:0 1rem;text-align:center"><h2 style="margin-bottom:1rem">ğŸ“ Share Your Feedback</h2><p style="color:var(--kp-gray);margin-bottom:1.5rem">We\'d love to hear from you! Help us improve our service.</p><button type="button" class="btn btn-outline" onclick="state.modal=\'feedback\';render()">Leave Feedback</button></div></section>'+
'<footer style="background:var(--kp-black);color:#fff;padding:1.5rem 0;text-align:center"><p>ğŸ“ 113 E Tremont Ave, Bronx | ğŸ“ (347) 297-6088 | ğŸ“§ info@kleenpanda.com</p></footer>'+(state.modal==='feedback'?renderFeedbackModal():'');

const renderLogin=()=>'<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--kp-cream)"><div class="card" style="width:100%;max-width:400px"><div style="text-align:center;margin-bottom:1.5rem"><div class="lang-toggle" style="justify-content:center;margin-bottom:1rem"><button class="'+(state.lang==='en'?'active':'')+'" onclick="setLang(\'en\')">English</button><button class="'+(state.lang==='es'?'active':'')+'" onclick="setLang(\'es\')">EspaÃ±ol</button></div><img src="/images/logo.png" style="height:60px;cursor:pointer" onclick="goHome()"><p style="color:var(--kp-gray)">'+t('welcome')+'</p></div><form onsubmit="handleLogin(event)"><div class="form-group"><label class="form-label">'+t('phone')+' or '+t('email')+'</label><input type="text" id="login-id" required placeholder="(347) 555-1234 or email@example.com"></div><div class="form-group"><label class="form-label">'+t('password')+'</label><div style="position:relative"><input type="password" id="login-password" required style="padding-right:40px"><button type="button" onclick="togglePasswordVisibility(\'login-password\',this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:1.2rem">ğŸ‘ï¸</button></div></div><button type="submit" class="btn btn-primary" style="width:100%">'+t('login')+'</button><p style="text-align:center;margin-top:1rem"><button type="button" onclick="navigate(\'register\')" style="background:none;border:none;color:var(--kp-teal);cursor:pointer">'+t('newCustomer')+'</button> | <button type="button" onclick="state.modal=\'forgot-password\';render()" style="background:none;border:none;color:var(--kp-gray);cursor:pointer">Forgot Password?</button></p></form><button type="button" onclick="goHome()" style="display:block;width:100%;text-align:center;margin-top:1rem;background:none;border:none;color:var(--kp-gray);cursor:pointer">â† '+t('home')+'</button></div></div>'+(state.modal==='forgot-password'?renderForgotPasswordModal():'')+(state.modal==='reset-code'?renderResetCodeModal():'');

const renderForgotPasswordModal=()=>'<div class="modal-overlay" onclick="closeModal()"><div class="modal" style="max-width:400px" onclick="event.stopPropagation()"><div class="modal-header"><h3>ğŸ”‘ Reset Password</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><p style="color:var(--kp-gray);margin-bottom:1rem">Enter your phone number and we\'ll send you a reset code via SMS.</p><form onsubmit="requestPasswordReset(event)"><div class="form-group"><label class="form-label">Phone Number</label><input type="tel" id="reset-phone" required placeholder="(555) 555-5555"></div><button type="submit" class="btn btn-primary" style="width:100%">Send Reset Code</button></form></div></div>';

const renderResetCodeModal=()=>'<div class="modal-overlay" onclick="closeModal()"><div class="modal" style="max-width:400px" onclick="event.stopPropagation()"><div class="modal-header"><h3>ğŸ”‘ Enter Code</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><p style="color:var(--kp-gray);margin-bottom:1rem">Enter the 6-digit code sent to your phone.</p><form onsubmit="submitPasswordReset(event)"><div class="form-group"><label class="form-label">Reset Code</label><input type="text" id="reset-code" required placeholder="123456" maxlength="6" style="text-align:center;font-size:1.5rem;letter-spacing:.5rem"></div><div class="form-group"><label class="form-label">New Password</label><input type="password" id="new-password" required minlength="4"></div><button type="submit" class="btn btn-success" style="width:100%">Reset Password</button></form></div></div>';

const renderFeedbackModal=()=>'<div class="modal-overlay" onclick="closeModal()"><div class="modal" style="max-width:500px" onclick="event.stopPropagation()"><div class="modal-header"><h3>ğŸ“ Customer Feedback</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><form onsubmit="submitFeedback(event)"><div class="form-group"><label class="form-label">Your Name (optional)</label><input type="text" id="feedback-name" placeholder="Your name"></div><div class="form-row"><div class="form-group"><label class="form-label">Email (optional)</label><input type="email" id="feedback-email" placeholder="email@example.com"></div><div class="form-group"><label class="form-label">Phone (optional)</label><input type="tel" id="feedback-phone" placeholder="(555) 555-5555"></div></div><div class="form-group"><label class="form-label">How would you rate us?</label><div id="feedback-rating" style="display:flex;gap:.5rem;font-size:2rem;cursor:pointer"><span onclick="setFeedbackRating(1)" class="rating-star">â˜†</span><span onclick="setFeedbackRating(2)" class="rating-star">â˜†</span><span onclick="setFeedbackRating(3)" class="rating-star">â˜†</span><span onclick="setFeedbackRating(4)" class="rating-star">â˜†</span><span onclick="setFeedbackRating(5)" class="rating-star">â˜†</span></div></div><div class="form-group"><label class="form-label">Your Message *</label><textarea id="feedback-message" rows="4" required placeholder="Tell us about your experience..."></textarea></div><button type="submit" class="btn btn-primary" style="width:100%">Submit Feedback</button></form></div></div>';

const renderRegister=()=>'<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--kp-cream);padding:1rem"><div class="card" style="width:100%;max-width:500px"><div style="text-align:center;margin-bottom:1.5rem"><div class="lang-toggle" style="justify-content:center;margin-bottom:1rem"><button class="'+(state.lang==='en'?'active':'')+'" onclick="setLang(\'en\')">English</button><button class="'+(state.lang==='es'?'active':'')+'" onclick="setLang(\'es\')">EspaÃ±ol</button></div><img src="/images/logo.png" style="height:60px;cursor:pointer" onclick="goHome()"><h2 style="color:var(--kp-teal)">'+t('register')+'</h2></div><form onsubmit="handleRegister(event)"><div class="form-row"><div class="form-group"><label class="form-label">'+t('name')+' *</label><input type="text" id="reg-name" required></div><div class="form-group"><label class="form-label">'+t('phone')+' *</label><input type="tel" id="reg-phone" required placeholder="(xxx) xxx-xxxx"></div></div><div class="form-group"><label class="form-label">'+t('email')+'</label><input type="email" id="reg-email"></div><div class="form-group"><label class="form-label">'+t('address')+'</label><input type="text" id="reg-address"></div><div class="form-group"><label class="form-label">'+t('password')+' *</label><div style="position:relative"><input type="password" id="reg-password" required minlength="4" style="padding-right:40px"><button type="button" onclick="togglePasswordVisibility(\'reg-password\',this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:1.2rem">ğŸ‘ï¸</button></div></div><div class="form-group"><label class="form-label">'+t('subscriptions')+'</label><select id="reg-plan" onchange="checkZelleDisplay()"><option value="">'+t('noSubscription')+'</option><option value="weekly">'+t('weekly')+' - $1.20/lb ($75/month)</option><option value="biweekly">'+t('biweekly')+' - $1.20/lb ($100/month)</option></select></div><div class="form-group"><label class="form-label">How would you like order updates?</label><div style="display:flex;gap:1rem"><label style="display:flex;align-items:center;gap:.5rem;cursor:pointer"><input type="radio" name="notify-pref" value="sms" checked style="width:auto"> ğŸ“± Text (SMS)</label><label style="display:flex;align-items:center;gap:.5rem;cursor:pointer"><input type="radio" name="notify-pref" value="email" style="width:auto"> ğŸ“§ Email</label></div></div><div class="form-group" style="background:var(--kp-cream);padding:1rem;border-radius:8px"><label style="display:flex;gap:.75rem;cursor:pointer;align-items:flex-start"><input type="checkbox" id="reg-sms-consent" required style="width:auto;margin-top:4px"><span style="font-size:.85rem;color:var(--kp-gray)">'+t('smsConsent')+'</span></label></div><button type="submit" class="btn btn-primary" style="width:100%">'+t('register')+'</button></form><button type="button" onclick="goHome()" style="display:block;width:100%;text-align:center;margin-top:1rem;background:none;border:none;color:var(--kp-gray);cursor:pointer">â† '+t('home')+'</button></div></div>';

const renderMyOrders=()=>'<header class="top-header"><div style="max-width:1200px;margin:0 auto;padding:0 1rem;display:flex;justify-content:space-between;align-items:center"><img src="/images/logo.png" style="height:40px;cursor:pointer" onclick="goHome()"><div><button type="button" onclick="goHome()" style="background:none;border:none;color:var(--kp-teal);cursor:pointer;margin-right:1rem">'+t('home')+'</button><button type="button" class="btn btn-outline btn-sm" onclick="logout()">'+t('logout')+'</button></div></div></header><section style="padding:2rem 0;min-height:80vh;background:var(--kp-cream)"><div style="max-width:800px;margin:0 auto;padding:0 1rem"><div style="text-align:center;margin-bottom:2rem"><h1 style="color:var(--kp-teal)">'+t('hi')+', '+(state.customer?.name||'')+' ğŸ‰</h1><button type="button" onclick="navigate(\'place-order\')" class="btn btn-success btn-lg" style="margin-top:1rem">ğŸ“¦ '+t('placeOrder')+'</button></div><h2 style="margin-bottom:1rem">'+t('yourOrders')+'</h2><div id="customer-orders-list"></div><div class="card" style="margin-top:2rem;text-align:center;background:#fff"><h3>ğŸ“ Need Help?</h3><p style="margin:.5rem 0">Call, text, or email us with any questions about your order</p><div style="display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;margin:.75rem 0"><a href="tel:3472976088" class="btn btn-primary">ğŸ“ (347) 297-6088</a><a href="mailto:info@kleenpanda.com" class="btn btn-outline">ğŸ“§ info@kleenpanda.com</a></div><p style="font-size:.9rem;color:var(--kp-gray);margin-top:.5rem">ğŸ“ 113 E Tremont Ave, Bronx, NY 10453</p></div></div></section>'+(state.modal==='edit-customer-order'?renderEditCustomerOrderModal():'')+(state.modal==='cancel-order'?renderCancelOrderModal():'');

const renderEditCustomerOrderModal=()=>{const o=state.editingCustomerOrder;if(!o)return'';return'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-header"><h3>Edit Order '+o.order_number+'</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><form onsubmit="saveCustomerOrderEdit(event)"><div class="form-group"><label class="form-label">Notes / Special Instructions</label><textarea id="cust-order-notes" rows="3" placeholder="Add any special instructions...">'+(o.notes||'')+'</textarea></div><div style="display:flex;gap:.5rem"><button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal()">Cancel</button><button type="submit" class="btn btn-primary" style="flex:1">Save Changes</button></div></form></div></div>';};

const renderCancelOrderModal=()=>{const o=state.cancellingOrder;if(!o)return'';return'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-header"><h3>Cancel Order?</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><p style="margin-bottom:1rem">Are you sure you want to cancel order <strong>'+o.order_number+'</strong>?</p><p style="color:var(--kp-red);margin-bottom:1rem">This cannot be undone.</p><div style="display:flex;gap:.5rem"><button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal()">Keep Order</button><button type="button" class="btn btn-danger" style="flex:1" onclick="confirmCancelOrder('+o.id+')">Yes, Cancel</button></div></div></div>';};

const renderPlaceOrder=()=>'<header class="top-header"><div style="max-width:1200px;margin:0 auto;padding:0 1rem;display:flex;justify-content:space-between;align-items:center"><img src="/images/logo.png" style="height:40px;cursor:pointer" onclick="goHome()"><div><button type="button" onclick="navigate(\'my-orders\')" style="background:none;border:none;color:var(--kp-teal);cursor:pointer;margin-right:1rem">â† '+t('back')+'</button><button type="button" class="btn btn-outline btn-sm" onclick="logout()">'+t('logout')+'</button></div></div></header><section style="padding:2rem 0;min-height:80vh;background:linear-gradient(135deg,var(--kp-cream),#e8f4f5)"><div style="max-width:550px;margin:0 auto;padding:0 1rem"><div style="text-align:center;margin-bottom:2rem"><div style="font-size:3rem">ğŸ“¦</div><h1 style="color:var(--kp-teal)">'+t('schedulePickup')+'</h1></div><div class="card" style="padding:2rem"><form onsubmit="submitCustomerOrder(event)"><div class="form-group"><label class="form-label" style="font-size:1.1rem">ğŸ“… '+t('pickupDate')+'</label><div id="pickup-dates"></div></div><div class="form-group"><label class="form-label" style="font-size:1.1rem">ğŸ“ '+t('address')+'</label><input type="text" id="order-address" required style="font-size:1.1rem;padding:1rem" placeholder="Enter your pickup address"></div><div class="form-group"><label class="form-label" style="font-size:1.1rem">ğŸ“ '+t('notes')+'</label><textarea id="order-notes" rows="2" placeholder="Gate code, instructions..."></textarea></div><div style="background:var(--kp-cream);padding:1.25rem;border-radius:12px;margin:1.5rem 0"><label class="form-label" style="font-size:1.1rem">ğŸ’³ '+t('paymentMethod')+'</label><div style="display:flex;flex-direction:column;gap:.5rem"><label class="pickup-option" onclick="selectCustomerPayment(\'credit_card\')"><input type="radio" name="payment-type" value="credit_card" style="width:auto"><div style="flex:1"><strong>ğŸ’³ '+t('creditCard')+'</strong></div></label><label class="pickup-option" onclick="selectCustomerPayment(\'paypal\')"><input type="radio" name="payment-type" value="paypal" style="width:auto"><div style="flex:1"><strong>ğŸ…¿ï¸ '+t('paypal')+'</strong></div></label><label class="pickup-option" onclick="selectCustomerPayment(\'zelle\')"><input type="radio" name="payment-type" value="zelle" style="width:auto"><div style="flex:1"><strong>ğŸ’¸ '+t('zelle')+'</strong></div></label><label class="pickup-option selected" onclick="selectCustomerPayment(\'pay_later\')"><input type="radio" name="payment-type" value="pay_later" checked style="width:auto"><div style="flex:1"><strong>â³ '+t('payLater')+'</strong><p style="font-size:.85rem;color:var(--kp-gray);margin:0">Pay after we weigh your laundry</p></div></label></div><div id="zelle-info" style="display:none;margin-top:1rem;padding:1rem;background:#fff;border-radius:8px;text-align:center;border:2px solid var(--kp-teal)"><p style="font-weight:600;margin-bottom:.5rem">ğŸ’¸ Send Zelle payment to:</p><p style="font-size:1.3rem;color:var(--kp-teal);font-weight:700">'+(state.settings?.zelle_id||'info@kleenpanda.com')+'</p><p style="font-size:.85rem;color:var(--kp-gray);margin-top:.5rem">Payment will be matched to your order</p></div></div><button type="submit" class="btn btn-success" style="width:100%;padding:1.25rem;font-size:1.2rem">âœ“ '+t('confirmPickup')+'</button></form></div></div></section>';

const renderDriverView=()=>'<div style="min-height:100vh;background:var(--kp-cream)"><header style="background:var(--kp-black);padding:1rem;position:sticky;top:0;z-index:100"><div style="max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center"><div style="display:flex;align-items:center;gap:1rem"><img src="/images/logo.png" style="height:40px;cursor:pointer" onclick="goHome()"><span style="color:#fff;font-weight:600">ğŸšš Driver: '+(state.user?.name||'')+'</span></div><div class="lang-toggle" style="margin-right:1rem"><button class="'+(state.lang==='en'?'active':'')+'" onclick="setLang(\'en\')">English</button><button class="'+(state.lang==='es'?'active':'')+'" onclick="setLang(\'es\')">EspaÃ±ol</button></div><button class="btn btn-sm btn-danger" onclick="return logout()">'+t('logout')+'</button></div></header><main style="max-width:1000px;margin:0 auto;padding:1.5rem"><div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem"><div><h2 style="color:var(--kp-teal);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem">ğŸ“¦ '+t('pickups')+'</h2><div id="driver-pickups-list"></div></div><div><h2 style="color:var(--kp-green);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem">ğŸšš '+t('deliveries')+'</h2><div id="driver-deliveries-list"></div></div></div></main></div>'+(state.modal==='photo'?renderPhotoModal():'')+(state.modal==='view-photo'?'<div class="modal-overlay" onclick="closeModal()"><div class="modal" style="max-width:600px" onclick="event.stopPropagation()"><div class="modal-header"><h3>ğŸ“¸ Delivery Photo</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><img src="'+state.viewingPhoto+'" style="width:100%;border-radius:8px"></div></div>':'');

const renderPhotoModal=()=>'<div class="modal-overlay"><div class="modal" style="max-width:400px"><div class="modal-header"><h3>ğŸ“¸ Photo Proof</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>'+(state.photoData?'<img src="'+state.photoData+'" style="width:100%;border-radius:8px"><div style="display:flex;gap:.5rem;margin-top:1rem"><button class="btn btn-outline" style="flex:1" onclick="retakePhoto()">Retake</button><button class="btn btn-success" style="flex:1" onclick="confirmDelivery()">Confirm</button></div>':'<video id="camera-feed" autoplay playsinline style="width:100%;border-radius:8px"></video><canvas id="photo-canvas" style="display:none"></canvas><button class="btn btn-primary" style="width:100%;margin-top:1rem" onclick="capturePhoto()">ğŸ“¸ Take Photo</button>')+'</div></div>';

const renderContact=()=>'<div class="card" style="max-width:600px;margin:2rem auto;text-align:center"><h1>Contact Us</h1><p>ğŸ“§ info@kleenpanda.com</p><p>ğŸ“ Store: (347) 297-6088</p><p>ğŸ“ Manager: (347) 230-8400 ext.1 or 2</p><p>ğŸ“ 113 E Tremont Ave, Bronx, NY 10453</p><button type="button" onclick="navigate(\'home\')" style="background:none;border:none;color:var(--kp-teal);cursor:pointer">â† Back</button></div>';

const renderSidebar=()=>'<aside class="sidebar"><div class="sidebar-logo" style="cursor:pointer" onclick="goHome()"><img src="/images/icon.png"><strong>Kleen Panda</strong></div><div style="padding:.5rem 1rem;text-align:center;color:#fff;font-size:1.1rem">'+t('hi')+', <strong>'+(state.user?.name||'')+'</strong>!</div><div class="lang-toggle" style="justify-content:center;margin:.5rem 1rem"><button class="'+(state.lang==='en'?'active':'')+'" onclick="setLang(\'en\')" style="font-size:.8rem">English</button><button class="'+(state.lang==='es'?'active':'')+'" onclick="setLang(\'es\')" style="font-size:.8rem">EspaÃ±ol</button></div><nav class="sidebar-nav"><button type="button" class="sidebar-btn '+(state.page==='pos'?'active':'')+'" onclick="navigate(\'pos\')">ğŸ›’ '+t('newOrder')+'</button><button type="button" class="sidebar-btn '+(state.page==='orders'?'active':'')+'" onclick="navigate(\'orders\')">ğŸ“‹ '+t('orders')+'</button><button type="button" class="sidebar-btn '+(state.page==='customers'?'active':'')+'" onclick="navigate(\'customers\')">ğŸ‘¥ '+t('customers')+'</button><button type="button" class="sidebar-btn '+(state.page==='staff'?'active':'')+'" onclick="navigate(\'staff\')">ğŸ‘¤ '+t('staff')+'</button>'+(isAdmin()?'<button type="button" class="sidebar-btn '+(state.page==='reports'?'active':'')+'" onclick="navigate(\'reports\')">ğŸ“Š '+t('reports')+'</button><button type="button" class="sidebar-btn '+(state.page==='services-admin'?'active':'')+'" onclick="navigate(\'services-admin\')">âš™ï¸ '+t('services')+'</button><button type="button" class="sidebar-btn '+(state.page==='settings'?'active':'')+'" onclick="navigate(\'settings\')">ğŸ”§ '+t('settings')+'</button>':'')+'</nav><div style="padding:.75rem 1rem;border-top:1px solid rgba(255,255,255,.1)"><span style="opacity:.7;font-size:.85rem">'+(state.user?.role||'')+'</span><button class="btn btn-danger btn-sm" style="width:100%;margin-top:.5rem" onclick="logout()">ğŸšª '+t('logout')+'</button></div></aside>';

const renderPOS=()=>'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="pos-layout"><div class="card" style="overflow-y:auto"><div class="category-tabs" id="category-tabs"></div><div id="service-grid"></div></div><div class="card" style="display:flex;flex-direction:column"><div class="customer-panel" id="customer-display"></div><div style="display:flex;gap:.5rem;margin-bottom:.5rem"><button class="btn btn-sm '+(state.orderType==='walk-in'?'btn-primary':'btn-outline')+'" style="flex:1" onclick="state.orderType=\'walk-in\';render()">ğŸš¶ Walk-In</button><button class="btn btn-sm '+(state.orderType==='pickup_delivery'?'btn-success':'btn-outline')+'" style="flex:1" onclick="state.orderType=\'pickup_delivery\';render()">ğŸšš Pickup/Delivery</button></div><h3>Cart</h3><div id="cart-items" style="flex:1;overflow-y:auto;max-height:160px"></div><button class="btn btn-outline btn-sm" style="margin:.5rem 0;width:100%" onclick="addMinimumOrder()">âš¡ Minimum ($15 / 10 lbs)</button><div style="margin:.5rem 0;display:flex;justify-content:space-between;align-items:center"><span>Adjustment</span><div style="display:flex;align-items:center;gap:.25rem">$<input type="number" step="0.01" id="order-adjustment" value="0" style="width:70px;text-align:right" onchange="state.adjustment=parseFloat(this.value)||0;renderCart()"></div></div><div id="cart-totals" style="border-top:2px solid var(--kp-teal);padding-top:.5rem"></div><div style="margin-top:.5rem"><div style="font-weight:600;margin-bottom:.4rem">Payment</div><div id="payment-buttons" style="display:grid;grid-template-columns:1fr 1fr;gap:.3rem"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-top:.75rem"><button class="btn btn-secondary" onclick="clearCart()">Clear</button><button class="btn btn-success" onclick="submitOrder()">âœ“ Complete</button></div></div></div></main></div>'+(state.modal==='customer'?renderCustomerModal():'');

const renderCustomerModal=()=>'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-header"><h3>Customer</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="form-group"><input type="text" placeholder="Search phone/name" oninput="searchCustomer(this.value)"></div><div id="search-results"></div><hr style="margin:1rem 0"><div class="form-row"><div class="form-group"><label class="form-label">Name *</label><input type="text" id="cust-name"></div><div class="form-group"><label class="form-label">Phone *</label><input type="tel" id="cust-phone"></div></div><div class="form-group"><label class="form-label">Address</label><input type="text" id="cust-address"></div><div style="display:flex;gap:.5rem"><button class="btn btn-outline" style="flex:1" onclick="closeModal()">Cancel</button><button class="btn btn-primary" style="flex:1" onclick="saveCustomer()">Save</button></div></div></div>';

const renderOrders=()=>'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header"><h1>'+t('orders')+'</h1></div><div class="card"><div id="orders-table"></div></div></main></div>'+(state.modal==='order-detail'?renderOrderModal():'')+(state.modal==='edit-order'?renderEditOrderModal():'')+(state.modal==='payment'?renderPaymentModal():'');

const renderOrderModal=()=>{const o=state.selectedOrder;if(!o)return'';const st=['received','cleaned','ready','delivered'],ci=st.indexOf(o.status);return'<div class="modal-overlay" onclick="closeModal()"><div class="modal" style="max-width:500px" onclick="event.stopPropagation()"><div class="modal-header"><h3>'+o.order_number+'</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div style="display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap">'+st.map((s,i)=>'<button class="btn btn-sm '+(i<=ci?'btn-success':'btn-outline')+'" onclick="updateOrderStatus('+o.id+',\''+s+'\')">'+s+'</button>').join('')+'</div><div style="background:var(--kp-cream);padding:1rem;border-radius:8px;margin-bottom:1rem"><p><strong>Customer:</strong> '+(o.customer_name||'Walk-in')+'</p><p><strong>Phone:</strong> '+formatPhone(o.customer_phone)+'</p><p><strong>Type:</strong> '+(o.order_type||'counter')+'</p><p><strong>Total:</strong> '+formatCurrency(o.total)+'</p><p><strong>Payment:</strong> <span class="badge badge-'+(o.payment_status==='paid'?'ready':'received')+'">'+(o.payment_status||'unpaid')+'</span> '+(o.payment_method?'('+o.payment_method+')':'')+'</p>'+(o.delivery_photo?'<button class="btn btn-outline btn-sm" onclick="viewDeliveryPhoto(\''+o.delivery_photo+'\')">ğŸ“¸ View Delivery Photo</button>':'')+'</div>'+(o.payment_status!=='paid'?'<div style="margin-bottom:1rem"><button class="btn btn-success" style="width:100%" onclick="showPaymentModal('+o.id+','+o.total+')">ğŸ’³ Collect Payment - '+formatCurrency(o.total)+'</button></div>':'')+'<div style="display:flex;gap:.5rem;flex-wrap:wrap"><button class="btn btn-outline" onclick="printReceipt('+o.id+')">ğŸ–¨ï¸ Print</button><button class="btn btn-outline" style="flex:1" onclick="editOrder('+o.id+')">âœï¸ '+t('edit')+'</button>'+(isAdmin()?'<button class="btn btn-danger" onclick="deleteOrder('+o.id+')">ğŸ—‘ï¸ '+t('delete')+'</button>':'')+'<button class="btn btn-primary" style="flex:1" onclick="closeModal()">Close</button></div></div></div>';};

const renderPaymentModal=()=>'<div class="modal-overlay" onclick="closeModal()"><div class="modal" style="max-width:450px" onclick="event.stopPropagation()"><div class="modal-header"><h3>ğŸ’³ Collect Payment</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div style="text-align:center;margin-bottom:1rem"><div style="font-size:2rem;font-weight:700;color:var(--kp-teal)">'+formatCurrency(state.paymentAmount)+'</div></div><div class="form-group"><label class="form-label">Payment Method</label><div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem"><button type="button" class="btn '+(state.collectPaymentMethod==='cash'?'btn-primary':'btn-outline')+'" onclick="state.collectPaymentMethod=\'cash\';render()">ğŸ’µ Cash</button><button type="button" class="btn '+(state.collectPaymentMethod==='card'?'btn-primary':'btn-outline')+'" onclick="state.collectPaymentMethod=\'card\';render()">ğŸ’³ Card</button><button type="button" class="btn '+(state.collectPaymentMethod==='terminal'?'btn-primary':'btn-outline')+'" onclick="state.collectPaymentMethod=\'terminal\';render()">ğŸ”Œ Terminal</button><button type="button" class="btn '+(state.collectPaymentMethod==='zelle'?'btn-primary':'btn-outline')+'" onclick="state.collectPaymentMethod=\'zelle\';render()">ğŸ“± Zelle</button></div></div>'+(state.collectPaymentMethod==='card'?'<div style="background:var(--kp-cream);padding:1rem;border-radius:8px;margin-top:1rem"><p style="font-size:.9rem;color:var(--kp-teal);margin-bottom:.5rem;font-weight:600">ğŸ’³ Enter customer card details:</p><div class="form-group"><label class="form-label">Card Number</label><input type="text" id="pay-card-number" maxlength="19" placeholder="1234 5678 9012 3456" oninput="formatCardNumber(this)"></div><div class="form-row"><div class="form-group"><label class="form-label">Expiry</label><input type="text" id="pay-card-expiry" maxlength="5" placeholder="MM/YY" oninput="formatExpiry(this)"></div><div class="form-group"><label class="form-label">CVV</label><input type="password" id="pay-card-cvv" maxlength="4" placeholder="â€¢â€¢â€¢"></div></div><p style="font-size:.8rem;color:var(--kp-green);margin-top:.5rem">âœ“ Card will be charged '+formatCurrency(state.paymentAmount)+' via Clearent</p></div>':'')+(state.collectPaymentMethod==='zelle'?'<div style="background:var(--kp-cream);padding:1rem;border-radius:8px;margin-top:1rem;text-align:center"><p style="font-weight:600">Send Zelle to:</p><p style="font-size:1.2rem;color:var(--kp-teal)">'+(state.settings?.zelle_id||'info@kleenpanda.com')+'</p><p style="font-size:.9rem;color:var(--kp-gray);margin-top:.5rem">Confirm payment received before marking paid</p></div>':'')+(state.collectPaymentMethod==='terminal'?'<div style="background:var(--kp-cream);padding:1rem;border-radius:8px;margin-top:1rem;text-align:center"><p>ğŸ”Œ Swipe/insert card on terminal</p><p style="font-size:.9rem;color:var(--kp-gray)">Payment will be processed automatically</p></div>':'')+(state.collectPaymentMethod==='cash'?'<div style="background:var(--kp-cream);padding:1rem;border-radius:8px;margin-top:1rem;text-align:center"><p style="font-size:1.5rem">ğŸ’µ</p><p>Collect '+formatCurrency(state.paymentAmount)+' cash from customer</p></div>':'')+'<div style="display:flex;gap:.5rem;margin-top:1rem"><button type="button" class="btn btn-outline" style="flex:1" onclick="state.modal=\'order-detail\';render()">Cancel</button><button type="button" class="btn btn-success" style="flex:1" onclick="processPayment()">'+(state.collectPaymentMethod==='card'?'ğŸ’³ Charge Card':'âœ“ Mark Paid')+'</button></div></div></div>';

const renderEditOrderModal=()=>{const o=state.editingOrder;if(!o)return'';const items=o.items||[];return'<div class="modal-overlay" onclick="closeModal()"><div class="modal" style="max-width:550px" onclick="event.stopPropagation()"><div class="modal-header"><h3>Edit '+o.order_number+'</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><form onsubmit="saveOrderEdit(event)"><div class="form-group"><label class="form-label">Order Type</label><select id="edit-order-type"><option value="walk-in" '+(o.order_type==='walk-in'?'selected':'')+'>ğŸš¶ Walk-In</option><option value="pickup_delivery" '+(o.order_type==='pickup_delivery'?'selected':'')+'>ğŸšš Pickup/Delivery</option></select></div><div class="form-group"><label class="form-label">Items</label><div id="edit-items-list" style="max-height:200px;overflow-y:auto">'+items.map((item,i)=>'<div style="display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem;padding:.5rem;background:var(--kp-cream);border-radius:6px"><span style="flex:1;font-size:.9rem">'+item.service_name+'</span><input type="number" id="edit-item-qty-'+i+'" value="'+item.quantity+'" min="0" step="0.1" style="width:60px;text-align:center"><span style="font-size:.9rem">Ã— '+formatCurrency(item.price)+'</span><button type="button" onclick="removeEditItem('+i+')" style="background:var(--kp-red);color:#fff;border:none;border-radius:4px;padding:2px 6px;cursor:pointer">Ã—</button></div>').join('')+'</div><div style="margin-top:.5rem;padding:.5rem;background:#e8f4f5;border-radius:6px"><label class="form-label" style="font-size:.9rem">â• Add Item</label><div style="display:flex;gap:.5rem"><select id="add-item-service" style="flex:2"><option value="">Select service...</option>'+state.services.filter(s=>s.active).map(s=>'<option value="'+s.id+'" data-price="'+s.price+'" data-name="'+s.name+'">'+s.name+' - '+formatCurrency(s.price)+'</option>').join('')+'</select><input type="number" id="add-item-qty" placeholder="Qty" min="0.1" step="0.1" style="width:60px" value="1"><button type="button" class="btn btn-sm btn-primary" onclick="addEditItem()">Add</button></div></div></div><div class="form-group"><label class="form-label">Adjustment ($)</label><input type="number" id="edit-adjustment" step="0.01" value="'+(o.adjustment||0)+'"></div><div class="form-group"><label class="form-label">Notes</label><textarea id="edit-notes" rows="2">'+(o.notes||'')+'</textarea></div><div class="form-group"><label class="form-label">Payment Status</label><select id="edit-payment-status"><option value="unpaid" '+(o.payment_status==='unpaid'?'selected':'')+'>Unpaid</option><option value="paid" '+(o.payment_status==='paid'?'selected':'')+'>Paid</option></select></div><div style="display:flex;gap:.5rem"><button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal()">Cancel</button><button type="submit" class="btn btn-success" style="flex:1">ğŸ’¾ Save Changes</button></div></form></div></div>';};

const renderCustomers=()=>'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header"><h1>'+t('customers')+'</h1></div><div class="card" style="margin-bottom:1rem"><input type="text" placeholder="ğŸ” '+t('search')+'..." oninput="state.customerSearch=this.value;renderCustomerList()"></div><div class="card"><div id="customers-list"></div></div></main></div>'+(state.modal==='edit-customer'&&state.editingCustomer?'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-header"><h3>'+t('edit')+' Customer</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><form onsubmit="updateCustomerProfile(event)"><div class="form-row"><div class="form-group"><label class="form-label">'+t('name')+' *</label><input type="text" id="edit-cust-name" value="'+state.editingCustomer.name+'" required></div><div class="form-group"><label class="form-label">'+t('phone')+' *</label><input type="tel" id="edit-cust-phone" value="'+(state.editingCustomer.phone||'')+'" required></div></div><div class="form-group"><label class="form-label">'+t('email')+'</label><input type="email" id="edit-cust-email" value="'+(state.editingCustomer.email||'')+'"></div><div class="form-group"><label class="form-label">'+t('address')+'</label><input type="text" id="edit-cust-address" value="'+(state.editingCustomer.address||'')+'"></div><div class="form-row"><div class="form-group"><label class="form-label">Discount %</label><input type="number" id="edit-cust-discount" value="'+(state.editingCustomer.discount||0)+'" min="0" max="100"></div><div class="form-group"><label class="form-label">Plan</label><select id="edit-cust-plan"><option value="">None</option><option value="weekly" '+(state.editingCustomer.subscription_plan==='weekly'?'selected':'')+'>Weekly</option><option value="biweekly" '+(state.editingCustomer.subscription_plan==='biweekly'?'selected':'')+'>Bi-Weekly</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Card Last 4</label><input type="text" id="edit-cust-card" maxlength="4" value="'+(state.editingCustomer.card_last_four||'')+'" placeholder="1234"></div><div class="form-group"><label class="form-label">Zelle ID</label><input type="text" id="edit-cust-zelle" value="'+(state.editingCustomer.zelle_id||'')+'" placeholder="email or phone"></div></div><div style="display:flex;gap:.5rem;flex-wrap:wrap">'+(isAdmin()?'<button type="button" class="btn btn-danger" onclick="deleteCustomer('+state.editingCustomer.id+')">ğŸ—‘ï¸ '+t('delete')+'</button>':'')+'<button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal()">'+t('cancel')+'</button><button type="submit" class="btn btn-primary" style="flex:1">'+t('save')+'</button></div></form></div></div>':'');

const renderStaff=()=>{const today=new Date().toISOString().slice(0,10);const weekAgo=new Date(Date.now()-7*24*60*60*1000).toISOString().slice(0,10);return'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header"><h1>Staff</h1></div>'+(!isAdmin()?'<div class="card" style="margin-bottom:1rem"><h3>Time Clock</h3><div id="clock-status"></div></div>':'')+'<div class="card" style="margin-bottom:1rem"><h3>Cash Drawer</h3><div id="cash-status"></div><div class="tabs"><div class="tab active" onclick="showCashTab(\'opening\',this)">Opening</div><div class="tab" onclick="showCashTab(\'closing\',this)">Closing</div><div class="tab" onclick="showCashTab(\'expense\',this)">Expense</div></div><div id="cash-form-area"></div></div>'+(isAdmin()?'<div class="card" style="margin-bottom:1rem"><h3>Staff Summary</h3><div style="display:flex;gap:1rem;align-items:flex-end;margin-bottom:1rem;flex-wrap:wrap"><div class="form-group" style="margin:0"><label class="form-label">From</label><input type="date" id="staff-date-start" value="'+weekAgo+'"></div><div class="form-group" style="margin:0"><label class="form-label">To</label><input type="date" id="staff-date-end" value="'+today+'"></div><button class="btn btn-primary" onclick="loadStaffSummary()">ğŸ” Search</button><button class="btn btn-sm btn-outline" onclick="setStaffDateRange(\'today\')">Today</button><button class="btn btn-sm btn-outline" onclick="setStaffDateRange(\'week\')">This Week</button><button class="btn btn-sm btn-outline" onclick="setStaffDateRange(\'month\')">This Month</button></div><div id="staff-summary"></div></div><div class="card" style="margin-bottom:1rem"><h3>ğŸ“Š Staff Productivity</h3><div id="staff-productivity"></div></div><div class="card"><h3>Today\'s Expenses</h3><div id="expenses-list"></div></div>':'')+'</main></div>'+(!isAdmin()&&state.modal==='force-clockout'?'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><h3>âš ï¸ Another Staff Clocked In</h3><p>'+((state.otherStaff?.user_name)||'Another staff member')+' is still clocked in. Please enter their machine card ending balance to clock them out:</p><div class="form-group"><label class="form-label">Machine Card End Balance ($)</label><input type="number" id="force-card-end" step="0.01" min="0" value="0"></div><div style="display:flex;gap:.5rem"><button class="btn btn-outline" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="forceClockOut()">Clock Them Out</button></div></div></div>':'');};;

const renderReports=()=>{const today=new Date().toISOString().slice(0,10);const weekAgo=new Date(Date.now()-7*24*60*60*1000).toISOString().slice(0,10);return'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header"><h1>'+t('reports')+'</h1></div><div class="card" style="margin-bottom:1rem"><div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:end"><div class="form-group" style="margin:0"><label class="form-label">Start Date</label><input type="date" id="report-start" value="'+(state.reportStartDate||weekAgo)+'" onchange="state.reportStartDate=this.value"></div><div class="form-group" style="margin:0"><label class="form-label">End Date</label><input type="date" id="report-end" value="'+(state.reportEndDate||today)+'" onchange="state.reportEndDate=this.value"></div><div class="form-group" style="margin:0"><label class="form-label">Compare To</label><select id="report-compare" onchange="state.reportCompare=this.value"><option value="prior_period">Prior Period</option><option value="prior_year">Same Period Last Year</option></select></div><button class="btn btn-primary" onclick="loadReportsWithDates()">ğŸ” Generate Report</button></div></div><div id="report-stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1rem"></div><div class="card" style="margin-bottom:1rem"><h3>ğŸ“ˆ Sales Trend</h3><canvas id="sales-chart" height="200"></canvas></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem"><div class="card"><h3>ğŸ’° Revenue Comparison</h3><canvas id="revenue-chart" height="180"></canvas></div><div class="card"><h3>ğŸ“¦ Orders Comparison</h3><canvas id="orders-chart" height="180"></canvas></div></div><div class="card"><h3>ğŸ† Top 10 Customers</h3><div id="top-customers"></div></div></main></div>';}

const renderServicesAdmin=()=>'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header" style="display:flex;justify-content:space-between;align-items:center"><h1>Services</h1><button class="btn btn-primary" onclick="state.modal=\'add-service\';render()">+ Add Service</button></div><div class="card" id="services-admin-list"></div></main></div>'+(state.modal==='add-service'?renderAddServiceModal():'');

const renderAddServiceModal=()=>'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-header"><h3>Add New Service</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><form onsubmit="addService(event)"><div class="form-group"><label class="form-label">Service Name *</label><input type="text" id="new-service-name" required placeholder="e.g. Carpet Cleaning - Small"></div><div class="form-group"><label class="form-label">Category *</label><select id="new-service-category" required><option value="Wash & Fold">Wash & Fold</option><option value="Dry Cleaning">Dry Cleaning</option><option value="Alterations">Alterations</option><option value="Specialty">Specialty</option><option value="Other">Other</option></select></div><div class="form-group"><label class="form-label">Price ($) *</label><input type="number" id="new-service-price" step="0.01" min="0" required placeholder="25.00"></div><div class="form-group"><label class="form-label">Unit</label><select id="new-service-unit"><option value="item">Per Item</option><option value="lb">Per Pound</option><option value="sqft">Per Sq Ft</option></select></div><div style="display:flex;gap:.5rem"><button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal()">Cancel</button><button type="submit" class="btn btn-success" style="flex:1">Add Service</button></div></form></div></div>';

const renderSettings=()=>'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header"><h1>'+t('settings')+'</h1></div><div class="card" style="margin-bottom:1rem"><h3>ğŸ“§ Notifications & Payment</h3><div class="form-group"><label class="form-label">Order Confirmation Email</label><input type="email" id="set-notification-email" placeholder="sales@kleenpanda.com"></div><div class="form-group"><label class="form-label">Zelle ID (Email or Phone)</label><input type="text" id="set-zelle-id" placeholder="info@kleenpanda.com"></div><div class="form-group"><label class="form-label">Tax Rate (%)</label><input type="number" id="set-tax-rate" step="0.001" min="0" max="100" placeholder="8.875"></div><button class="btn btn-primary" onclick="saveNotificationSettings()">Save Settings</button></div><div class="card" style="margin-bottom:1rem"><h3>Delivery Schedule</h3><div class="form-group"><label class="form-label">Delivery Days</label><input type="text" id="set-delivery-days" placeholder="Monday,Friday"></div><div class="form-row"><div class="form-group"><label class="form-label">Start</label><input type="time" id="set-pickup-start"></div><div class="form-group"><label class="form-label">End</label><input type="time" id="set-pickup-end"></div></div><button class="btn btn-primary" onclick="saveDeliverySettings()">Save Schedule</button></div><div class="card" style="margin-bottom:1rem"><h3>ğŸ–¨ï¸ Receipt Printer</h3><p style="color:var(--kp-gray);margin-bottom:1rem;font-size:.9rem">Configure your receipt printer. For <strong>Epson TM-T20II</strong>: Connect via USB and set as default printer in Windows/Mac.</p><div class="form-group"><label class="form-label">Printer Type</label><select id="set-printer-type"><option value="">Select printer...</option><option value="epson" '+(state.settings?.printer_type==='epson'?'selected':'')+'>Epson TM-T20II / TM Series</option><option value="star" '+(state.settings?.printer_type==='star'?'selected':'')+'>Star Micronics</option><option value="zebra" '+(state.settings?.printer_type==='zebra'?'selected':'')+'>Zebra</option><option value="brother" '+(state.settings?.printer_type==='brother'?'selected':'')+'>Brother</option><option value="other" '+(state.settings?.printer_type==='other'?'selected':'')+'>Other ESC/POS</option></select></div><div class="form-group"><label class="form-label">Connection Type</label><select id="set-printer-connection"><option value="usb" '+(state.settings?.printer_connection==='usb'?'selected':'')+'>USB (Recommended)</option><option value="network" '+(state.settings?.printer_connection==='network'?'selected':'')+'>Network (IP)</option><option value="bluetooth" '+(state.settings?.printer_connection==='bluetooth'?'selected':'')+'>Bluetooth</option></select></div><div class="form-group"><label class="form-label">Paper Width</label><select id="set-printer-width"><option value="80" '+(state.settings?.printer_width==='80'||!state.settings?.printer_width?'selected':'')+'>80mm (Standard - TM-T20II)</option><option value="58" '+(state.settings?.printer_width==='58'?'selected':'')+'>58mm (Narrow)</option></select></div><div class="form-group"><label style="display:flex;align-items:center;gap:.5rem;cursor:pointer"><input type="checkbox" id="set-auto-print" '+(state.settings?.auto_print==='true'?'checked':'')+' style="width:auto"> Auto-print receipt after each order</label></div><div style="display:flex;gap:.5rem"><button class="btn btn-primary" onclick="savePrinterSettings()">Save Printer Settings</button><button class="btn btn-outline" onclick="testPrint()">ğŸ–¨ï¸ Test Print</button></div><div id="printer-status" style="margin-top:.5rem"></div><div style="margin-top:1rem;padding:1rem;background:var(--kp-cream);border-radius:8px;font-size:.85rem"><strong>Setup Instructions for Epson TM-T20II:</strong><ol style="margin:.5rem 0 0 1.5rem;padding:0"><li>Connect printer via USB to your computer</li><li>Install <a href="https://epson.com/Support/Point-of-Sale/TM-Series/Epson-TM-T20II/s/SPT_C31CD52062" target="_blank" style="color:var(--kp-teal)">Epson drivers</a> if not auto-detected</li><li>Set as default printer in Windows/Mac settings</li><li>Click "Test Print" above to verify</li></ol></div></div><div class="card" style="margin-bottom:1rem"><h3>ğŸ’³ Clearent Payment Processing</h3><p style="color:var(--kp-gray);margin-bottom:1rem;font-size:.9rem">Process card payments via terminal swipe OR manual card entry. API Key is required for both.</p><div class="form-group"><label class="form-label">API Key <span style="color:var(--kp-green)">'+(state.settings?.clearent_api_key?'âœ“ Configured':'')+'</span></label><input type="password" id="set-clearent-api" placeholder="Your Clearent API Key"></div><div class="form-group"><label class="form-label">Terminal ID (optional - for physical terminal)</label><input type="text" id="set-clearent-terminal" placeholder="Terminal ID from Clearent"></div><button class="btn btn-primary" onclick="saveClearentSettings()">Save Clearent Settings</button><div id="clearent-status" style="margin-top:.5rem"></div></div><div class="card" style="margin-bottom:1rem"><h3>Users</h3><div id="users-list"></div><button class="btn btn-outline" style="margin-top:1rem" onclick="state.modal=\'add-user\';render()">+ Add</button></div><div class="card" style="border:2px solid var(--kp-red)"><h3 style="color:var(--kp-red)">âš ï¸ Danger Zone</h3><p style="color:var(--kp-gray);margin-bottom:1rem">These actions cannot be undone. Use with caution.</p><button class="btn btn-danger" onclick="deleteAllOrders()">ğŸ—‘ï¸ Delete All Orders</button></div></main></div>'+(state.modal==='add-user'?'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><h3>Add User</h3><form onsubmit="addUser(event)"><div class="form-group"><label class="form-label">Name</label><input type="text" id="new-user-name" required></div><div class="form-group"><label class="form-label">Username</label><input type="text" id="new-user-username" required></div><div class="form-group"><label class="form-label">Password</label><input type="text" id="new-user-password" required></div><div class="form-group"><label class="form-label">Role</label><select id="new-user-role"><option value="staff">Staff</option><option value="driver">Driver</option></select></div><button type="submit" class="btn btn-primary" style="width:100%">Add</button></form></div></div>':'')+(state.modal==='edit-user'&&state.editingUser?'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><h3>Edit '+state.editingUser.name+'</h3><form onsubmit="updateUser(event)"><div class="form-group"><label class="form-label">Name</label><input type="text" id="edit-user-name" value="'+state.editingUser.name+'" required></div><div class="form-group"><label class="form-label">Username</label><input type="text" id="edit-user-username" value="'+state.editingUser.username+'" required></div><div class="form-group"><label class="form-label">Password (blank=keep)</label><input type="text" id="edit-user-password"></div><div class="form-group"><label class="form-label">Role</label><select id="edit-user-role"><option value="staff" '+(state.editingUser.role==='staff'?'selected':'')+'>Staff</option><option value="driver" '+(state.editingUser.role==='driver'?'selected':'')+'>Driver</option><option value="admin" '+(state.editingUser.role==='admin'?'selected':'')+'>Admin</option></select></div><button type="submit" class="btn btn-primary" style="width:100%">Save</button></form></div></div>':'');

// AUTH
async function handleLogin(e){e.preventDefault();const id=document.getElementById('login-id').value.trim();const pw=document.getElementById('login-password').value;const digits=id.replace(/\D/g,'');const isPhone=digits.length>=10;const isEmail=id.includes('@');
console.log('Login attempt:', id, 'isPhone:', isPhone, 'isEmail:', isEmail);

if(isPhone||isEmail){
  // Customer login (phone or email)
  try{
    const d=await api('/public/customer-login',{method:'POST',body:{phone:isPhone?id:null,email:isEmail?id:null,password:pw}});
    state.customer=d.customer;state.customerToken=d.token;localStorage.setItem('customerToken',d.token);toast('Welcome!');navigate('my-orders');
  }catch(e){toast(e.message,'error');}
}else{
  // Staff login (username)
  try{
    const d=await api('/auth/login',{method:'POST',body:{username:id.toLowerCase(),password:pw}});
    state.token=d.token;state.user=d.user;localStorage.setItem('token',d.token);toast('Welcome!');navigate(d.user.role==='driver'?'driver':'pos');
  }catch(e){toast(e.message,'error');}
}}

async function handleRegister(e){e.preventDefault();const consent=document.getElementById('reg-sms-consent')?.checked||false;const plan=document.getElementById('reg-plan')?.value||'';const notifyPref=document.querySelector('input[name="notify-pref"]:checked')?.value||'sms';try{const d=await api('/public/customer-login',{method:'POST',body:{phone:document.getElementById('reg-phone').value,name:document.getElementById('reg-name').value,email:document.getElementById('reg-email').value||'',address:document.getElementById('reg-address').value||'',password:document.getElementById('reg-password').value,sms_consent:consent,subscription_plan:plan||null,notification_preference:notifyPref}});state.customer=d.customer;state.customerToken=d.token;localStorage.setItem('customerToken',d.token);toast('Account created!'+(plan?' Subscription: '+plan:''));navigate('my-orders');}catch(e){toast(e.message,'error');}}

// PASSWORD RESET
let resetPhone='';
async function requestPasswordReset(e){e.preventDefault();resetPhone=document.getElementById('reset-phone').value;try{const r=await fetch('/api/public/request-reset',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:resetPhone})});const d=await r.json();if(!r.ok)throw new Error(d.error);toast('Code sent to your phone!');state.modal='reset-code';render();}catch(e){toast(e.message,'error');}}

async function submitPasswordReset(e){e.preventDefault();const code=document.getElementById('reset-code').value;const newPw=document.getElementById('new-password').value;try{const r=await fetch('/api/public/reset-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:resetPhone,code:code,newPassword:newPw})});const d=await r.json();if(!r.ok)throw new Error(d.error);toast('Password updated! Please login.');closeModal();}catch(e){toast(e.message,'error');}}

// DATA
async function loadServices(){try{state.services=await api('/services');state.settings=await api('/settings');renderServicesList();renderPOSServices();renderServicesAdminList();}catch(e){}}
async function loadPOSData(){try{state.services=await api('/services');state.customers=await api('/customers');renderPOSServices();renderCart();}catch(e){}}
async function loadOrders(){try{state.orders=await api('/orders');renderOrdersTable();}catch(e){}}
async function loadCustomers(){try{state.customers=await api('/customers');renderCustomerList();}catch(e){}}
async function loadReports(){const today=new Date().toISOString().slice(0,10);const weekAgo=new Date(Date.now()-7*24*60*60*1000).toISOString().slice(0,10);state.reportStartDate=state.reportStartDate||weekAgo;state.reportEndDate=state.reportEndDate||today;state.reportCompare=state.reportCompare||'prior_period';try{const d=await api('/reports?start='+state.reportStartDate+'&end='+state.reportEndDate+'&compare='+state.reportCompare);renderReportStats(d);}catch(e){}}
async function loadReportsWithDates(){state.reportStartDate=document.getElementById('report-start')?.value;state.reportEndDate=document.getElementById('report-end')?.value;state.reportCompare=document.getElementById('report-compare')?.value||'prior_period';loadReports();}
async function loadStaffData(){try{const s=await api('/time-entries/status');state.clockedIn=s.clockedIn;state.otherStaff=s.otherStaffClockedIn;renderClockStatus(s);const cs=await api('/cash-drawer/status');renderCashStatus(cs);renderCashForm();if(isAdmin()){loadStaffSummary();loadStaffProductivity();renderExpensesList(cs.expenses||[]);}}catch(e){console.log(e);renderCashForm();}}
async function loadStaffSummary(){const startEl=document.getElementById('staff-date-start');const endEl=document.getElementById('staff-date-end');const start=startEl?.value||'';const end=endEl?.value||'';try{const sm=await api('/staff-summary?start='+start+'&end='+end);renderStaffSummary(sm);}catch(e){console.log(e);}}
async function loadStaffProductivity(){const startEl=document.getElementById('staff-date-start');const endEl=document.getElementById('staff-date-end');const start=startEl?.value||'';const end=endEl?.value||'';try{const p=await api('/staff-productivity?start='+start+'&end='+end);renderStaffProductivity(p);}catch(e){console.log(e);}}
function renderStaffProductivity(data){const el=document.getElementById('staff-productivity');if(!el)return;if(!data.productivity||data.productivity.length===0){el.innerHTML='<p style="color:var(--kp-gray)">No data for selected period</p>';return;}el.innerHTML='<table><thead><tr><th>Staff</th><th>Received</th><th>Cleaned</th><th>Ready</th><th>Pickups</th><th>Cash</th><th>Orders</th></tr></thead><tbody>'+data.productivity.map(p=>'<tr><td><strong>'+p.staff_name+'</strong></td><td>'+p.orders_received+'</td><td>'+p.orders_cleaned+'</td><td>'+p.orders_ready+'</td><td>'+p.pickups_processed+'</td><td>'+formatCurrency(p.cash_collected)+'</td><td style="font-size:.8rem;max-width:200px;overflow:hidden;text-overflow:ellipsis">'+(p.order_numbers||[]).slice(0,5).join(', ')+(p.order_numbers?.length>5?'...':'')+'</td></tr>').join('')+'</tbody></table>'+(data.timeEntries?.length?'<h4 style="margin-top:1rem">Time & Machine Card</h4><table><thead><tr><th>Staff</th><th>Shifts</th><th>Hours</th><th>Card Usage</th></tr></thead><tbody>'+data.timeEntries.map(t=>'<tr><td>'+t.user_name+'</td><td>'+t.shifts+'</td><td>'+parseFloat(t.total_hours||0).toFixed(1)+'h</td><td>'+formatCurrency(t.machine_card_usage||0)+'</td></tr>').join('')+'</tbody></table>':'');}
function setStaffDateRange(range){const today=new Date();const startEl=document.getElementById('staff-date-start');const endEl=document.getElementById('staff-date-end');if(!startEl||!endEl)return;endEl.value=today.toISOString().slice(0,10);if(range==='today'){startEl.value=today.toISOString().slice(0,10);}else if(range==='week'){const weekAgo=new Date(today);weekAgo.setDate(today.getDate()-7);startEl.value=weekAgo.toISOString().slice(0,10);}else if(range==='month'){const monthAgo=new Date(today);monthAgo.setMonth(today.getMonth()-1);startEl.value=monthAgo.toISOString().slice(0,10);}loadStaffSummary();loadStaffProductivity();}
async function loadCustomerOrders(){try{state.customerOrders=await api('/public/my-orders');renderCustomerOrdersList();}catch(e){renderCustomerOrdersList();}}
async function loadDriverOrders(){try{const o=await api('/driver/orders');renderDriverOrdersList(o);}catch(e){renderDriverOrdersList([]);}}
async function loadSettings(){try{state.settings=await api('/settings');renderPickupDates();}catch(e){}}
async function loadSettingsPage(){try{state.settings=await api('/settings');state.users=await api('/users');document.getElementById('set-notification-email').value=state.settings.notification_email||'sales@kleenpanda.com';document.getElementById('set-zelle-id').value=state.settings.zelle_id||'info@kleenpanda.com';document.getElementById('set-tax-rate').value=state.settings.tax_rate||'8.875';document.getElementById('set-delivery-days').value=state.settings.delivery_days||'Monday,Friday';document.getElementById('set-pickup-start').value=state.settings.pickup_time_start||'17:00';document.getElementById('set-pickup-end').value=state.settings.pickup_time_end||'21:00';if(document.getElementById('set-clearent-api'))document.getElementById('set-clearent-api').value=state.settings.clearent_api_key?'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢':'';if(document.getElementById('set-clearent-terminal'))document.getElementById('set-clearent-terminal').value=state.settings.clearent_terminal_id||'';checkClearentStatus();renderUsersList();}catch(e){}}

// RENDERS
function renderServicesList(){const el=document.getElementById('services-list');if(!el)return;const g={};state.services.filter(s=>s.active).forEach(s=>{if(!g[s.category])g[s.category]=[];g[s.category].push(s);});el.innerHTML=['Wash & Fold','Dry Cleaning','Press','Alterations'].filter(c=>g[c]).map(c=>'<div class="card"><h3 style="color:var(--kp-teal)">'+c+'</h3>'+g[c].map(s=>'<div style="display:flex;justify-content:space-between;padding:.4rem 0;border-bottom:1px solid var(--kp-light-gray)"><span>'+s.name+'</span><span style="font-weight:600;color:var(--kp-teal)">'+formatCurrency(s.price)+'</span></div>').join('')+'</div>').join('');}

function renderPOSServices(){const te=document.getElementById('category-tabs'),ge=document.getElementById('service-grid');if(!te||!ge)return;const active=state.services.filter(s=>s.active);const cats=['Wash & Fold','Dry Cleaning','Press','Alterations'].filter(c=>active.some(s=>s.category===c));te.innerHTML=cats.map(c=>'<button class="category-tab '+(state.activeCategory===c?'active':'')+'" onclick="state.activeCategory=\''+c+'\';renderPOSServices()">'+c+'</button>').join('');const f=active.filter(s=>s.category===state.activeCategory).sort((a,b)=>(a.sortOrder||99)-(b.sortOrder||99));
if(state.activeCategory==='Wash & Fold'){const subs=[{n:'Wash & Fold',f:s=>s.name.includes('Wash & Fold')},{n:'Blankets',f:s=>s.name.includes('Blanket')},{n:'Comforters',f:s=>s.name.includes('Comforter')},{n:'Pillows',f:s=>s.name.includes('Pillow')},{n:'Rugs',f:s=>s.name.includes('Rug')},{n:'Manhattan',f:s=>s.name.includes('Manhattan')}];ge.innerHTML=subs.map(sub=>{const items=f.filter(sub.f);if(!items.length)return'';return'<div style="margin-bottom:.75rem"><div class="subcat-header">'+sub.n+'</div><div class="service-grid">'+items.map(s=>'<button class="service-btn" onclick="addToCart('+s.id+')"><div style="font-weight:600">'+s.name.replace('Wash & Fold - ','').replace(sub.n+' - ','')+'</div><div style="color:var(--kp-teal);font-weight:700">'+formatCurrency(s.price)+'</div></button>').join('')+'</div></div>';}).join('');}
else{ge.innerHTML='<div class="service-grid" style="grid-template-columns:repeat(auto-fill,minmax(140px,1fr))">'+f.map(s=>'<button class="service-btn" onclick="addToCart('+s.id+')"><div style="font-weight:600">'+s.name+'</div><div style="color:var(--kp-teal);font-weight:700">'+formatCurrency(s.price)+'</div></button>').join('')+'</div>';}renderCart();}

function renderCart(){const ie=document.getElementById('cart-items'),te=document.getElementById('cart-totals'),ce=document.getElementById('customer-display');if(!ie||!te)return;if(ce)ce.innerHTML=state.selectedCustomer?'<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>'+state.selectedCustomer.name+'</strong><br><span style="color:var(--kp-gray)">'+(state.selectedCustomer.phone||'')+'</span></div><button class="btn btn-sm btn-outline" onclick="state.selectedCustomer=null;renderCart()">Ã—</button></div>':'<button class="btn btn-outline" style="width:100%" onclick="showCustomerModal()">ğŸ‘¤ Select Customer</button>';const disc=state.selectedCustomer?.discount||0;const adj=state.adjustment||0;const sub=state.cart.reduce((s,c)=>s+c.price*c.quantity,0);const discAmt=sub*(disc/100);const afterDisc=sub-discAmt+adj;const tax=afterDisc*0.08875;const tot=Math.max(0,afterDisc+tax);ie.innerHTML=state.cart.length===0?'<p style="text-align:center;color:var(--kp-gray)">Empty</p>':state.cart.map(c=>{const lb=c.unit==='lb';return'<div class="cart-item"><div style="flex:1"><div style="font-weight:500">'+c.name+'</div><div style="color:var(--kp-gray)">'+formatCurrency(c.price)+' Ã— '+c.quantity+'</div></div><div class="cart-item-qty">'+(lb?'<input type="number" step="0.1" min="0.1" value="'+c.quantity+'" style="width:100px;padding:.5rem;font-size:1.1rem;text-align:center" onchange="setCartQty('+c.id+',parseFloat(this.value)||0)">':'<button onclick="updateCartQty('+c.id+',-1)">âˆ’</button><span style="min-width:24px;text-align:center;font-size:1.1rem">'+c.quantity+'</span><button onclick="updateCartQty('+c.id+',1)">+</button>')+'<button onclick="removeFromCart('+c.id+')" style="background:var(--kp-red);color:#fff;margin-left:.5rem;padding:.5rem">Ã—</button></div></div>';}).join('');te.innerHTML='<div style="display:flex;justify-content:space-between"><span>Subtotal</span><span>'+formatCurrency(sub)+'</span></div>'+(disc>0?'<div style="display:flex;justify-content:space-between;color:var(--kp-green)"><span>Disc '+disc+'%</span><span>-'+formatCurrency(discAmt)+'</span></div>':'')+(adj!==0?'<div style="display:flex;justify-content:space-between"><span>Adj</span><span>'+formatCurrency(adj)+'</span></div>':'')+'<div style="display:flex;justify-content:space-between"><span>Tax</span><span>'+formatCurrency(tax)+'</span></div><div style="display:flex;justify-content:space-between;font-weight:700;font-size:1.2rem;color:var(--kp-teal)"><span>Total</span><span>'+formatCurrency(tot)+'</span></div>';renderPaymentButtons();}

function renderPaymentButtons(){const pe=document.getElementById('payment-buttons');if(!pe)return;pe.innerHTML=[['cash','ğŸ’µ Cash'],['card','ğŸ’³ Card'],['terminal','ğŸ”Œ Terminal'],['unpaid','â³ Unpaid']].map(([v,l])=>'<button class="btn btn-sm '+(state.paymentMethod===v?'btn-primary':'btn-outline')+'" onclick="setPayment(\''+v+'\')">'+l+'</button>').join('');}
function setPayment(m){state.paymentMethod=m;renderPaymentButtons();}

function renderOrdersTable(){const el=document.getElementById('orders-table');if(!el)return;el.innerHTML=state.orders.length===0?'<p>No orders</p>':'<table><thead><tr><th>Order</th><th>Customer</th><th>Status</th><th>Total</th><th></th></tr></thead><tbody>'+state.orders.map(o=>'<tr><td><strong style="color:var(--kp-teal)">'+o.order_number+'</strong><br><span style="font-size:.8rem;color:var(--kp-gray)">'+formatDate(o.created_at)+'</span></td><td>'+(o.customer_name||'Walk-in')+'</td><td><span class="badge badge-'+o.status+'">'+o.status+'</span></td><td>'+formatCurrency(o.total)+'</td><td><button class="btn btn-sm btn-outline" onclick="viewOrder('+o.id+')">View</button></td></tr>').join('')+'</tbody></table>';}

function renderCustomerList(){const el=document.getElementById('customers-list');if(!el)return;const s=state.customerSearch?.toLowerCase()||'';const f=state.customers.filter(c=>!s||c.name?.toLowerCase().includes(s)||c.phone?.includes(s));el.innerHTML=f.length===0?'<p>None</p>':'<table><thead><tr><th>'+t('name')+'</th><th>'+t('phone')+'</th><th>Plan</th><th></th></tr></thead><tbody>'+f.slice(0,50).map(c=>'<tr><td>'+c.name+'</td><td>'+formatPhone(c.phone)+'</td><td>'+(c.subscription_plan||'-')+'</td><td><button class="btn btn-sm btn-outline" onclick="editCustomerProfile('+c.id+')">'+t('edit')+'</button></td></tr>').join('')+'</tbody></table>';}

function renderClockStatus(s){const el=document.getElementById('clock-status');if(!el)return;if(s.clockedIn){el.innerHTML='<div style="padding:.75rem;border-radius:8px;text-align:center;margin:.75rem 0;background:#D1FAE5"><strong>âœ… Clocked In since '+new Date(s.entry?.clock_in).toLocaleTimeString()+'</strong></div><div class="form-group"><label class="form-label">Machine Card End Balance ($)</label><input type="number" id="clock-card-end" step="0.01" min="0" value="0"></div><div class="form-group"><label class="form-label">Shift Notes</label><textarea id="clock-shift-notes" rows="2" placeholder="Any notes about this shift..."></textarea></div><button class="btn btn-danger" style="width:100%" onclick="clockOut()">ğŸšª Clock Out</button>';}else{el.innerHTML='<div style="padding:.75rem;border-radius:8px;text-align:center;margin:.75rem 0;background:#FEE2E2"><strong>â° Not Clocked In</strong></div><div class="form-group"><label class="form-label">Machine Card Start Balance ($)</label><input type="number" id="clock-card-start" step="0.01" min="0" value="0"></div><button class="btn btn-success" style="width:100%" onclick="clockIn()">ğŸ Clock In</button>';}}

function renderCashStatus(cs){const el=document.getElementById('cash-status');if(!el)return;el.innerHTML='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.4rem;text-align:center;margin-bottom:1rem"><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px"><div style="font-size:.8rem;color:var(--kp-gray)">Opening</div><div style="font-weight:700">'+(cs.opening?formatCurrency(cs.opening.total):'--')+'</div></div><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px"><div style="font-size:.8rem;color:var(--kp-gray)">Cash Sales</div><div style="font-weight:700;color:var(--kp-green)">+'+formatCurrency(cs.cashSales)+'</div></div><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px"><div style="font-size:.8rem;color:var(--kp-gray)">Expenses</div><div style="font-weight:700;color:var(--kp-red)">-'+formatCurrency(cs.expenseTotal||0)+'</div></div><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px"><div style="font-size:.8rem;color:var(--kp-gray)">Expected</div><div style="font-weight:700">'+formatCurrency(cs.expectedCash)+'</div></div></div>'+(cs.hasMismatch?'<div style="background:#FEE2E2;color:var(--kp-red);padding:.5rem;border-radius:6px;text-align:center"><strong>âš ï¸ Mismatch: '+formatCurrency(cs.mismatch)+'</strong></div>':'');}

function renderStaffSummary(d){const el=document.getElementById('staff-summary');if(!el)return;if(d.staff.length===0){el.innerHTML='<p style="color:var(--kp-gray)">No data for selected period</p>';return;}const totHours=d.staff.reduce((s,x)=>s+parseFloat(x.hoursWorked||0),0);const totSales=d.staff.reduce((s,x)=>s+(x.sales||0),0);const totWeight=d.staff.reduce((s,x)=>s+(x.weight||0),0);const totOrders=d.staff.reduce((s,x)=>s+(x.ordersProcessed||0),0);el.innerHTML='<table><thead><tr><th>Staff</th><th>Hours</th><th>Sales</th><th>Weight (lbs)</th><th>Orders</th></tr></thead><tbody>'+d.staff.map(s=>'<tr><td>'+s.name+'</td><td>'+parseFloat(s.hoursWorked||0).toFixed(1)+'</td><td>'+formatCurrency(s.sales)+'</td><td>'+(s.weight||0).toFixed(1)+'</td><td>'+s.ordersProcessed+'</td></tr>').join('')+'</tbody><tfoot><tr style="background:var(--kp-cream);font-weight:700"><td>TOTAL</td><td>'+totHours.toFixed(1)+'</td><td>'+formatCurrency(totSales)+'</td><td>'+totWeight.toFixed(1)+'</td><td>'+totOrders+'</td></tr></tfoot></table>';}

function renderReportStats(d){
  const el=document.getElementById('report-stats'),ce=document.getElementById('top-customers');
  const pctChange=(curr,prev)=>{if(!prev)return{pct:0,cls:'',icon:''};const pct=((curr-prev)/prev*100).toFixed(0);const isUp=pct>=0;return{pct:Math.abs(pct),cls:isUp?'color:var(--kp-green)':'color:var(--kp-red)',icon:isUp?'â†‘':'â†“'};};
  const ordersChange=pctChange(d.totalOrders,d.priorOrders);
  const revenueChange=pctChange(d.totalRevenue,d.priorRevenue);
  const weightChange=pctChange(d.totalWeight,d.priorWeight);
  
  if(el)el.innerHTML='<div class="card"><div style="display:flex;justify-content:space-between;align-items:start"><div><div style="font-size:1.8rem;font-weight:700;color:var(--kp-teal)">'+d.totalOrders+'</div><div style="color:var(--kp-gray)">Orders</div></div>'+(d.priorOrders?'<div style="text-align:right;font-size:.85rem"><span style="'+ordersChange.cls+'">'+ordersChange.icon+ordersChange.pct+'%</span><div style="color:var(--kp-gray)">vs '+d.priorOrders+'</div></div>':'')+'</div></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:start"><div><div style="font-size:1.8rem;font-weight:700;color:var(--kp-teal)">'+formatCurrency(d.totalRevenue||0)+'</div><div style="color:var(--kp-gray)">Revenue</div></div>'+(d.priorRevenue?'<div style="text-align:right;font-size:.85rem"><span style="'+revenueChange.cls+'">'+revenueChange.icon+revenueChange.pct+'%</span><div style="color:var(--kp-gray)">vs '+formatCurrency(d.priorRevenue)+'</div></div>':'')+'</div></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:start"><div><div style="font-size:1.8rem;font-weight:700;color:var(--kp-teal)">'+(d.totalWeight||0).toFixed(1)+'</div><div style="color:var(--kp-gray)">lbs</div></div>'+(d.priorWeight?'<div style="text-align:right;font-size:.85rem"><span style="'+weightChange.cls+'">'+weightChange.icon+weightChange.pct+'%</span><div style="color:var(--kp-gray)">vs '+(d.priorWeight||0).toFixed(1)+'</div></div>':'')+'</div></div>';
  
  if(ce&&d.topCustomers)ce.innerHTML=d.topCustomers.length===0?'<p>No data</p>':'<table><thead><tr><th>Customer</th><th>Orders</th><th>Total</th></tr></thead><tbody>'+d.topCustomers.map(c=>'<tr><td>'+c.name+'</td><td>'+c.orders+'</td><td>'+formatCurrency(c.total)+'</td></tr>').join('')+'</tbody></table>';
  
  // Draw charts
  if(d.dailyData)renderSalesChart(d.dailyData,d.priorDailyData);
  if(d.totalRevenue!==undefined)renderComparisonCharts(d);
}

let salesChartInstance=null,revenueChartInstance=null,ordersChartInstance=null;

function renderSalesChart(data,priorData){
  const ctx=document.getElementById('sales-chart');
  if(!ctx)return;
  if(salesChartInstance)salesChartInstance.destroy();
  salesChartInstance=new Chart(ctx,{
    type:'line',
    data:{
      labels:data.map(d=>d.date),
      datasets:[
        {label:'Current Period',data:data.map(d=>d.revenue),borderColor:'#1B9AAA',backgroundColor:'rgba(27,154,170,0.1)',fill:true,tension:0.3},
        {label:'Prior Period',data:priorData?priorData.map(d=>d.revenue):[],borderColor:'#9CA3AF',backgroundColor:'transparent',borderDash:[5,5],tension:0.3}
      ]
    },
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'$'+v}}}}
  });
}

function renderComparisonCharts(d){
  const revCtx=document.getElementById('revenue-chart');
  const ordCtx=document.getElementById('orders-chart');
  
  if(revCtx){
    if(revenueChartInstance)revenueChartInstance.destroy();
    revenueChartInstance=new Chart(revCtx,{
      type:'bar',
      data:{labels:['Current','Prior'],datasets:[{data:[d.totalRevenue||0,d.priorRevenue||0],backgroundColor:['#1B9AAA','#9CA3AF']}]},
      options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'$'+v}}}}
    });
  }
  
  if(ordCtx){
    if(ordersChartInstance)ordersChartInstance.destroy();
    ordersChartInstance=new Chart(ordCtx,{
      type:'bar',
      data:{labels:['Current','Prior'],datasets:[{data:[d.totalOrders||0,d.priorOrders||0],backgroundColor:['#10B981','#9CA3AF']}]},
      options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  }
}

function renderServicesAdminList(){const el=document.getElementById('services-admin-list');if(!el)return;el.innerHTML=state.services.map(s=>'<div style="display:flex;align-items:center;gap:1rem;padding:.75rem;border-bottom:1px solid var(--kp-light-gray)"><div style="flex:1"><strong>'+s.name+'</strong><br><span style="color:var(--kp-gray)">'+s.category+'</span></div><div style="display:flex;align-items:center;gap:.5rem"><span style="font-size:1.1rem">$</span><input type="number" step="0.01" value="'+s.price.toFixed(2)+'" style="width:100px;padding:.5rem;font-size:1.1rem;text-align:right" onchange="updateServicePrice('+s.id+',this.value)"></div><label style="cursor:pointer;display:flex;align-items:center;gap:.5rem"><input type="checkbox" '+(s.active?'checked':'')+' onchange="toggleServiceActive('+s.id+',this.checked)" style="width:20px;height:20px"> <span>'+(s.active?'On':'Off')+'</span></label></div>').join('');}

function renderCustomerOrdersList(){const el=document.getElementById('customer-orders-list');if(!el)return;if(!state.customerOrders?.length){el.innerHTML='<div class="card" style="text-align:center"><p>'+t('noOrders')+'</p></div>';return;}const st=['received','cleaned','ready','delivered'];el.innerHTML=state.customerOrders.map(o=>{const ci=st.indexOf(o.status);const canEdit=ci<1;const pickupDate=o.notes?.match(/Pickup: (\d{4}-\d{2}-\d{2})/)?.[1];return'<div class="card" style="margin-bottom:1rem"><div style="display:flex;justify-content:space-between;align-items:start"><div><h3 style="color:var(--kp-teal)">'+o.order_number+'</h3><p style="color:var(--kp-gray);font-size:.85rem">Submitted: '+new Date(o.created_at).toLocaleDateString()+' '+new Date(o.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+'</p>'+(pickupDate?'<p style="color:var(--kp-gray);font-size:.85rem">Pickup: '+new Date(pickupDate).toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'})+'</p>':'')+'</div><span class="badge badge-'+o.status+'">'+o.status+'</span></div><div style="display:flex;justify-content:space-between;margin:1rem 0;background:var(--kp-cream);padding:.75rem;border-radius:8px">'+st.map((s,i)=>'<div style="text-align:center;flex:1"><div style="width:28px;height:28px;border-radius:50%;background:'+(i<=ci?'var(--kp-teal)':'var(--kp-light-gray)')+';color:'+(i<=ci?'#fff':'var(--kp-gray)')+';display:flex;align-items:center;justify-content:center;margin:0 auto;font-size:.75rem">'+(i<=ci?'âœ“':i+1)+'</div><div style="font-size:.75rem;margin-top:.25rem">'+s+'</div></div>').join('')+'</div>'+(o.notes?'<p style="font-size:.9rem;color:var(--kp-gray);margin-bottom:.5rem"><strong>Notes:</strong> '+o.notes+'</p>':'')+'<div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem"><p style="font-weight:600">Total: '+formatCurrency(o.total)+'</p>'+(canEdit?'<div style="display:flex;gap:.5rem"><button class="btn btn-sm btn-outline" onclick="editCustomerOrder('+o.id+')">âœï¸ Edit Notes</button><button class="btn btn-sm btn-danger" onclick="startCancelOrder('+o.id+')">Cancel</button></div>':'<span style="color:var(--kp-gray);font-size:.85rem">Order in progress</span>')+'</div></div>';}).join('');}

function editCustomerOrder(id){const o=state.customerOrders.find(x=>x.id===id);if(o){state.editingCustomerOrder=o;state.modal='edit-customer-order';render();}}
function startCancelOrder(id){const o=state.customerOrders.find(x=>x.id===id);if(o){state.cancellingOrder=o;state.modal='cancel-order';render();}}
async function saveCustomerOrderEdit(e){e.preventDefault();const notes=document.getElementById('cust-order-notes').value;try{await fetch('/api/public/orders/'+state.editingCustomerOrder.id,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.customerToken},body:JSON.stringify({notes})});toast('Order updated!');closeModal();loadCustomerOrders();}catch(e){toast('Error updating order','error');}}
async function confirmCancelOrder(id){try{await fetch('/api/public/orders/'+id+'/cancel',{method:'POST',headers:{'Authorization':'Bearer '+state.customerToken}});toast('Order cancelled');closeModal();loadCustomerOrders();}catch(e){toast('Error cancelling order','error');}}

function renderDriverOrdersList(orders){
const pickupsEl=document.getElementById('driver-pickups-list');
const deliveriesEl=document.getElementById('driver-deliveries-list');
if(!pickupsEl&&!deliveriesEl)return;
// Pickups: orders placed online that need to be picked up (received status, pickup_delivery type)
const pickups=orders.filter(o=>o.order_type==='pickup_delivery'&&(o.status==='received'||o.status==='collected'));
// Deliveries: orders that are ready to deliver
const deliveries=orders.filter(o=>o.status==='ready');
if(pickupsEl){pickupsEl.innerHTML=pickups.length===0?'<div class="card" style="text-align:center"><p>No pickups pending</p></div>':pickups.map(o=>'<div class="card" style="margin-bottom:1rem;border-left:4px solid var(--kp-teal)"><div style="display:flex;justify-content:space-between;align-items:center"><h3 style="color:var(--kp-teal)">'+o.order_number+'</h3><span class="badge badge-'+(o.status==='collected'?'collected':'received')+'">'+o.status+'</span></div><p>ğŸ‘¤ '+(o.customer_name||'Walk-in')+'</p><p>ğŸ“ <a href="tel:'+(o.customer_phone?.replace(/\D/g,'')||'')+'" style="color:var(--kp-teal)">'+formatPhone(o.customer_phone)+'</a></p><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px;margin:.5rem 0">ğŸ“ '+(o.customer_address||'No address')+'</div>'+(o.notes?'<p style="font-size:.9rem;color:var(--kp-gray)">'+o.notes+'</p>':'')+'<div style="display:flex;gap:.5rem"><a href="tel:'+(o.customer_phone?.replace(/\D/g,'')||'')+'" class="btn btn-outline btn-sm" style="flex:1">ğŸ“</a><a href="https://maps.google.com/?q='+encodeURIComponent(o.customer_address||'')+'" target="_blank" class="btn btn-outline btn-sm" style="flex:1">ğŸ—ºï¸</a>'+(o.status==='received'?'<button class="btn btn-primary btn-sm" style="flex:2" onclick="markCollected('+o.id+')">âœ“ '+t('collected')+'</button>':'<span class="badge badge-collected" style="flex:2;text-align:center">Collected</span>')+'</div></div>').join('');}
if(deliveriesEl){deliveriesEl.innerHTML=deliveries.length===0?'<div class="card" style="text-align:center"><p>No deliveries pending</p></div>':deliveries.map(o=>'<div class="card" style="margin-bottom:1rem;border-left:4px solid var(--kp-green)"><h3 style="color:var(--kp-green)">'+o.order_number+'</h3><p>ğŸ‘¤ '+(o.customer_name||'Walk-in')+'</p><p>ğŸ“ <a href="tel:'+(o.customer_phone?.replace(/\D/g,'')||'')+'" style="color:var(--kp-teal)">'+formatPhone(o.customer_phone)+'</a></p><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px;margin:.5rem 0">ğŸ“ '+(o.customer_address||'No address')+'</div>'+(o.delivery_photo?'<button class="btn btn-outline btn-sm" style="margin-bottom:.5rem" onclick="viewDeliveryPhoto(\''+o.delivery_photo+'\')">ğŸ“¸ View Photo</button>':'')+'<div style="display:flex;gap:.5rem"><a href="tel:'+(o.customer_phone?.replace(/\D/g,'')||'')+'" class="btn btn-outline btn-sm" style="flex:1">ğŸ“</a><a href="https://maps.google.com/?q='+encodeURIComponent(o.customer_address||'')+'" target="_blank" class="btn btn-outline btn-sm" style="flex:1">ğŸ—ºï¸</a><button class="btn btn-success btn-sm" style="flex:2" onclick="startDeliveryPhoto('+o.id+')">ğŸ“¸ '+t('delivered')+'</button></div></div>').join('');}
}
function viewDeliveryPhoto(photo){state.viewingPhoto=photo;state.modal='view-photo';render();}

// PAYMENT COLLECTION
function showPaymentModal(orderId,amount){
  state.paymentOrderId=orderId;
  state.paymentAmount=amount;
  state.collectPaymentMethod='cash';
  state.modal='payment';
  render();
}
function formatCardNumber(input){
  let v=input.value.replace(/\D/g,'').slice(0,16);
  input.value=v.replace(/(\d{4})(?=\d)/g,'$1 ');
}
function formatExpiry(input){
  let v=input.value.replace(/\D/g,'').slice(0,4);
  if(v.length>=2)v=v.slice(0,2)+'/'+v.slice(2);
  input.value=v;
}
async function processPayment(){
  if(!state.paymentOrderId)return;
  const method=state.collectPaymentMethod;
  
  // For card entry, charge via Clearent
  if(method==='card'){
    const cardNum=document.getElementById('pay-card-number')?.value;
    const expiry=document.getElementById('pay-card-expiry')?.value;
    const cvv=document.getElementById('pay-card-cvv')?.value;
    
    if(!cardNum||cardNum.replace(/\D/g,'').length<15){
      toast('Please enter a valid card number','error');
      return;
    }
    if(!expiry||expiry.replace(/\D/g,'').length!==4){
      toast('Please enter expiry date (MM/YY)','error');
      return;
    }
    if(!cvv||cvv.length<3){
      toast('Please enter CVV','error');
      return;
    }
    
    try{
      toast('Processing card...','info');
      const result=await api('/orders/'+state.paymentOrderId+'/charge-card',{
        method:'POST',
        body:{
          card_number:cardNum,
          exp_date:expiry,
          cvv:cvv,
          amount:state.paymentAmount,
          order_number:state.selectedOrder?.order_number||''
        }
      });
      toast('ğŸ’³ Payment approved! Card ending in '+result.last_four);
      state.modal=null;
      loadOrders();
      return;
    }catch(e){
      toast('Card declined: '+e.message,'error');
      return;
    }
  }
  
  // For terminal, try to process via Clearent terminal integration
  if(method==='terminal'){
    try{
      const paid=await processCardPayment(state.paymentOrderId,state.paymentAmount,state.selectedOrder?.order_number||'');
      if(!paid){
        toast('Terminal payment failed. Try another method.','error');
        return;
      }
    }catch(e){
      toast('Terminal error: '+e.message,'error');
      return;
    }
  }
  
  // For cash/zelle, just mark as paid
  try{
    await api('/orders/'+state.paymentOrderId+'/payment',{method:'PUT',body:{payment_status:'paid',payment_method:method}});
    toast('Payment recorded!');
    state.modal=null;
    loadOrders();
  }catch(e){toast(e.message,'error');}
}

function renderPickupDates(){const el=document.getElementById('pickup-dates');if(!el)return;const days=state.settings?.delivery_days?.split(',')||['Monday','Friday'];const dates=getNextDates(days,4);if(!state.selectedPickupDate&&dates.length)state.selectedPickupDate=dates[0].iso;el.innerHTML=dates.map(d=>'<div class="pickup-option '+(state.selectedPickupDate===d.iso?'selected':'')+'" onclick="selectPickupDate(\''+d.iso+'\')"><input type="radio" name="pickup-date" value="'+d.iso+'" '+(state.selectedPickupDate===d.iso?'checked':'')+'><div style="flex:1"><div style="font-size:1.2rem;font-weight:600">'+d.day+'</div><div style="color:var(--kp-gray)">'+d.display+'</div></div><div style="font-size:1.5rem">ğŸ“…</div></div>').join('');}
function selectPickupDate(iso){state.selectedPickupDate=iso;renderPickupDates();}
function selectCustomerPayment(method){state.customerPaymentMethod=method;const zelleInfo=document.getElementById('zelle-info');if(zelleInfo)zelleInfo.style.display=method==='zelle'?'block':'none';}

function renderUsersList(){const el=document.getElementById('users-list');if(!el)return;el.innerHTML=state.users.map(u=>'<div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem;border-bottom:1px solid var(--kp-light-gray)"><div><strong>'+u.name+'</strong> ('+u.username+')<br><span style="color:var(--kp-gray)">'+u.role+'</span></div><button class="btn btn-sm btn-outline" onclick="editUser('+u.id+')">Edit</button></div>').join('');}

// CART
function addToCart(id){
  const s=state.services.find(x=>x.id===id);
  if(!s)return;
  
  // Check for RUSH vs Regular mutual exclusivity
  const isRush = s.name.toLowerCase().includes('rush');
  const isRegular = s.name.toLowerCase().includes('regular') && s.name.toLowerCase().includes('wash');
  
  if (isRush || isRegular) {
    // Remove the opposite type from cart
    const hasRush = state.cart.some(c => c.name.toLowerCase().includes('rush') && c.name.toLowerCase().includes('wash'));
    const hasRegular = state.cart.some(c => c.name.toLowerCase().includes('regular') && c.name.toLowerCase().includes('wash'));
    
    if (isRush && hasRegular) {
      state.cart = state.cart.filter(c => !(c.name.toLowerCase().includes('regular') && c.name.toLowerCase().includes('wash')));
      toast('Switched from Regular to RUSH','info');
    }
    if (isRegular && hasRush) {
      state.cart = state.cart.filter(c => !(c.name.toLowerCase().includes('rush') && c.name.toLowerCase().includes('wash')));
      toast('Switched from RUSH to Regular','info');
    }
    
    // For RUSH orders, set minimum 10 lbs
    if (isRush) {
      const existing = state.cart.find(c => c.id === id);
      if (existing) {
        existing.quantity++;
      } else {
        state.cart.push({...s, quantity: 10}); // Start at minimum 10 lbs
        toast('RUSH minimum: 10 lbs ($21)','info');
      }
      renderCart();
      return;
    }
  }
  
  const e=state.cart.find(c=>c.id===id);
  if(e)e.quantity++;else state.cart.push({...s,quantity:1});
  renderCart();
}
function updateCartQty(id,d){const i=state.cart.find(c=>c.id===id);if(i){i.quantity+=d;if(i.quantity<=0)state.cart=state.cart.filter(c=>c.id!==id);}renderCart();}
function setCartQty(id,qty){const i=state.cart.find(c=>c.id===id);if(i){if(qty<=0)state.cart=state.cart.filter(c=>c.id!==id);else i.quantity=qty;}renderCart();}
function removeFromCart(id){state.cart=state.cart.filter(c=>c.id!==id);renderCart();}
function clearCart(){state.cart=[];state.selectedCustomer=null;state.adjustment=0;const el=document.getElementById('order-adjustment');if(el)el.value=0;renderCart();}
function addMinimumOrder(){const wf=state.services.find(s=>s.name==='Wash & Fold - Regular'&&s.active);if(wf){state.cart=[{...wf,quantity:10}];renderCart();toast('Minimum 10 lbs added');}else{toast('Service not found','error');}}

// DRIVER ACTIONS  
async function markCollected(id){try{await api('/orders/'+id+'/status',{method:'PUT',body:{status:'collected'}});toast('Marked as collected!');loadDriverOrders();}catch(e){toast(e.message,'error');}}

// CUSTOMER
function showCustomerModal(){state.modal='customer';render();}
function searchCustomer(q){const m=state.customers.filter(c=>c.phone?.replace(/\D/g,'').includes(q.replace(/\D/g,''))||c.name?.toLowerCase().includes(q.toLowerCase()));document.getElementById('search-results').innerHTML=m.length===0?'<p style="color:var(--kp-gray)">No match</p>':m.slice(0,5).map(c=>'<div style="padding:.5rem;border:1px solid var(--kp-light-gray);border-radius:6px;margin-bottom:.25rem;cursor:pointer" onclick="selectFoundCustomer('+c.id+')"><strong>'+c.name+'</strong> - '+c.phone+'</div>').join('');}
function selectFoundCustomer(id){const c=state.customers.find(x=>x.id===id);if(c){document.getElementById('cust-name').value=c.name||'';document.getElementById('cust-phone').value=c.phone||'';document.getElementById('cust-address').value=c.address||'';state.selectedCustomer=c;}}
async function saveCustomer(){const n=document.getElementById('cust-name').value,p=document.getElementById('cust-phone').value,a=document.getElementById('cust-address').value;if(!n||!p){toast('Name & phone required','error');return;}try{let c=state.customers.find(x=>x.phone?.replace(/\D/g,'')===p.replace(/\D/g,''));if(c)c=await api('/customers/'+c.id,{method:'PUT',body:{name:n,phone:p,address:a}});else{c=await api('/customers',{method:'POST',body:{name:n,phone:p,address:a}});state.customers.push(c);}state.selectedCustomer=c;closeModal();renderCart();toast('Saved!');}catch(e){toast(e.message,'error');}}
async function editCustomerProfile(id){const c=state.customers.find(x=>x.id===id);if(c){state.editingCustomer=c;state.modal='edit-customer';render();}}
async function updateCustomerProfile(e){
  e.preventDefault();
  const id=state.editingCustomer?.id;
  if(!id)return;
  const name=document.getElementById('edit-cust-name').value;
  const phone=document.getElementById('edit-cust-phone').value;
  const email=document.getElementById('edit-cust-email').value;
  const address=document.getElementById('edit-cust-address').value;
  const discount=parseFloat(document.getElementById('edit-cust-discount').value)||0;
  const subscription_plan=document.getElementById('edit-cust-plan')?.value||null;
  const card_last_four=document.getElementById('edit-cust-card')?.value||null;
  const zelle_id=document.getElementById('edit-cust-zelle')?.value||null;
  try{
    await api('/customers/'+id,{method:'PUT',body:{name,phone,email,address,discount,subscription_plan,card_last_four,zelle_id}});
    toast('Customer updated!');
    closeModal();
    loadCustomers();
  }catch(e){toast(e.message,'error');}
}
async function deleteCustomer(id){
  if(!confirm('Are you sure you want to delete this customer? This cannot be undone.'))return;
  try{
    await api('/customers/'+id,{method:'DELETE'});
    toast('Customer deleted!');
    closeModal();
    loadCustomers();
  }catch(e){toast(e.message,'error');}
}
function togglePasswordVisibility(inputId,btn){
  const input=document.getElementById(inputId);
  if(input.type==='password'){input.type='text';btn.textContent='ğŸ”’';}
  else{input.type='password';btn.textContent='ğŸ‘ï¸';}
}

// ORDERS
async function submitOrder(){
  // Validation
  if(!state.cart.length){toast('Cart is empty','error');return;}
  if(!state.selectedCustomer){toast('Please select or add a customer first','error');showCustomerModal();return;}
  if(!state.selectedCustomer.name||!state.selectedCustomer.phone){toast('Customer name and phone required','error');showCustomerModal();return;}
  if(!state.paymentMethod){toast('Select a payment method','error');return;}
  
  // Check RUSH minimum (10 lbs or $21)
  const rushItem = state.cart.find(c => c.name.toLowerCase().includes('rush') && c.name.toLowerCase().includes('wash'));
  if (rushItem && rushItem.quantity < 10) {
    toast('RUSH orders require minimum 10 lbs ($21)','error');
    return;
  }
  
  const w=state.cart.filter(c=>c.unit==='lb').reduce((s,c)=>s+c.quantity,0);
  const disc=state.selectedCustomer?.discount||0;
  const adj=state.adjustment||0;
  const sub=state.cart.reduce((s,c)=>s+c.price*c.quantity,0);
  const discAmt=sub*(disc/100);
  const afterDisc=sub-discAmt+adj;
  const tax=afterDisc*0.08875;
  const total=Math.max(0,afterDisc+tax);
  const orderType=state.orderType||'walk-in';
  
  try{
    const o=await api('/orders',{method:'POST',body:{customer_id:state.selectedCustomer?.id,customer_name:state.selectedCustomer?.name,customer_phone:state.selectedCustomer?.phone,customer_address:state.selectedCustomer?.address||'',order_type:orderType,items:state.cart.map(c=>({service_id:c.id,service_name:c.name,quantity:c.quantity,price:c.price})),payment_method:state.paymentMethod==='terminal'?'card':state.paymentMethod,weight:w,adjustment:state.adjustment,discount:state.selectedCustomer?.discount||0}});
    if(state.paymentMethod==='terminal'){const paid=await processCardPayment(o.id,total,o.order_number);if(!paid){toast('Order created but payment pending','error');}}
    else if(['cash','card'].includes(state.paymentMethod)){await api('/orders/'+o.id+'/payment',{method:'PUT',body:{payment_status:'paid',payment_method:state.paymentMethod}});}
    toast('Order '+o.order_number+' created!');
    // Print receipt if auto-print enabled or ask user
    if(state.settings?.auto_print==='true'){printReceiptWindow(o);}
    else if(confirm('Order created! Print receipt?')){printReceiptWindow(o);}
    clearCart();state.orderType='walk-in';
  }catch(e){toast(e.message,'error');}
}
function viewOrder(id){state.selectedOrder=state.orders.find(o=>o.id===id);state.modal='order-detail';render();}
function editOrder(id){state.editingOrder=JSON.parse(JSON.stringify(state.orders.find(o=>o.id===id)));state.modal='edit-order';render();}
function addEditItem(){
  const sel=document.getElementById('add-item-service');
  const qty=parseFloat(document.getElementById('add-item-qty').value)||1;
  if(!sel.value)return;
  const opt=sel.options[sel.selectedIndex];
  const newItem={service_id:parseInt(sel.value),service_name:opt.dataset.name,price:parseFloat(opt.dataset.price),quantity:qty};
  if(!state.editingOrder.items)state.editingOrder.items=[];
  const existing=state.editingOrder.items.find(i=>i.service_id===newItem.service_id);
  if(existing){existing.quantity+=qty;}else{state.editingOrder.items.push(newItem);}
  render();
}
function removeEditItem(idx){
  if(state.editingOrder?.items){state.editingOrder.items.splice(idx,1);render();}
}
async function saveOrderEdit(e){
  e.preventDefault();
  const o=state.editingOrder;
  if(!o)return;
  
  const orderType=document.getElementById('edit-order-type').value;
  const adjustment=parseFloat(document.getElementById('edit-adjustment').value)||0;
  const notes=document.getElementById('edit-notes').value;
  const paymentStatus=document.getElementById('edit-payment-status').value;
  
  // Update item quantities
  const items=(o.items||[]).map((item,i)=>{
    const qtyEl=document.getElementById('edit-item-qty-'+i);
    return {...item,quantity:parseFloat(qtyEl?.value)||item.quantity};
  }).filter(item=>item.quantity>0);
  
  try{
    await api('/orders/'+o.id,{method:'PUT',body:{adjustment,notes,items,payment_status:paymentStatus,order_type:orderType}});
    toast('Order updated!');
    closeModal();
    loadOrders();
  }catch(e){toast(e.message,'error');}
}
async function deleteOrder(id){
  if(!confirm('Are you sure you want to delete this order? This cannot be undone.'))return;
  try{
    await api('/orders/'+id,{method:'DELETE'});
    toast('Order deleted!');
    closeModal();
    loadOrders();
  }catch(e){toast(e.message,'error');}
}
async function deleteAllOrders(){
  if(!confirm('âš ï¸ WARNING: This will delete ALL orders permanently. Are you sure?'))return;
  if(!confirm('This action CANNOT be undone. Type "yes" to confirm... (Press Cancel to abort)'))return;
  try{
    await api('/orders',{method:'DELETE'});
    toast('All orders deleted!');
    loadOrders();
  }catch(e){toast(e.message,'error');}
}
async function updateOrderStatus(id,s){try{await api('/orders/'+id+'/status',{method:'PUT',body:{status:s}});toast('Updated!');state.selectedOrder.status=s;render();loadOrders();}catch(e){toast(e.message,'error');}}

// CUSTOMER ORDER
async function submitCustomerOrder(e){
  e.preventDefault();
  const addr=document.getElementById('order-address').value;
  const notes=document.getElementById('order-notes').value;
  
  // Validation
  if(!addr||addr.trim().length<5){toast('Please enter a valid address','error');return;}
  if(!state.selectedPickupDate){toast('Please select a pickup date','error');return;}
  
  // Get selected payment method
  const paymentMethod=state.customerPaymentMethod||'pay_later';
  
  try{
    await api('/public/orders',{method:'POST',body:{customer_name:state.customer.name,customer_phone:state.customer.phone,customer_email:state.customer.email,customer_address:addr,order_type:'pickup_delivery',payment_method:paymentMethod,items:[{service_id:1,service_name:'Wash & Fold',quantity:1,price:1.40}],notes:'Pickup: '+state.selectedPickupDate+'. Payment: '+paymentMethod+'. '+notes,weight:0}});
    toast('Pickup scheduled! We\'ll contact you soon.');
    navigate('my-orders');
  }catch(e){toast(e.message,'error');}
}

// DRIVER
function startDeliveryPhoto(id){state.photoOrderId=id;state.photoData=null;state.modal='photo';render();setTimeout(initCamera,100);}
async function initCamera(){const v=document.getElementById('camera-feed');if(!v)return;try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});v.srcObject=s;}catch(e){toast('Camera denied','error');closeModal();}}
function capturePhoto(){const v=document.getElementById('camera-feed'),c=document.getElementById('photo-canvas');if(!v||!c)return;c.width=v.videoWidth;c.height=v.videoHeight;c.getContext('2d').drawImage(v,0,0);state.photoData=c.toDataURL('image/jpeg',0.7);const s=v.srcObject;if(s)s.getTracks().forEach(t=>t.stop());render();}
function retakePhoto(){state.photoData=null;render();setTimeout(initCamera,100);}
async function confirmDelivery(){if(!state.photoData||!state.photoOrderId)return;try{await api('/orders/'+state.photoOrderId+'/deliver',{method:'POST',body:{photo:state.photoData}});toast('Delivered!');closeModal();loadDriverOrders();}catch(e){toast(e.message,'error');}}

// STAFF
async function clockIn(){
  const cardStart=parseFloat(document.getElementById('clock-card-start')?.value)||0;
  try{
    await api('/time-entries/clock-in',{method:'POST',body:{machine_card_start:cardStart}});
    toast('Clocked in!');
    loadStaffData();
  }catch(e){
    if(e.message.includes('still clocked in')){
      state.otherStaff={user_name:e.message.split(' is ')[0]};
      state.modal='force-clockout';
      render();
    }else{
      toast(e.message,'error');
    }
  }
}
async function clockOut(){
  const cardEnd=parseFloat(document.getElementById('clock-card-end')?.value)||0;
  const notes=document.getElementById('clock-shift-notes')?.value||'';
  try{
    await api('/time-entries/clock-out',{method:'POST',body:{machine_card_end:cardEnd,shift_notes:notes}});
    toast('Clocked out!');
    loadStaffData();
  }catch(e){toast(e.message,'error');}
}
async function forceClockOut(){
  const cardEnd=parseFloat(document.getElementById('force-card-end')?.value)||0;
  try{
    await api('/time-entries/force-clock-out',{method:'POST',body:{user_id:state.otherStaff?.user_id,machine_card_end:cardEnd}});
    toast('Previous staff clocked out!');
    closeModal();
    clockIn();
  }catch(e){toast(e.message,'error');}
}
let cashType='opening';
function showCashTab(type,el){cashType=type;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderCashForm();}
function renderCashForm(){const el=document.getElementById('cash-form-area');if(!el)return;if(cashType==='expense'){el.innerHTML='<div style="margin-top:1rem"><div class="form-group"><label class="form-label">Expense Amount</label><div style="display:flex;align-items:center;gap:.5rem"><span style="font-size:1.2rem">$</span><input type="number" id="expense-amount" step="0.01" min="0" value="0" style="width:120px;padding:.75rem;font-size:1.1rem"></div></div><div class="form-group"><label class="form-label">Description / Reason</label><input type="text" id="expense-desc" placeholder="e.g. Supplies, Inventory payment..." style="padding:.75rem"></div><div class="form-group"><label class="form-label">Notes</label><textarea id="expense-notes" rows="2" placeholder="Additional details..." style="padding:.75rem"></textarea></div><button class="btn btn-primary" onclick="submitExpense()">Submit Expense</button></div>';}else{el.innerHTML='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin-top:1rem">'+['100','50','20','10','5','1'].map(d=>'<div style="text-align:center"><label style="font-weight:600">$'+d+'</label><input type="number" id="cash-'+d+'" min="0" value="0" oninput="calculateCashTotal()" style="text-align:center;padding:.5rem;font-size:1.1rem"></div>').join('')+'<div style="text-align:center"><label style="font-weight:600">Coins</label><input type="number" id="cash-change" min="0" step="0.01" value="0" oninput="calculateCashTotal()" style="text-align:center;padding:.5rem;font-size:1.1rem"></div><div style="text-align:center"><label style="font-weight:600">Total</label><input type="text" id="cash-total" readonly value="$0.00" style="text-align:center;padding:.5rem;font-size:1.1rem;font-weight:700;background:var(--kp-cream)"></div></div><div class="form-group" style="margin-top:1rem"><label class="form-label">Shift Notes (optional)</label><textarea id="cash-notes" rows="2" placeholder="Notes about your shift..." style="padding:.75rem"></textarea></div><button class="btn btn-primary" style="margin-top:.5rem" onclick="submitCashCount()">Submit '+(cashType==='opening'?'Opening':'Closing')+' Count</button>';}}
function calculateCashTotal(){const t=(parseInt(document.getElementById('cash-100')?.value||0)*100)+(parseInt(document.getElementById('cash-50')?.value||0)*50)+(parseInt(document.getElementById('cash-20')?.value||0)*20)+(parseInt(document.getElementById('cash-10')?.value||0)*10)+(parseInt(document.getElementById('cash-5')?.value||0)*5)+(parseInt(document.getElementById('cash-1')?.value||0)*1)+parseFloat(document.getElementById('cash-change')?.value||0);document.getElementById('cash-total').value=formatCurrency(t);}
async function submitCashCount(){try{await api('/cash-drawer',{method:'POST',body:{type:cashType,hundreds:parseInt(document.getElementById('cash-100').value)||0,fifties:parseInt(document.getElementById('cash-50').value)||0,twenties:parseInt(document.getElementById('cash-20').value)||0,tens:parseInt(document.getElementById('cash-10').value)||0,fives:parseInt(document.getElementById('cash-5').value)||0,ones:parseInt(document.getElementById('cash-1').value)||0,change:parseFloat(document.getElementById('cash-change').value)||0,notes:document.getElementById('cash-notes')?.value||''}});toast('Submitted!');loadStaffData();}catch(e){toast(e.message,'error');}}
async function submitExpense(){const amt=parseFloat(document.getElementById('expense-amount').value)||0;const desc=document.getElementById('expense-desc').value;if(amt<=0){toast('Enter amount','error');return;}if(!desc){toast('Enter description','error');return;}try{await api('/cash-drawer',{method:'POST',body:{type:'expense',amount:amt,description:desc,notes:document.getElementById('expense-notes')?.value||''}});toast('Expense recorded!');document.getElementById('expense-amount').value='0';document.getElementById('expense-desc').value='';document.getElementById('expense-notes').value='';loadStaffData();}catch(e){toast(e.message,'error');}}
function renderExpensesList(expenses){const el=document.getElementById('expenses-list');if(!el)return;if(!expenses||!expenses.length){el.innerHTML='<p style="color:var(--kp-gray)">No expenses today</p>';return;}el.innerHTML='<table><thead><tr><th>Time</th><th>Amount</th><th>Description</th><th>By</th></tr></thead><tbody>'+expenses.map(e=>'<tr><td>'+new Date(e.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+'</td><td style="color:var(--kp-red)">-'+formatCurrency(e.amount)+'</td><td>'+e.description+(e.notes?' <span style="color:var(--kp-gray)">- '+e.notes+'</span>':'')+'</td><td>'+e.user+'</td></tr>').join('')+'</tbody></table>';}

// SERVICES
async function updateServicePrice(id,p){try{await api('/services/'+id,{method:'PUT',body:{price:parseFloat(p)}});toast('Updated!');}catch(e){toast(e.message,'error');}}
async function toggleServiceActive(id,a){try{await api('/services/'+id,{method:'PUT',body:{active:a?1:0}});loadServices();}catch(e){toast(e.message,'error');}}
async function addService(e){e.preventDefault();const name=document.getElementById('new-service-name').value;const category=document.getElementById('new-service-category').value;const price=parseFloat(document.getElementById('new-service-price').value);const unit=document.getElementById('new-service-unit').value;try{await api('/services',{method:'POST',body:{name,category,price,unit}});toast('Service added!');closeModal();loadServices();}catch(e){toast(e.message,'error');}}

// SETTINGS
async function saveNotificationSettings(){try{await api('/settings',{method:'PUT',body:{notification_email:document.getElementById('set-notification-email').value,zelle_id:document.getElementById('set-zelle-id').value,tax_rate:document.getElementById('set-tax-rate').value}});toast('Settings saved!');}catch(e){toast(e.message,'error');}}
async function saveDeliverySettings(){try{await api('/settings',{method:'PUT',body:{delivery_days:document.getElementById('set-delivery-days').value,pickup_time_start:document.getElementById('set-pickup-start').value,pickup_time_end:document.getElementById('set-pickup-end').value}});toast('Saved!');}catch(e){toast(e.message,'error');}}

// FEEDBACK
state.feedbackRating=0;
function setFeedbackRating(r){state.feedbackRating=r;const stars=document.querySelectorAll('#feedback-rating .rating-star');stars.forEach((s,i)=>{s.textContent=i<r?'â˜…':'â˜†';s.style.color=i<r?'#FFD700':'var(--kp-gray)';});}
async function submitFeedback(e){
  e.preventDefault();
  const name=document.getElementById('feedback-name').value;
  const email=document.getElementById('feedback-email').value;
  const phone=document.getElementById('feedback-phone').value;
  const message=document.getElementById('feedback-message').value;
  if(!message){toast('Please enter a message','error');return;}
  try{
    await fetch('/api/public/feedback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({customer_name:name,customer_email:email,customer_phone:phone,rating:state.feedbackRating,message})});
    toast('Thank you for your feedback!');
    closeModal();
    state.feedbackRating=0;
  }catch(e){toast('Failed to submit feedback','error');}
}

// CLEARENT TERMINAL
async function saveClearentSettings(){const apiKey=document.getElementById('set-clearent-api').value;const terminalId=document.getElementById('set-clearent-terminal').value;if(apiKey==='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'){toast('Enter new API key or leave unchanged','error');return;}try{await api('/settings',{method:'PUT',body:{clearent_api_key:apiKey,clearent_terminal_id:terminalId}});toast('Terminal settings saved!');checkClearentStatus();}catch(e){toast(e.message,'error');}}

async function savePrinterSettings(){
  const printerType=document.getElementById('set-printer-type').value;
  const printerConnection=document.getElementById('set-printer-connection').value;
  const printerWidth=document.getElementById('set-printer-width').value;
  const autoPrint=document.getElementById('set-auto-print').checked?'true':'false';
  try{
    await api('/settings',{method:'PUT',body:{printer_type:printerType,printer_connection:printerConnection,printer_width:printerWidth,auto_print:autoPrint}});
    state.settings.printer_type=printerType;
    state.settings.printer_connection=printerConnection;
    state.settings.printer_width=printerWidth;
    state.settings.auto_print=autoPrint;
    toast('Printer settings saved!');
    document.getElementById('printer-status').innerHTML='<span style="color:var(--kp-green)">âœ“ Settings saved</span>';
  }catch(e){toast(e.message,'error');}
}

async function testPrint(){
  const status=document.getElementById('printer-status');
  if(!state.settings?.printer_type){status.innerHTML='<span style="color:var(--kp-red)">Please select a printer type first</span>';return;}
  status.innerHTML='<span style="color:var(--kp-teal)">Sending test print...</span>';
  try{
    // Create test receipt
    const testOrder = {
      order_number: 'TEST-001',
      customer_name: 'Test Customer',
      customer_phone: '347-297-6088',
      created_at: new Date().toISOString(),
      items: [{service_name: 'Test Item', quantity: 1, price: 10.00}],
      total: 10.89,
      payment_status: 'unpaid',
      payment_method: null
    };
    printReceiptWindow(testOrder);
    status.innerHTML='<span style="color:var(--kp-green)">âœ“ Test print window opened</span>';
  }catch(e){
    status.innerHTML='<span style="color:var(--kp-red)">Print failed: '+e.message+'</span>';
    toast('Print failed: '+e.message,'error');
  }
}

function printReceipt(orderId){
  var order = state.orders.find(function(o){return o.id === orderId;});
  if(!order){toast('Order not found','error');return;}
  printReceiptWindow(order);
}

function printReceiptWindow(order){
  var items = order.items || [];
  var subtotal = items.reduce(function(s,i){return s + (i.price * i.quantity);}, 0);
  var tax = parseFloat(order.total) - subtotal;
  var date = new Date(order.created_at);
  var w = 48;
  var line = '================================================';
  var dash = '------------------------------------------------';
  
  function center(text){var pad = Math.max(0, Math.floor((w - text.length) / 2));return Array(pad+1).join(' ') + text;}
  function leftRight(left, right){var space = w - left.length - right.length;return left + Array(Math.max(1, space)+1).join(' ') + right;}
  
  var receipt = line + '\n' +
    center('KLEEN PANDA') + '\n' +
    center('Professional Laundry Service') + '\n' +
    line + '\n' +
    center('113 E Tremont Ave') + '\n' +
    center('Bronx, NY 10453') + '\n' +
    center('(347) 297-6088') + '\n' +
    center('info@kleenpanda.com') + '\n' +
    line + '\n\n' +
    leftRight('Order:', order.order_number) + '\n' +
    leftRight('Date:', date.toLocaleDateString()) + '\n' +
    leftRight('Time:', date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})) + '\n' +
    (order.customer_name ? leftRight('Customer:', order.customer_name) + '\n' : '') +
    (order.customer_phone ? leftRight('Phone:', formatPhone(order.customer_phone)) + '\n' : '') +
    '\n' + dash + '\nITEMS\n' + dash + '\n';

  items.forEach(function(item){
    var name = item.service_name.substring(0, 28);
    var qty = item.quantity.toString();
    var price = formatCurrency(item.price * item.quantity);
    receipt += leftRight(name, '') + '\n';
    receipt += leftRight('  ' + qty + ' x ' + formatCurrency(item.price), price) + '\n';
  });

  receipt += '\n' + dash + '\n' +
    leftRight('Subtotal:', formatCurrency(subtotal)) + '\n' +
    leftRight('Tax (8.875%):', formatCurrency(tax)) + '\n' +
    line + '\n' +
    leftRight('TOTAL:', formatCurrency(order.total)) + '\n' +
    line + '\n\n' +
    leftRight('Payment:', order.payment_status === 'paid' ? 'PAID' : 'UNPAID') + '\n' +
    (order.payment_method ? leftRight('Method:', order.payment_method.toUpperCase()) + '\n' : '') +
    '\n' + center('Thank you for choosing') + '\n' +
    center('Kleen Panda!') + '\n\n' +
    center('Questions? Call us at') + '\n' +
    center('(347) 297-6088') + '\n\n' + line;

  var printWindow = window.open('', '_blank', 'width=400,height=600');
  printWindow.document.write(
    '<!DOCTYPE html><html><head><title>Receipt - ' + order.order_number + '</title>' +
    '<style>@page{size:80mm auto;margin:0}body{font-family:Courier New,Courier,monospace;font-size:12px;line-height:1.2;margin:0;padding:5mm;width:80mm;box-sizing:border-box}pre{margin:0;white-space:pre-wrap;word-wrap:break-word}@media print{body{padding:0}}</style>' +
    '</head><body><pre>' + receipt + '</pre>' +
    '<script>window.onload=function(){window.print();setTimeout(function(){window.close();},500)};<\/script>' +
    '</body></html>'
  );
  printWindow.document.close();
}
async function checkClearentStatus(){try{const s=await api('/payments/clearent/status');const el=document.getElementById('clearent-status');if(el)el.innerHTML=s.configured?'<span style="color:var(--kp-green)">âœ… Terminal connected</span>':'<span style="color:var(--kp-red)">âš ï¸ Not configured</span>';}catch{}}
async function processCardPayment(orderId,amount,orderNumber){try{toast('Sending to terminal...');const r=await api('/payments/clearent',{method:'POST',body:{orderId,amount,orderNumber}});if(r.success){toast('Payment approved!');return true;}else{toast(r.error||'Payment declined','error');return false;}}catch(e){if(e.message.includes('not configured')){toast('Configure Clearent in Settings first','error');}else{toast(e.message||'Terminal error','error');}return false;}}

// USERS
function editUser(id){state.editingUser=state.users.find(u=>u.id===id);state.modal='edit-user';render();}
async function addUser(e){e.preventDefault();try{await api('/users',{method:'POST',body:{name:document.getElementById('new-user-name').value,username:document.getElementById('new-user-username').value,password:document.getElementById('new-user-password').value,role:document.getElementById('new-user-role').value}});toast('Added!');closeModal();loadSettingsPage();}catch(e){toast(e.message,'error');}}
async function updateUser(e){e.preventDefault();const b={name:document.getElementById('edit-user-name').value,username:document.getElementById('edit-user-username').value,role:document.getElementById('edit-user-role').value};const pw=document.getElementById('edit-user-password').value;if(pw)b.password=pw;try{await api('/users/'+state.editingUser.id,{method:'PUT',body:b});toast('Saved!');closeModal();loadSettingsPage();}catch(e){toast(e.message,'error');}}

// INIT
(async()=>{
const path=window.location.pathname.slice(1)||'home';
const validPages=['home','login','register','my-orders','place-order','driver','pos','orders','customers','staff','reports','services-admin','settings','contact'];
state.page=validPages.includes(path)?path:'home';
history.replaceState({page:state.page},'','/'+state.page);
if(state.token){try{state.user=await api('/auth/me');}catch{state.token=null;localStorage.removeItem('token');}}
if(state.customerToken){try{state.customer=await api('/public/customer-info');}catch{state.customerToken=null;localStorage.removeItem('customerToken');}}
render();
})();
</script>
</body>
</html>
