<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kleen Panda Laundromat</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--kp-teal:#1B9AAA;--kp-teal-dark:#158393;--kp-black:#1A1A1A;--kp-gray:#6B7280;--kp-light-gray:#E5E7EB;--kp-cream:#F8F9FA;--kp-green:#10B981;--kp-red:#EF4444;--kp-yellow:#FBBF24}
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Poppins',sans-serif;background:#fff;color:#2D2D2D;line-height:1.6;font-size:1rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1.5rem;font-weight:600;border-radius:8px;border:none;cursor:pointer;font-size:1rem;transition:all .2s}
    .btn-primary{background:var(--kp-teal);color:#fff}.btn-primary:hover{background:var(--kp-teal-dark)}
    .btn-secondary{background:var(--kp-black);color:#fff}.btn-success{background:var(--kp-green);color:#fff}.btn-danger{background:var(--kp-red);color:#fff}
    .btn-outline{background:transparent;border:2px solid var(--kp-teal);color:var(--kp-teal)}.btn-outline:hover{background:var(--kp-teal);color:#fff}
    .btn-sm{padding:.4rem .8rem;font-size:.9rem}.btn-lg{padding:1rem 2rem;font-size:1.2rem}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:1.25rem}
    input,select,textarea{width:100%;padding:.75rem;border:2px solid var(--kp-light-gray);border-radius:8px;font-family:inherit;font-size:1rem}
    input:focus,select:focus{outline:none;border-color:var(--kp-teal)}
    .form-group{margin-bottom:1rem}.form-label{display:block;font-weight:600;margin-bottom:.3rem}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .badge{display:inline-block;padding:.25rem .6rem;border-radius:20px;font-size:.8rem;font-weight:600;text-transform:uppercase}
    .badge-received{background:#DBEAFE;color:#1D4ED8}.badge-cleaned{background:#D1FAE5;color:#047857}.badge-ready{background:#FEF3C7;color:#D97706}.badge-delivered{background:#E0E7FF;color:#4338CA}.badge-collected{background:#DDD6FE;color:#7C3AED}
    .dashboard-layout{display:flex;min-height:100vh}
    .sidebar{width:220px;background:var(--kp-black);color:#fff;padding:1rem;display:flex;flex-direction:column}
    .sidebar-logo{display:flex;align-items:center;gap:.5rem;padding-bottom:1rem;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:1rem}
    .sidebar-logo img{height:32px}
    .sidebar-nav{flex:1}.sidebar-nav a{display:flex;align-items:center;gap:.5rem;padding:.6rem;color:rgba(255,255,255,.7);text-decoration:none;border-radius:8px;margin-bottom:.25rem;font-size:.95rem}
    .sidebar-nav a:hover,.sidebar-nav a.active{background:rgba(27,154,170,.2);color:#fff}.sidebar-nav a.active{background:var(--kp-teal)}
    .main-content{flex:1;padding:1.5rem;background:var(--kp-cream);overflow-y:auto}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
    .pos-layout{display:grid;grid-template-columns:1fr 400px;gap:1rem;height:calc(100vh - 60px);font-size:1.3rem}
    .category-tabs{display:flex;gap:.3rem;margin-bottom:.75rem;flex-wrap:wrap}
    .category-tab{padding:.5rem 1rem;background:#fff;border:2px solid var(--kp-light-gray);border-radius:20px;cursor:pointer;font-weight:500;font-size:1.1rem}
    .category-tab.active{background:var(--kp-teal);color:#fff;border-color:var(--kp-teal)}
    .service-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.5rem}
    .service-btn{padding:.5rem;background:#fff;border:2px solid var(--kp-light-gray);border-radius:8px;cursor:pointer;text-align:center;font-size:1rem}
    .service-btn:hover{border-color:var(--kp-teal)}
    .subcat-header{font-weight:600;color:#fff;background:var(--kp-teal);text-align:center;padding:.5rem;border-radius:6px;margin-bottom:.5rem;font-size:1rem}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:.5rem 0;border-bottom:1px solid var(--kp-light-gray);font-size:1rem}
    .cart-item-qty{display:flex;align-items:center;gap:.3rem}
    .cart-item-qty button{width:30px;height:30px;border-radius:4px;border:none;background:var(--kp-light-gray);cursor:pointer;font-weight:600;font-size:1.1rem}
    .customer-panel{background:var(--kp-cream);border-radius:8px;padding:.75rem;margin-bottom:.75rem}
    table{width:100%;border-collapse:collapse}th,td{padding:.6rem;text-align:left}
    th{background:var(--kp-black);color:#fff;font-weight:600;font-size:.8rem;text-transform:uppercase}
    tr:not(:last-child) td{border-bottom:1px solid var(--kp-light-gray)}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{background:#fff;border-radius:12px;padding:1.5rem;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--kp-gray)}
    .toast{position:fixed;top:1rem;right:1rem;background:var(--kp-black);color:#fff;padding:.75rem 1.25rem;border-radius:8px;z-index:9999}
    .top-header{position:sticky;top:0;z-index:100;background:#fff;padding:.75rem 0;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .stars{color:var(--kp-yellow);font-size:1.2rem}
    .how-it-works-step{text-align:center;padding:1.5rem}
    .how-it-works-step .step-icon{font-size:3rem;margin-bottom:1rem}
    .how-it-works-step h3{color:var(--kp-teal);margin-bottom:.5rem}
    .review-badge{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem 1rem;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .lang-toggle{display:flex;gap:.25rem;background:var(--kp-light-gray);border-radius:20px;padding:2px}
    .lang-toggle button{padding:.25rem .75rem;border:none;background:transparent;border-radius:18px;cursor:pointer;font-size:.85rem}
    .lang-toggle button.active{background:var(--kp-teal);color:#fff}
    .subscription-card{border:2px solid var(--kp-light-gray);border-radius:12px;padding:1.5rem;text-align:center;transition:all .2s}
    .subscription-card:hover{border-color:var(--kp-teal);transform:translateY(-4px)}
    .subscription-card.featured{border-color:var(--kp-teal);background:linear-gradient(135deg,#E0F7FA,#fff)}
    .subscription-card .price{font-size:2rem;font-weight:700;color:var(--kp-teal)}
    .toast.success{border-left:4px solid var(--kp-green)}.toast.error{border-left:4px solid var(--kp-red)}
    .tabs{display:flex;gap:.25rem;margin-bottom:1rem;border-bottom:2px solid var(--kp-light-gray)}
    .tab{padding:.6rem 1rem;cursor:pointer;font-weight:500;color:var(--kp-gray);border-bottom:2px solid transparent;margin-bottom:-2px}
    .tab.active{color:var(--kp-teal);border-color:var(--kp-teal)}
    .pickup-option{display:flex;align-items:center;gap:1rem;padding:1rem;border:3px solid var(--kp-light-gray);border-radius:12px;cursor:pointer;margin-bottom:.75rem}
    .pickup-option:hover,.pickup-option.selected{border-color:var(--kp-teal);background:rgba(27,154,170,.05)}
    .pickup-option input{width:auto}
    @media(max-width:1024px){.pos-layout{grid-template-columns:1fr;height:auto}}
    @media(max-width:768px){.dashboard-layout{flex-direction:column}.sidebar{width:100%}.form-row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div id="app"></div>
<script>
let state={page:'home',user:null,customer:null,customerOrders:[],token:localStorage.getItem('token'),customerToken:localStorage.getItem('customerToken'),services:[],customers:[],cart:[],orders:[],selectedCustomer:null,activeCategory:'Wash & Fold',modal:null,clockedIn:false,reportPeriod:'today',selectedOrder:null,paymentMethod:'cash',adjustment:0,editingCustomer:null,customerSearch:'',photoData:null,photoOrderId:null,users:[],settings:{},editingUser:null,selectedPickupDate:null,lang:localStorage.getItem('lang')||'en',smsConsent:false,customerPaymentMethod:'pay_later'};

// Translations
const T={
en:{welcome:'Welcome Back',login:'Sign In',register:'Create Account',phone:'Phone',password:'Password',name:'Name',email:'Email',address:'Address',newCustomer:'New? Register',schedulePickup:'Schedule Pickup',myOrders:'My Orders',logout:'Logout',home:'Home',pickupDate:'Pickup Date',notes:'Notes',payment:'Payment',confirmPickup:'Confirm Pickup',howItWorks:'How It Works',step1Title:'Schedule',step1Desc:'Pick a date & time that works for you',step2Title:'We Pick Up',step2Desc:'Our driver collects your laundry',step3Title:'We Clean',step3Desc:'Professional wash & fold service',step4Title:'We Deliver',step4Desc:'Fresh clothes back to your door',imagineTitle:'Imagine the things you can do with your time',smsConsent:'I want to receive text updates about promos and specials to the phone number provided. Message & Data rates may apply. Message frequency may vary. Text HELP for help and STOP to cancel.',washFold:'Wash & Fold',dryCleaning:'Dry Cleaning',pickups:'Pickups',deliveries:'Deliveries',collected:'Mark Collected',delivered:'Mark Delivered',getStarted:'Get Started',subscriptions:'Membership Plans',perLb:'/lb',perMonth:'/month',weekly:'Weekly Pickup',biweekly:'Bi-Weekly Pickup',noSubscription:'Pay As You Go',payAfterPickup:'Pay After Pickup',ourServices:'Our Services',familyTime:'Family Time',exercise:'Exercise',learning:'Learning',rest:'Rest',spendTime:'Spend more time with family, hobbies, and what matters most. Let us handle your laundry.',saveMoney:'Save money with our membership plans',priorityScheduling:'Priority scheduling',flexibleScheduling:'Flexible scheduling',onDemand:'On-demand pickup',payPerOrder:'Pay per order',noMinimum:'No minimum orders',subscribe:'Subscribe',creditCard:'Credit Card',paypal:'PayPal',zelle:'Zelle',payLater:'Pay After Service',back:'Back',yourOrders:'Your Orders',noOrders:'No orders yet!',hi:'Hi',placeOrder:'Place New Order',cardNumber:'Card Number',expiry:'Expiry',cvv:'CVV',paymentMethod:'Payment Method'},
es:{welcome:'Bienvenido',login:'Iniciar SesiÃ³n',register:'Crear Cuenta',phone:'TelÃ©fono',password:'ContraseÃ±a',name:'Nombre',email:'Correo',address:'DirecciÃ³n',newCustomer:'Â¿Nuevo? RegÃ­strate',schedulePickup:'Programar Recogida',myOrders:'Mis Pedidos',logout:'Salir',home:'Inicio',pickupDate:'Fecha de Recogida',notes:'Notas',payment:'Pago',confirmPickup:'Confirmar Recogida',howItWorks:'CÃ³mo Funciona',step1Title:'Programa',step1Desc:'Elige una fecha y hora que te convenga',step2Title:'Recogemos',step2Desc:'Nuestro conductor recoge tu ropa',step3Title:'Limpiamos',step3Desc:'Servicio profesional de lavado',step4Title:'Entregamos',step4Desc:'Ropa limpia a tu puerta',imagineTitle:'Imagina lo que puedes hacer con tu tiempo',smsConsent:'Quiero recibir actualizaciones de texto sobre promociones. Pueden aplicarse tarifas de mensajes y datos. La frecuencia puede variar. EnvÃ­a HELP para ayuda y STOP para cancelar.',washFold:'Lavar y Doblar',dryCleaning:'TintorerÃ­a',pickups:'Recogidas',deliveries:'Entregas',collected:'Marcar Recogido',delivered:'Marcar Entregado',getStarted:'Comenzar',subscriptions:'Planes de MembresÃ­a',perLb:'/lb',perMonth:'/mes',weekly:'Recogida Semanal',biweekly:'Recogida Quincenal',noSubscription:'Pago por Uso',payAfterPickup:'Pagar DespuÃ©s de Recogida',ourServices:'Nuestros Servicios',familyTime:'Tiempo en Familia',exercise:'Ejercicio',learning:'Aprendizaje',rest:'Descanso',spendTime:'Pasa mÃ¡s tiempo con tu familia, pasatiempos y lo que mÃ¡s importa. Nosotros nos encargamos de tu ropa.',saveMoney:'Ahorra dinero con nuestros planes de membresÃ­a',priorityScheduling:'ProgramaciÃ³n prioritaria',flexibleScheduling:'ProgramaciÃ³n flexible',onDemand:'Recogida a demanda',payPerOrder:'Pago por pedido',noMinimum:'Sin pedido mÃ­nimo',subscribe:'Suscribirse',creditCard:'Tarjeta de CrÃ©dito',paypal:'PayPal',zelle:'Zelle',payLater:'Pagar DespuÃ©s del Servicio',back:'Volver',yourOrders:'Tus Pedidos',noOrders:'Â¡AÃºn no hay pedidos!',hi:'Hola',placeOrder:'Hacer Nuevo Pedido',cardNumber:'NÃºmero de Tarjeta',expiry:'Vencimiento',cvv:'CVV',paymentMethod:'MÃ©todo de Pago'}
};
const t=k=>T[state.lang]?.[k]||T.en[k]||k;
const setLang=l=>{state.lang=l;localStorage.setItem('lang',l);render();};


const api=async(ep,opt={})=>{const h={'Content-Type':'application/json'};if(state.token)h['Authorization']='Bearer '+state.token;if(state.customerToken&&!state.token)h['Authorization']='Bearer '+state.customerToken;const r=await fetch('/api'+ep,{...opt,headers:h,body:opt.body?JSON.stringify(opt.body):undefined});if(!r.ok)throw new Error((await r.json().catch(()=>({}))).error||'Error');return r.json();};
const toast=(m,t='success')=>{const e=document.createElement('div');e.className='toast '+t;e.textContent=m;document.body.appendChild(e);setTimeout(()=>e.remove(),3000);};
const formatCurrency=a=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(a||0);
const formatDate=d=>d?new Date(d).toLocaleDateString():'N/A';
const isAdmin=()=>state.user?.role==='admin';
const isDriver=()=>state.user?.role==='driver';
const navigate=(p,pushHistory=true)=>{state.page=p;state.modal=null;if(pushHistory)history.pushState({page:p},'','/'+p);render();window.scrollTo(0,0);};
const logout=()=>{state.token=null;state.user=null;state.customer=null;state.customerToken=null;localStorage.removeItem('token');localStorage.removeItem('customerToken');navigate('home');};
const closeModal=()=>{state.modal=null;render();};

// Handle browser back/forward buttons
window.addEventListener('popstate',(e)=>{if(e.state?.page){state.page=e.state.page;state.modal=null;render();}else{state.page='home';render();}});

const render=()=>{
  const app=document.getElementById('app');
  if(state.user&&isDriver()&&state.page!=='driver')state.page='driver';
  if(['pos','orders','staff','reports','services-admin','customers','settings'].includes(state.page)&&(!state.user||isDriver()))state.page='login';
  if(['my-orders','place-order'].includes(state.page)&&!state.customer)state.page='login';
  switch(state.page){
    case'login':app.innerHTML=renderLogin();break;
    case'register':app.innerHTML=renderRegister();break;
    case'my-orders':app.innerHTML=renderMyOrders();loadCustomerOrders();break;
    case'place-order':app.innerHTML=renderPlaceOrder();loadSettings();break;
    case'driver':app.innerHTML=renderDriverView();loadDriverOrders();break;
    case'pos':app.innerHTML=renderPOS();loadPOSData();break;
    case'orders':app.innerHTML=renderOrders();loadOrders();break;
    case'customers':app.innerHTML=renderCustomers();loadCustomers();break;
    case'reports':app.innerHTML=renderReports();loadReports();break;
    case'staff':app.innerHTML=renderStaff();loadStaffData();break;
    case'services-admin':app.innerHTML=renderServicesAdmin();loadServices();break;
    case'settings':app.innerHTML=renderSettings();loadSettingsPage();break;
    case'contact':app.innerHTML=renderContact();break;
    default:app.innerHTML=renderHome();loadServices();
  }
};

function getNextDates(days,n){const dm={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};const dn=days.map(d=>dm[d.trim()]).filter(x=>x!==undefined);const r=[];const t=new Date();for(let i=1;i<=30&&r.length<n;i++){const d=new Date(t);d.setDate(t.getDate()+i);if(dn.includes(d.getDay()))r.push({day:d.toLocaleDateString('en-US',{weekday:'long'}),display:d.toLocaleDateString('en-US',{month:'long',day:'numeric'}),iso:d.toISOString().slice(0,10)});}return r;}

const renderHome=()=>'<header class="top-header"><div style="max-width:1200px;margin:0 auto;padding:0 1rem;display:flex;justify-content:space-between;align-items:center"><img src="/images/logo.png" style="height:45px;cursor:pointer" onclick="navigate(\'home\')"><nav style="display:flex;gap:.75rem;align-items:center"><div class="lang-toggle"><button class="'+(state.lang==='en'?'active':'')+'" onclick="setLang(\'en\')">EN</button><button class="'+(state.lang==='es'?'active':'')+'" onclick="setLang(\'es\')">ES</button></div>'+(state.customer?'<a href="#" onclick="navigate(\'my-orders\')" style="color:var(--kp-teal);font-weight:600">'+t('myOrders')+'</a><a href="#" onclick="logout()" class="btn btn-outline btn-sm">'+t('logout')+'</a>':state.user?'<span>'+state.user.name+'</span><a href="#" onclick="logout()" class="btn btn-outline btn-sm">'+t('logout')+'</a>':'<a href="#" onclick="navigate(\'login\')" class="btn btn-primary btn-sm">'+t('login')+'</a>')+'</nav></div></header>'+
'<section style="padding:3rem 0;background:linear-gradient(135deg,#E0F7FA 0%,#fff 100%)"><div style="max-width:1200px;margin:0 auto;padding:0 1rem;display:grid;grid-template-columns:1fr 1fr;gap:2rem;align-items:center"><div><h1 style="font-size:2.5rem;margin-bottom:1rem;color:var(--kp-black)">NYC Premier Laundry<br>Pick-Up & Delivery</h1><p style="color:var(--kp-gray);font-size:1.2rem;margin-bottom:1.5rem">Professional wash & fold. <strong style="color:var(--kp-teal)">Lowest price in NYC.</strong></p><div style="display:flex;gap:1rem;margin-bottom:1.5rem"><div class="review-badge"><span class="stars">â˜…â˜…â˜…â˜…â˜†</span><span><strong>4.4</strong> Yelp</span></div><div class="review-badge"><span class="stars">â˜…â˜…â˜…â˜…â˜†</span><span><strong>4.2</strong> Google</span></div></div>'+(state.customer?'<button onclick="navigate(\'place-order\')" class="btn btn-success btn-lg">ğŸ“¦ '+t('schedulePickup')+'</button>':'<a href="#" onclick="navigate(\'register\')" class="btn btn-primary btn-lg">'+t('getStarted')+'</a>')+'</div><div style="text-align:center"><img src="/images/logo.png" style="max-width:300px;opacity:.9"></div></div></section>'+
'<section style="padding:3rem 0"><div style="max-width:1200px;margin:0 auto;padding:0 1rem"><h2 style="text-align:center;margin-bottom:2rem;color:var(--kp-teal)">'+t('howItWorks')+'</h2><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem"><div class="how-it-works-step"><div class="step-icon">ğŸ“…</div><h3>'+t('step1Title')+'</h3><p style="color:var(--kp-gray)">'+t('step1Desc')+'</p></div><div class="how-it-works-step"><div class="step-icon">ğŸšš</div><h3>'+t('step2Title')+'</h3><p style="color:var(--kp-gray)">'+t('step2Desc')+'</p></div><div class="how-it-works-step"><div class="step-icon">âœ¨</div><h3>'+t('step3Title')+'</h3><p style="color:var(--kp-gray)">'+t('step3Desc')+'</p></div><div class="how-it-works-step"><div class="step-icon">ğŸ“¦</div><h3>'+t('step4Title')+'</h3><p style="color:var(--kp-gray)">'+t('step4Desc')+'</p></div></div></div></section>'+
'<section style="padding:3rem 0;background:var(--kp-cream)"><div style="max-width:1200px;margin:0 auto;padding:0 1rem"><h2 style="text-align:center;margin-bottom:.5rem">'+t('subscriptions')+'</h2><p style="text-align:center;color:var(--kp-gray);margin-bottom:2rem">'+t('saveMoney')+'</p><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem"><div class="subscription-card featured"><h3 style="color:var(--kp-teal)">'+t('weekly')+'</h3><div class="price">$1.20<span style="font-size:1rem;font-weight:400">'+t('perLb')+'</span></div><p style="color:var(--kp-gray);margin:1rem 0">$75'+t('perMonth')+'</p><ul style="text-align:left;list-style:none;margin:1rem 0"><li>âœ“ '+t('weekly')+'</li><li>âœ“ 7am-2pm / 5pm-9pm</li><li>âœ“ '+t('priorityScheduling')+'</li></ul><a href="#" onclick="navigate(\'register\')" class="btn btn-primary" style="width:100%">'+t('subscribe')+'</a></div><div class="subscription-card"><h3>'+t('biweekly')+'</h3><div class="price">$1.20<span style="font-size:1rem;font-weight:400">'+t('perLb')+'</span></div><p style="color:var(--kp-gray);margin:1rem 0">$100'+t('perMonth')+'</p><ul style="text-align:left;list-style:none;margin:1rem 0"><li>âœ“ '+t('biweekly')+'</li><li>âœ“ 7am-2pm / 5pm-9pm</li><li>âœ“ '+t('flexibleScheduling')+'</li></ul><a href="#" onclick="navigate(\'register\')" class="btn btn-outline" style="width:100%">'+t('subscribe')+'</a></div><div class="subscription-card"><h3>'+t('noSubscription')+'</h3><div class="price">$1.50<span style="font-size:1rem;font-weight:400">'+t('perLb')+'</span></div><p style="color:var(--kp-gray);margin:1rem 0">No commitment</p><ul style="text-align:left;list-style:none;margin:1rem 0"><li>âœ“ '+t('onDemand')+'</li><li>âœ“ '+t('payPerOrder')+'</li><li>âœ“ '+t('noMinimum')+'</li></ul><a href="#" onclick="navigate(\'register\')" class="btn btn-outline" style="width:100%">'+t('getStarted')+'</a></div></div></div></section>'+
'<section style="padding:3rem 0;background:linear-gradient(135deg,var(--kp-teal),var(--kp-teal-dark));color:#fff"><div style="max-width:900px;margin:0 auto;padding:0 1rem;text-align:center"><h2 style="font-size:2rem;margin-bottom:1rem">'+t('imagineTitle')+'</h2><p style="font-size:1.2rem;opacity:.9;margin-bottom:2rem">'+t('spendTime')+'</p><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem"><div style="padding:1rem"><span style="font-size:2.5rem">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span><p>'+t('familyTime')+'</p></div><div style="padding:1rem"><span style="font-size:2.5rem">ğŸ’ª</span><p>'+t('exercise')+'</p></div><div style="padding:1rem"><span style="font-size:2.5rem">ğŸ“š</span><p>'+t('learning')+'</p></div><div style="padding:1rem"><span style="font-size:2.5rem">ğŸ˜´</span><p>'+t('rest')+'</p></div></div></div></section>'+
'<section style="padding:2rem 0;background:var(--kp-cream)"><div style="max-width:1200px;margin:0 auto;padding:0 1rem"><h2 style="text-align:center;margin-bottom:1.5rem">'+t('ourServices')+'</h2><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;max-width:600px;margin:0 auto">'+(state.customer?'<button onclick="navigate(\'place-order\')" class="btn btn-primary btn-lg" style="padding:2rem">ğŸ§º '+t('washFold')+'</button><button onclick="navigate(\'place-order\')" class="btn btn-outline btn-lg" style="padding:2rem">ğŸ‘” '+t('dryCleaning')+'</button>':'<button onclick="navigate(\'register\')" class="btn btn-primary btn-lg" style="padding:2rem">ğŸ§º '+t('washFold')+'</button><button onclick="navigate(\'register\')" class="btn btn-outline btn-lg" style="padding:2rem">ğŸ‘” '+t('dryCleaning')+'</button>')+'</div></div></section>'+
'<footer style="background:var(--kp-black);color:#fff;padding:1.5rem 0;text-align:center"><p>ğŸ“ 113 E Tremont Ave, Bronx | ğŸ“ (347) 297-6088</p></footer>';

const renderLogin=()=>'<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--kp-cream)"><div class="card" style="width:100%;max-width:400px"><div style="text-align:center;margin-bottom:1.5rem"><div class="lang-toggle" style="justify-content:center;margin-bottom:1rem"><button class="'+(state.lang==='en'?'active':'')+'" onclick="setLang(\'en\')">EN</button><button class="'+(state.lang==='es'?'active':'')+'" onclick="setLang(\'es\')">ES</button></div><img src="/images/logo.png" style="height:60px"><p style="color:var(--kp-gray)">'+t('welcome')+'</p></div><form onsubmit="handleLogin(event)"><div class="form-group"><label class="form-label">'+t('phone')+' / Username</label><input type="text" id="login-id" required></div><div class="form-group"><label class="form-label">'+t('password')+'</label><input type="password" id="login-password" required></div><button type="submit" class="btn btn-primary" style="width:100%">'+t('login')+'</button><p style="text-align:center;margin-top:1rem"><a href="#" onclick="navigate(\'register\')" style="color:var(--kp-teal)">'+t('newCustomer')+'</a> | <a href="#" onclick="state.modal=\'forgot-password\';render()" style="color:var(--kp-gray)">Forgot Password?</a></p></form><a href="#" onclick="navigate(\'home\')" style="display:block;text-align:center;margin-top:1rem;color:var(--kp-gray)">â† '+t('home')+'</a></div></div>'+(state.modal==='forgot-password'?renderForgotPasswordModal():'')+(state.modal==='reset-code'?renderResetCodeModal():'');

const renderForgotPasswordModal=()=>'<div class="modal-overlay" onclick="closeModal()"><div class="modal" style="max-width:400px" onclick="event.stopPropagation()"><div class="modal-header"><h3>ğŸ”‘ Reset Password</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><p style="color:var(--kp-gray);margin-bottom:1rem">Enter your phone number and we\'ll send you a reset code via SMS.</p><form onsubmit="requestPasswordReset(event)"><div class="form-group"><label class="form-label">Phone Number</label><input type="tel" id="reset-phone" required placeholder="(555) 555-5555"></div><button type="submit" class="btn btn-primary" style="width:100%">Send Reset Code</button></form></div></div>';

const renderResetCodeModal=()=>'<div class="modal-overlay" onclick="closeModal()"><div class="modal" style="max-width:400px" onclick="event.stopPropagation()"><div class="modal-header"><h3>ğŸ”‘ Enter Code</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><p style="color:var(--kp-gray);margin-bottom:1rem">Enter the 6-digit code sent to your phone.</p><form onsubmit="submitPasswordReset(event)"><div class="form-group"><label class="form-label">Reset Code</label><input type="text" id="reset-code" required placeholder="123456" maxlength="6" style="text-align:center;font-size:1.5rem;letter-spacing:.5rem"></div><div class="form-group"><label class="form-label">New Password</label><input type="password" id="new-password" required minlength="4"></div><button type="submit" class="btn btn-success" style="width:100%">Reset Password</button></form></div></div>';

const renderRegister=()=>'<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--kp-cream);padding:1rem"><div class="card" style="width:100%;max-width:500px"><div style="text-align:center;margin-bottom:1.5rem"><div class="lang-toggle" style="justify-content:center;margin-bottom:1rem"><button class="'+(state.lang==='en'?'active':'')+'" onclick="setLang(\'en\')">EN</button><button class="'+(state.lang==='es'?'active':'')+'" onclick="setLang(\'es\')">ES</button></div><img src="/images/logo.png" style="height:60px"><h2 style="color:var(--kp-teal)">'+t('register')+'</h2></div><form onsubmit="handleRegister(event)"><div class="form-row"><div class="form-group"><label class="form-label">'+t('name')+' *</label><input type="text" id="reg-name" required></div><div class="form-group"><label class="form-label">'+t('phone')+' *</label><input type="tel" id="reg-phone" required></div></div><div class="form-group"><label class="form-label">'+t('email')+'</label><input type="email" id="reg-email"></div><div class="form-group"><label class="form-label">'+t('address')+'</label><input type="text" id="reg-address"></div><div class="form-group"><label class="form-label">'+t('password')+' *</label><input type="password" id="reg-password" required minlength="4"></div><div class="form-group" style="background:var(--kp-cream);padding:1rem;border-radius:8px"><label style="display:flex;gap:.75rem;cursor:pointer;align-items:flex-start"><input type="checkbox" id="reg-sms-consent" required style="width:auto;margin-top:4px"><span style="font-size:.85rem;color:var(--kp-gray)">'+t('smsConsent')+'</span></label></div><button type="submit" class="btn btn-primary" style="width:100%">'+t('register')+'</button></form><a href="#" onclick="navigate(\'login\')" style="display:block;text-align:center;margin-top:1rem;color:var(--kp-gray)">â† '+t('login')+'</a></div></div>';

const renderMyOrders=()=>'<header class="top-header"><div style="max-width:1200px;margin:0 auto;padding:0 1rem;display:flex;justify-content:space-between;align-items:center"><img src="/images/logo.png" style="height:40px;cursor:pointer" onclick="navigate(\'home\')"><div><a href="#" onclick="navigate(\'home\')" style="color:var(--kp-teal);margin-right:1rem">'+t('home')+'</a><a href="#" onclick="logout()" class="btn btn-outline btn-sm">'+t('logout')+'</a></div></div></header><section style="padding:2rem 0;min-height:80vh;background:var(--kp-cream)"><div style="max-width:800px;margin:0 auto;padding:0 1rem"><div style="text-align:center;margin-bottom:2rem"><h1 style="color:var(--kp-teal)">'+t('hi')+', '+(state.customer?.name||'')+' ğŸ‰</h1><button onclick="navigate(\'place-order\')" class="btn btn-success btn-lg" style="margin-top:1rem">ğŸ“¦ '+t('placeOrder')+'</button></div><h2 style="margin-bottom:1rem">'+t('yourOrders')+'</h2><div id="customer-orders-list"></div></div></section>';

const renderPlaceOrder=()=>'<header class="top-header"><div style="max-width:1200px;margin:0 auto;padding:0 1rem;display:flex;justify-content:space-between;align-items:center"><img src="/images/logo.png" style="height:40px"><div><a href="#" onclick="navigate(\'my-orders\')" style="color:var(--kp-teal);margin-right:1rem">â† '+t('back')+'</a><a href="#" onclick="logout()" class="btn btn-outline btn-sm">'+t('logout')+'</a></div></div></header><section style="padding:2rem 0;min-height:80vh;background:linear-gradient(135deg,var(--kp-cream),#e8f4f5)"><div style="max-width:550px;margin:0 auto;padding:0 1rem"><div style="text-align:center;margin-bottom:2rem"><div style="font-size:3rem">ğŸ“¦</div><h1 style="color:var(--kp-teal)">'+t('schedulePickup')+'</h1></div><div class="card" style="padding:2rem"><form onsubmit="submitCustomerOrder(event)"><div class="form-group"><label class="form-label" style="font-size:1.1rem">ğŸ“… '+t('pickupDate')+'</label><div id="pickup-dates"></div></div><div class="form-group"><label class="form-label" style="font-size:1.1rem">ğŸ“ '+t('address')+'</label><input type="text" id="order-address" required style="font-size:1.1rem;padding:1rem" placeholder="Enter your pickup address"></div><div class="form-group"><label class="form-label" style="font-size:1.1rem">ğŸ“ '+t('notes')+'</label><textarea id="order-notes" rows="2" placeholder="Gate code, instructions..."></textarea></div><div style="background:var(--kp-cream);padding:1.25rem;border-radius:12px;margin:1.5rem 0"><label class="form-label" style="font-size:1.1rem">ğŸ’³ '+t('paymentMethod')+'</label><div style="display:flex;flex-direction:column;gap:.5rem"><label class="pickup-option" onclick="state.customerPaymentMethod=\'credit_card\'"><input type="radio" name="payment-type" value="credit_card" style="width:auto"><div style="flex:1"><strong>ğŸ’³ '+t('creditCard')+'</strong></div></label><label class="pickup-option" onclick="state.customerPaymentMethod=\'paypal\'"><input type="radio" name="payment-type" value="paypal" style="width:auto"><div style="flex:1"><strong>ğŸ…¿ï¸ '+t('paypal')+'</strong></div></label><label class="pickup-option" onclick="state.customerPaymentMethod=\'zelle\'"><input type="radio" name="payment-type" value="zelle" style="width:auto"><div style="flex:1"><strong>ğŸ’¸ '+t('zelle')+'</strong></div></label><label class="pickup-option selected" onclick="state.customerPaymentMethod=\'pay_later\'"><input type="radio" name="payment-type" value="pay_later" checked style="width:auto"><div style="flex:1"><strong>â³ '+t('payLater')+'</strong><p style="font-size:.85rem;color:var(--kp-gray);margin:0">Pay after we weigh your laundry</p></div></label></div></div><button type="submit" class="btn btn-success" style="width:100%;padding:1.25rem;font-size:1.2rem">âœ“ '+t('confirmPickup')+'</button></form></div></div></section>';

const renderDriverView=()=>'<div style="min-height:100vh;background:var(--kp-cream)"><header style="background:var(--kp-black);padding:1rem;position:sticky;top:0;z-index:100"><div style="max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center"><div style="display:flex;align-items:center;gap:1rem"><img src="/images/logo.png" style="height:40px"><span style="color:#fff;font-weight:600">ğŸšš Driver: '+(state.user?.name||'')+'</span></div><button class="btn btn-sm btn-danger" onclick="logout()">'+t('logout')+'</button></div></header><main style="max-width:1000px;margin:0 auto;padding:1.5rem"><div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem"><div><h2 style="color:var(--kp-teal);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem">ğŸ“¦ '+t('pickups')+'</h2><div id="driver-pickups-list"></div></div><div><h2 style="color:var(--kp-green);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem">ğŸšš '+t('deliveries')+'</h2><div id="driver-deliveries-list"></div></div></div></main></div>'+(state.modal==='photo'?renderPhotoModal():'');

const renderPhotoModal=()=>'<div class="modal-overlay"><div class="modal" style="max-width:400px"><div class="modal-header"><h3>ğŸ“¸ Photo Proof</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>'+(state.photoData?'<img src="'+state.photoData+'" style="width:100%;border-radius:8px"><div style="display:flex;gap:.5rem;margin-top:1rem"><button class="btn btn-outline" style="flex:1" onclick="retakePhoto()">Retake</button><button class="btn btn-success" style="flex:1" onclick="confirmDelivery()">Confirm</button></div>':'<video id="camera-feed" autoplay playsinline style="width:100%;border-radius:8px"></video><canvas id="photo-canvas" style="display:none"></canvas><button class="btn btn-primary" style="width:100%;margin-top:1rem" onclick="capturePhoto()">ğŸ“¸ Take Photo</button>')+'</div></div>';

const renderContact=()=>'<div class="card" style="max-width:600px;margin:2rem auto;text-align:center"><h1>Contact Us</h1><p>ğŸ“§ info@kleenpanda.com</p><p>ğŸ“ Store: (347) 297-6088</p><p>ğŸ“ Manager: (347) 230-8400 ext.1 or 2</p><p>ğŸ“ 113 E Tremont Ave, Bronx, NY 10453</p><a href="#" onclick="navigate(\'home\')" style="color:var(--kp-teal)">â† Back</a></div>';

const renderSidebar=()=>'<aside class="sidebar"><div class="sidebar-logo"><img src="/images/icon.png"><strong>Kleen Panda</strong></div><nav class="sidebar-nav"><a href="#" class="'+(state.page==='pos'?'active':'')+'" onclick="navigate(\'pos\')">ğŸ›’ New Order</a><a href="#" class="'+(state.page==='orders'?'active':'')+'" onclick="navigate(\'orders\')">ğŸ“‹ Orders</a><a href="#" class="'+(state.page==='customers'?'active':'')+'" onclick="navigate(\'customers\')">ğŸ‘¥ Customers</a><a href="#" class="'+(state.page==='staff'?'active':'')+'" onclick="navigate(\'staff\')">ğŸ‘¤ Staff</a>'+(isAdmin()?'<a href="#" class="'+(state.page==='reports'?'active':'')+'" onclick="navigate(\'reports\')">ğŸ“Š Reports</a><a href="#" class="'+(state.page==='services-admin'?'active':'')+'" onclick="navigate(\'services-admin\')">âš™ï¸ Services</a><a href="#" class="'+(state.page==='settings'?'active':'')+'" onclick="navigate(\'settings\')">ğŸ”§ Settings</a>':'')+'</nav><div style="padding-top:.75rem;border-top:1px solid rgba(255,255,255,.1)"><strong>'+(state.user?.name||'')+'</strong><br><span style="opacity:.7">'+(state.user?.role||'')+'</span><button class="btn btn-danger btn-sm" style="width:100%;margin-top:.75rem" onclick="logout()">ğŸšª Logout</button></div></aside>';

const renderPOS=()=>'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="pos-layout"><div class="card" style="overflow-y:auto"><div class="category-tabs" id="category-tabs"></div><div id="service-grid"></div></div><div class="card" style="display:flex;flex-direction:column"><div class="customer-panel" id="customer-display"></div><h3>Cart</h3><div id="cart-items" style="flex:1;overflow-y:auto;max-height:180px"></div><button class="btn btn-outline btn-sm" style="margin:.5rem 0;width:100%" onclick="addMinimumOrder()">âš¡ Minimum ($15 / 10 lbs)</button><div style="margin:.5rem 0;display:flex;justify-content:space-between;align-items:center"><span>Adjustment</span><div style="display:flex;align-items:center;gap:.25rem">$<input type="number" step="0.01" id="order-adjustment" value="0" style="width:70px;text-align:right" onchange="state.adjustment=parseFloat(this.value)||0;renderCart()"></div></div><div id="cart-totals" style="border-top:2px solid var(--kp-teal);padding-top:.5rem"></div><div style="margin-top:.5rem"><div style="font-weight:600;margin-bottom:.4rem">Payment</div><div id="payment-buttons" style="display:grid;grid-template-columns:1fr 1fr;gap:.3rem"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-top:.75rem"><button class="btn btn-secondary" onclick="clearCart()">Clear</button><button class="btn btn-success" onclick="submitOrder()">âœ“ Complete</button></div></div></div></main></div>'+(state.modal==='customer'?renderCustomerModal():'');

const renderCustomerModal=()=>'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-header"><h3>Customer</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="form-group"><input type="text" placeholder="Search phone/name" oninput="searchCustomer(this.value)"></div><div id="search-results"></div><hr style="margin:1rem 0"><div class="form-row"><div class="form-group"><label class="form-label">Name *</label><input type="text" id="cust-name"></div><div class="form-group"><label class="form-label">Phone *</label><input type="tel" id="cust-phone"></div></div><div class="form-group"><label class="form-label">Address</label><input type="text" id="cust-address"></div><div style="display:flex;gap:.5rem"><button class="btn btn-outline" style="flex:1" onclick="closeModal()">Cancel</button><button class="btn btn-primary" style="flex:1" onclick="saveCustomer()">Save</button></div></div></div>';

const renderOrders=()=>'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header"><h1>Orders</h1></div><div class="card"><div id="orders-table"></div></div></main></div>'+(state.modal==='order-detail'?renderOrderModal():'');
const renderOrderModal=()=>{const o=state.selectedOrder;if(!o)return'';const st=['received','cleaned','ready','delivered'],ci=st.indexOf(o.status);return'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-header"><h3>'+o.order_number+'</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div style="display:flex;gap:.5rem;margin-bottom:1rem">'+st.map((s,i)=>'<button class="btn btn-sm '+(i<=ci?'btn-success':'btn-outline')+'" onclick="updateOrderStatus('+o.id+',\''+s+'\')">'+s+'</button>').join('')+'</div><p>Customer: '+(o.customer_name||'Walk-in')+' | Total: '+formatCurrency(o.total)+'</p><button class="btn btn-primary" onclick="closeModal()" style="margin-top:1rem">Close</button></div></div>';};

const renderCustomers=()=>'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header"><h1>Customers</h1></div><div class="card" style="margin-bottom:1rem"><input type="text" placeholder="ğŸ” Search..." oninput="state.customerSearch=this.value;renderCustomerList()"></div><div class="card"><div id="customers-list"></div></div></main></div>';

const renderStaff=()=>{const today=new Date().toISOString().slice(0,10);const weekAgo=new Date(Date.now()-7*24*60*60*1000).toISOString().slice(0,10);return'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header"><h1>Staff</h1></div><div class="card" style="margin-bottom:1rem"><h3>Time Clock</h3><div id="clock-status"></div></div><div class="card" style="margin-bottom:1rem"><h3>Cash Drawer</h3><div id="cash-status"></div><div class="tabs"><div class="tab active" onclick="showCashTab(\'opening\',this)">Opening</div><div class="tab" onclick="showCashTab(\'closing\',this)">Closing</div><div class="tab" onclick="showCashTab(\'expense\',this)">Expense</div></div><div id="cash-form-area"></div></div>'+(isAdmin()?'<div class="card" style="margin-bottom:1rem"><h3>Staff Summary</h3><div style="display:flex;gap:1rem;align-items:flex-end;margin-bottom:1rem;flex-wrap:wrap"><div class="form-group" style="margin:0"><label class="form-label">From</label><input type="date" id="staff-date-start" value="'+weekAgo+'"></div><div class="form-group" style="margin:0"><label class="form-label">To</label><input type="date" id="staff-date-end" value="'+today+'"></div><button class="btn btn-primary" onclick="loadStaffSummary()">ğŸ” Search</button><button class="btn btn-sm btn-outline" onclick="setStaffDateRange(\'today\')">Today</button><button class="btn btn-sm btn-outline" onclick="setStaffDateRange(\'week\')">This Week</button><button class="btn btn-sm btn-outline" onclick="setStaffDateRange(\'month\')">This Month</button></div><div id="staff-summary"></div></div><div class="card"><h3>Today\'s Expenses</h3><div id="expenses-list"></div></div>':'')+'</main></div>';};;

const renderReports=()=>'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header"><h1>Reports</h1></div><div id="report-stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1rem"></div><div class="card"><h3>Top Customers</h3><div id="top-customers"></div></div></main></div>';

const renderServicesAdmin=()=>'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header"><h1>Services</h1></div><div class="card" id="services-admin-list"></div></main></div>';

const renderSettings=()=>'<div class="dashboard-layout">'+renderSidebar()+'<main class="main-content"><div class="page-header"><h1>Settings</h1></div><div class="card" style="margin-bottom:1rem"><h3>Delivery Schedule</h3><div class="form-group"><label class="form-label">Delivery Days</label><input type="text" id="set-delivery-days" placeholder="Monday,Friday"></div><div class="form-row"><div class="form-group"><label class="form-label">Start</label><input type="time" id="set-pickup-start"></div><div class="form-group"><label class="form-label">End</label><input type="time" id="set-pickup-end"></div></div><button class="btn btn-primary" onclick="saveDeliverySettings()">Save Schedule</button></div><div class="card" style="margin-bottom:1rem"><h3>ğŸ’³ Clearent Card Terminal</h3><p style="color:var(--kp-gray);margin-bottom:1rem;font-size:.9rem">Connect your Clearent terminal to process card payments directly from POS.</p><div class="form-group"><label class="form-label">API Key</label><input type="password" id="set-clearent-api" placeholder="Your Clearent API Key"></div><div class="form-group"><label class="form-label">Terminal ID</label><input type="text" id="set-clearent-terminal" placeholder="Terminal ID from Clearent"></div><button class="btn btn-primary" onclick="saveClearentSettings()">Save Terminal Settings</button><div id="clearent-status" style="margin-top:.5rem"></div></div><div class="card"><h3>Users</h3><div id="users-list"></div><button class="btn btn-outline" style="margin-top:1rem" onclick="state.modal=\'add-user\';render()">+ Add</button></div></main></div>'+(state.modal==='add-user'?'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><h3>Add User</h3><form onsubmit="addUser(event)"><div class="form-group"><label class="form-label">Name</label><input type="text" id="new-user-name" required></div><div class="form-group"><label class="form-label">Username</label><input type="text" id="new-user-username" required></div><div class="form-group"><label class="form-label">Password</label><input type="text" id="new-user-password" required></div><div class="form-group"><label class="form-label">Role</label><select id="new-user-role"><option value="staff">Staff</option><option value="driver">Driver</option></select></div><button type="submit" class="btn btn-primary" style="width:100%">Add</button></form></div></div>':'')+(state.modal==='edit-user'&&state.editingUser?'<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><h3>Edit '+state.editingUser.name+'</h3><form onsubmit="updateUser(event)"><div class="form-group"><label class="form-label">Name</label><input type="text" id="edit-user-name" value="'+state.editingUser.name+'" required></div><div class="form-group"><label class="form-label">Username</label><input type="text" id="edit-user-username" value="'+state.editingUser.username+'" required></div><div class="form-group"><label class="form-label">Password (blank=keep)</label><input type="text" id="edit-user-password"></div><div class="form-group"><label class="form-label">Role</label><select id="edit-user-role"><option value="staff" '+(state.editingUser.role==='staff'?'selected':'')+'>Staff</option><option value="driver" '+(state.editingUser.role==='driver'?'selected':'')+'>Driver</option><option value="admin" '+(state.editingUser.role==='admin'?'selected':'')+'>Admin</option></select></div><button type="submit" class="btn btn-primary" style="width:100%">Save</button></form></div></div>':'');

// AUTH
async function handleLogin(e){e.preventDefault();const id=document.getElementById('login-id').value.trim();const pw=document.getElementById('login-password').value;const isPhone=/^[\d\s\-\(\)]+$/.test(id)&&id.replace(/\D/g,'').length>=10;
if(isPhone){try{const d=await api('/public/customer-login',{method:'POST',body:{phone:id,password:pw}});state.customer=d.customer;state.customerToken=d.token;localStorage.setItem('customerToken',d.token);toast('Welcome!');navigate('my-orders');}catch(e){toast(e.message,'error');}}
else{try{const d=await api('/auth/login',{method:'POST',body:{username:id.toLowerCase(),password:pw}});state.token=d.token;state.user=d.user;localStorage.setItem('token',d.token);toast('Welcome!');navigate(d.user.role==='driver'?'driver':'pos');}catch(e){toast(e.message,'error');}}}

async function handleRegister(e){e.preventDefault();const consent=document.getElementById('reg-sms-consent')?.checked||false;try{const d=await api('/public/customer-login',{method:'POST',body:{phone:document.getElementById('reg-phone').value,name:document.getElementById('reg-name').value,email:document.getElementById('reg-email').value||'',address:document.getElementById('reg-address').value||'',password:document.getElementById('reg-password').value,sms_consent:consent}});state.customer=d.customer;state.customerToken=d.token;localStorage.setItem('customerToken',d.token);toast('Account created!');navigate('my-orders');}catch(e){toast(e.message,'error');}}

// PASSWORD RESET
let resetPhone='';
async function requestPasswordReset(e){e.preventDefault();resetPhone=document.getElementById('reset-phone').value;try{const r=await fetch('/api/public/request-reset',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:resetPhone})});const d=await r.json();if(!r.ok)throw new Error(d.error);toast('Code sent to your phone!');state.modal='reset-code';render();}catch(e){toast(e.message,'error');}}

async function submitPasswordReset(e){e.preventDefault();const code=document.getElementById('reset-code').value;const newPw=document.getElementById('new-password').value;try{const r=await fetch('/api/public/reset-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:resetPhone,code:code,newPassword:newPw})});const d=await r.json();if(!r.ok)throw new Error(d.error);toast('Password updated! Please login.');closeModal();}catch(e){toast(e.message,'error');}}

// DATA
async function loadServices(){try{state.services=await api('/services');state.settings=await api('/settings');renderServicesList();renderPOSServices();renderServicesAdminList();}catch(e){}}
async function loadPOSData(){try{state.services=await api('/services');state.customers=await api('/customers');renderPOSServices();renderCart();}catch(e){}}
async function loadOrders(){try{state.orders=await api('/orders');renderOrdersTable();}catch(e){}}
async function loadCustomers(){try{state.customers=await api('/customers');renderCustomerList();}catch(e){}}
async function loadReports(){try{const d=await api('/reports?period='+state.reportPeriod);renderReportStats(d);}catch(e){}}
async function loadStaffData(){try{const s=await api('/time-entries/status');state.clockedIn=s.clockedIn;renderClockStatus(s);const cs=await api('/cash-drawer/status');renderCashStatus(cs);renderCashForm();if(isAdmin()){loadStaffSummary();renderExpensesList(cs.expenses||[]);}}catch(e){console.log(e);renderCashForm();}}
async function loadStaffSummary(){const startEl=document.getElementById('staff-date-start');const endEl=document.getElementById('staff-date-end');const start=startEl?.value||'';const end=endEl?.value||'';try{const sm=await api('/staff-summary?start='+start+'&end='+end);renderStaffSummary(sm);}catch(e){console.log(e);}}
function setStaffDateRange(range){const today=new Date();const startEl=document.getElementById('staff-date-start');const endEl=document.getElementById('staff-date-end');if(!startEl||!endEl)return;endEl.value=today.toISOString().slice(0,10);if(range==='today'){startEl.value=today.toISOString().slice(0,10);}else if(range==='week'){const weekAgo=new Date(today);weekAgo.setDate(today.getDate()-7);startEl.value=weekAgo.toISOString().slice(0,10);}else if(range==='month'){const monthAgo=new Date(today);monthAgo.setMonth(today.getMonth()-1);startEl.value=monthAgo.toISOString().slice(0,10);}loadStaffSummary();}
async function loadCustomerOrders(){try{state.customerOrders=await api('/public/my-orders');renderCustomerOrdersList();}catch(e){renderCustomerOrdersList();}}
async function loadDriverOrders(){try{const o=await api('/driver/orders');renderDriverOrdersList(o);}catch(e){renderDriverOrdersList([]);}}
async function loadSettings(){try{state.settings=await api('/settings');renderPickupDates();}catch(e){}}
async function loadSettingsPage(){try{state.settings=await api('/settings');state.users=await api('/users');document.getElementById('set-delivery-days').value=state.settings.delivery_days||'Monday,Friday';document.getElementById('set-pickup-start').value=state.settings.pickup_time_start||'17:00';document.getElementById('set-pickup-end').value=state.settings.pickup_time_end||'21:00';if(document.getElementById('set-clearent-api'))document.getElementById('set-clearent-api').value=state.settings.clearent_api_key?'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢':'';if(document.getElementById('set-clearent-terminal'))document.getElementById('set-clearent-terminal').value=state.settings.clearent_terminal_id||'';checkClearentStatus();renderUsersList();}catch(e){}}

// RENDERS
function renderServicesList(){const el=document.getElementById('services-list');if(!el)return;const g={};state.services.filter(s=>s.active).forEach(s=>{if(!g[s.category])g[s.category]=[];g[s.category].push(s);});el.innerHTML=['Wash & Fold','Dry Cleaning','Press','Alterations'].filter(c=>g[c]).map(c=>'<div class="card"><h3 style="color:var(--kp-teal)">'+c+'</h3>'+g[c].map(s=>'<div style="display:flex;justify-content:space-between;padding:.4rem 0;border-bottom:1px solid var(--kp-light-gray)"><span>'+s.name+'</span><span style="font-weight:600;color:var(--kp-teal)">'+formatCurrency(s.price)+'</span></div>').join('')+'</div>').join('');}

function renderPOSServices(){const te=document.getElementById('category-tabs'),ge=document.getElementById('service-grid');if(!te||!ge)return;const active=state.services.filter(s=>s.active);const cats=['Wash & Fold','Dry Cleaning','Press','Alterations'].filter(c=>active.some(s=>s.category===c));te.innerHTML=cats.map(c=>'<button class="category-tab '+(state.activeCategory===c?'active':'')+'" onclick="state.activeCategory=\''+c+'\';renderPOSServices()">'+c+'</button>').join('');const f=active.filter(s=>s.category===state.activeCategory).sort((a,b)=>(a.sortOrder||99)-(b.sortOrder||99));
if(state.activeCategory==='Wash & Fold'){const subs=[{n:'Wash & Fold',f:s=>s.name.includes('Wash & Fold')},{n:'Blankets',f:s=>s.name.includes('Blanket')},{n:'Comforters',f:s=>s.name.includes('Comforter')},{n:'Pillows',f:s=>s.name.includes('Pillow')},{n:'Rugs',f:s=>s.name.includes('Rug')},{n:'Manhattan',f:s=>s.name.includes('Manhattan')}];ge.innerHTML=subs.map(sub=>{const items=f.filter(sub.f);if(!items.length)return'';return'<div style="margin-bottom:.75rem"><div class="subcat-header">'+sub.n+'</div><div class="service-grid">'+items.map(s=>'<button class="service-btn" onclick="addToCart('+s.id+')"><div style="font-weight:600">'+s.name.replace('Wash & Fold - ','').replace(sub.n+' - ','')+'</div><div style="color:var(--kp-teal);font-weight:700">'+formatCurrency(s.price)+'</div></button>').join('')+'</div></div>';}).join('');}
else{ge.innerHTML='<div class="service-grid" style="grid-template-columns:repeat(auto-fill,minmax(140px,1fr))">'+f.map(s=>'<button class="service-btn" onclick="addToCart('+s.id+')"><div style="font-weight:600">'+s.name+'</div><div style="color:var(--kp-teal);font-weight:700">'+formatCurrency(s.price)+'</div></button>').join('')+'</div>';}renderCart();}

function renderCart(){const ie=document.getElementById('cart-items'),te=document.getElementById('cart-totals'),ce=document.getElementById('customer-display');if(!ie||!te)return;if(ce)ce.innerHTML=state.selectedCustomer?'<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>'+state.selectedCustomer.name+'</strong><br><span style="color:var(--kp-gray)">'+(state.selectedCustomer.phone||'')+'</span></div><button class="btn btn-sm btn-outline" onclick="state.selectedCustomer=null;renderCart()">Ã—</button></div>':'<button class="btn btn-outline" style="width:100%" onclick="showCustomerModal()">ğŸ‘¤ Select Customer</button>';const disc=state.selectedCustomer?.discount||0;const adj=state.adjustment||0;const sub=state.cart.reduce((s,c)=>s+c.price*c.quantity,0);const discAmt=sub*(disc/100);const afterDisc=sub-discAmt+adj;const tax=afterDisc*0.08875;const tot=Math.max(0,afterDisc+tax);ie.innerHTML=state.cart.length===0?'<p style="text-align:center;color:var(--kp-gray)">Empty</p>':state.cart.map(c=>{const lb=c.unit==='lb';return'<div class="cart-item"><div style="flex:1"><div style="font-weight:500">'+c.name+'</div><div style="color:var(--kp-gray)">'+formatCurrency(c.price)+' Ã— '+c.quantity+'</div></div><div class="cart-item-qty">'+(lb?'<input type="number" step="0.1" min="0.1" value="'+c.quantity+'" style="width:100px;padding:.5rem;font-size:1.1rem;text-align:center" onchange="setCartQty('+c.id+',parseFloat(this.value)||0)">':'<button onclick="updateCartQty('+c.id+',-1)">âˆ’</button><span style="min-width:24px;text-align:center;font-size:1.1rem">'+c.quantity+'</span><button onclick="updateCartQty('+c.id+',1)">+</button>')+'<button onclick="removeFromCart('+c.id+')" style="background:var(--kp-red);color:#fff;margin-left:.5rem;padding:.5rem">Ã—</button></div></div>';}).join('');te.innerHTML='<div style="display:flex;justify-content:space-between"><span>Subtotal</span><span>'+formatCurrency(sub)+'</span></div>'+(disc>0?'<div style="display:flex;justify-content:space-between;color:var(--kp-green)"><span>Disc '+disc+'%</span><span>-'+formatCurrency(discAmt)+'</span></div>':'')+(adj!==0?'<div style="display:flex;justify-content:space-between"><span>Adj</span><span>'+formatCurrency(adj)+'</span></div>':'')+'<div style="display:flex;justify-content:space-between"><span>Tax</span><span>'+formatCurrency(tax)+'</span></div><div style="display:flex;justify-content:space-between;font-weight:700;font-size:1.2rem;color:var(--kp-teal)"><span>Total</span><span>'+formatCurrency(tot)+'</span></div>';renderPaymentButtons();}

function renderPaymentButtons(){const pe=document.getElementById('payment-buttons');if(!pe)return;pe.innerHTML=[['cash','ğŸ’µ Cash'],['card','ğŸ’³ Card'],['terminal','ğŸ”Œ Terminal'],['unpaid','â³ Unpaid']].map(([v,l])=>'<button class="btn btn-sm '+(state.paymentMethod===v?'btn-primary':'btn-outline')+'" onclick="setPayment(\''+v+'\')">'+l+'</button>').join('');}
function setPayment(m){state.paymentMethod=m;renderPaymentButtons();}

function renderOrdersTable(){const el=document.getElementById('orders-table');if(!el)return;el.innerHTML=state.orders.length===0?'<p>No orders</p>':'<table><thead><tr><th>Order</th><th>Customer</th><th>Status</th><th>Total</th><th></th></tr></thead><tbody>'+state.orders.map(o=>'<tr><td><strong style="color:var(--kp-teal)">'+o.order_number+'</strong><br><span style="font-size:.8rem;color:var(--kp-gray)">'+formatDate(o.created_at)+'</span></td><td>'+(o.customer_name||'Walk-in')+'</td><td><span class="badge badge-'+o.status+'">'+o.status+'</span></td><td>'+formatCurrency(o.total)+'</td><td><button class="btn btn-sm btn-outline" onclick="viewOrder('+o.id+')">View</button></td></tr>').join('')+'</tbody></table>';}

function renderCustomerList(){const el=document.getElementById('customers-list');if(!el)return;const s=state.customerSearch?.toLowerCase()||'';const f=state.customers.filter(c=>!s||c.name?.toLowerCase().includes(s)||c.phone?.includes(s));el.innerHTML=f.length===0?'<p>None</p>':'<table><thead><tr><th>Name</th><th>Phone</th><th></th></tr></thead><tbody>'+f.slice(0,50).map(c=>'<tr><td>'+c.name+'</td><td>'+(c.phone||'-')+'</td><td><button class="btn btn-sm btn-outline" onclick="editCustomerProfile('+c.id+')">Edit</button></td></tr>').join('')+'</tbody></table>';}

function renderClockStatus(s){const el=document.getElementById('clock-status');if(!el)return;el.innerHTML='<div style="padding:.75rem;border-radius:8px;text-align:center;margin:.75rem 0;background:'+(s.clockedIn?'#D1FAE5':'#FEE2E2')+'"><strong>'+(s.clockedIn?'âœ… Clocked In':'â° Not Clocked In')+'</strong></div><button class="btn '+(s.clockedIn?'btn-danger':'btn-success')+'" style="width:100%" onclick="'+(s.clockedIn?'clockOut()':'clockIn()')+'">'+(s.clockedIn?'ğŸšª Clock Out':'ğŸ Clock In')+'</button>';}

function renderCashStatus(cs){const el=document.getElementById('cash-status');if(!el)return;el.innerHTML='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.4rem;text-align:center;margin-bottom:1rem"><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px"><div style="font-size:.8rem;color:var(--kp-gray)">Opening</div><div style="font-weight:700">'+(cs.opening?formatCurrency(cs.opening.total):'--')+'</div></div><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px"><div style="font-size:.8rem;color:var(--kp-gray)">Cash Sales</div><div style="font-weight:700;color:var(--kp-green)">+'+formatCurrency(cs.cashSales)+'</div></div><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px"><div style="font-size:.8rem;color:var(--kp-gray)">Expenses</div><div style="font-weight:700;color:var(--kp-red)">-'+formatCurrency(cs.expenseTotal||0)+'</div></div><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px"><div style="font-size:.8rem;color:var(--kp-gray)">Expected</div><div style="font-weight:700">'+formatCurrency(cs.expectedCash)+'</div></div></div>'+(cs.hasMismatch?'<div style="background:#FEE2E2;color:var(--kp-red);padding:.5rem;border-radius:6px;text-align:center"><strong>âš ï¸ Mismatch: '+formatCurrency(cs.mismatch)+'</strong></div>':'');}

function renderStaffSummary(d){const el=document.getElementById('staff-summary');if(!el)return;if(d.staff.length===0){el.innerHTML='<p style="color:var(--kp-gray)">No data for selected period</p>';return;}const totHours=d.staff.reduce((s,x)=>s+parseFloat(x.hoursWorked||0),0);const totSales=d.staff.reduce((s,x)=>s+(x.sales||0),0);const totWeight=d.staff.reduce((s,x)=>s+(x.weight||0),0);const totOrders=d.staff.reduce((s,x)=>s+(x.ordersProcessed||0),0);el.innerHTML='<table><thead><tr><th>Staff</th><th>Hours</th><th>Sales</th><th>Weight (lbs)</th><th>Orders</th></tr></thead><tbody>'+d.staff.map(s=>'<tr><td>'+s.name+'</td><td>'+parseFloat(s.hoursWorked||0).toFixed(1)+'</td><td>'+formatCurrency(s.sales)+'</td><td>'+(s.weight||0).toFixed(1)+'</td><td>'+s.ordersProcessed+'</td></tr>').join('')+'</tbody><tfoot><tr style="background:var(--kp-cream);font-weight:700"><td>TOTAL</td><td>'+totHours.toFixed(1)+'</td><td>'+formatCurrency(totSales)+'</td><td>'+totWeight.toFixed(1)+'</td><td>'+totOrders+'</td></tr></tfoot></table>';}

function renderReportStats(d){const el=document.getElementById('report-stats'),ce=document.getElementById('top-customers');if(el)el.innerHTML='<div class="card"><div style="font-size:1.5rem;font-weight:700">'+d.totalOrders+'</div><div style="color:var(--kp-gray)">Orders</div></div><div class="card"><div style="font-size:1.5rem;font-weight:700">'+formatCurrency(d.totalRevenue||0)+'</div><div style="color:var(--kp-gray)">Revenue</div></div><div class="card"><div style="font-size:1.5rem;font-weight:700">'+(d.totalWeight||0).toFixed(1)+'</div><div style="color:var(--kp-gray)">lbs</div></div>';if(ce&&d.topCustomers)ce.innerHTML=d.topCustomers.length===0?'<p>No data</p>':'<table><thead><tr><th>Customer</th><th>Orders</th><th>Total</th></tr></thead><tbody>'+d.topCustomers.map(c=>'<tr><td>'+c.name+'</td><td>'+c.orders+'</td><td>'+formatCurrency(c.total)+'</td></tr>').join('')+'</tbody></table>';}

function renderServicesAdminList(){const el=document.getElementById('services-admin-list');if(!el)return;el.innerHTML=state.services.map(s=>'<div style="display:flex;align-items:center;gap:1rem;padding:.75rem;border-bottom:1px solid var(--kp-light-gray)"><div style="flex:1"><strong>'+s.name+'</strong><br><span style="color:var(--kp-gray)">'+s.category+'</span></div><div style="display:flex;align-items:center;gap:.5rem"><span style="font-size:1.1rem">$</span><input type="number" step="0.01" value="'+s.price.toFixed(2)+'" style="width:100px;padding:.5rem;font-size:1.1rem;text-align:right" onchange="updateServicePrice('+s.id+',this.value)"></div><label style="cursor:pointer;display:flex;align-items:center;gap:.5rem"><input type="checkbox" '+(s.active?'checked':'')+' onchange="toggleServiceActive('+s.id+',this.checked)" style="width:20px;height:20px"> <span>'+(s.active?'On':'Off')+'</span></label></div>').join('');}

function renderCustomerOrdersList(){const el=document.getElementById('customer-orders-list');if(!el)return;if(!state.customerOrders?.length){el.innerHTML='<div class="card" style="text-align:center"><p>No orders yet!</p></div>';return;}const st=['received','cleaned','ready','delivered'];el.innerHTML=state.customerOrders.map(o=>{const ci=st.indexOf(o.status);return'<div class="card" style="margin-bottom:1rem"><div style="display:flex;justify-content:space-between"><div><h3 style="color:var(--kp-teal)">'+o.order_number+'</h3><p style="color:var(--kp-gray)">'+formatDate(o.created_at)+'</p></div><span class="badge badge-'+o.status+'">'+o.status+'</span></div><div style="display:flex;justify-content:space-between;margin:1rem 0">'+st.map((s,i)=>'<div style="text-align:center;flex:1"><div style="width:28px;height:28px;border-radius:50%;background:'+(i<=ci?'var(--kp-teal)':'var(--kp-light-gray)')+';color:'+(i<=ci?'#fff':'var(--kp-gray)')+';display:flex;align-items:center;justify-content:center;margin:0 auto;font-size:.75rem">'+(i<=ci?'âœ“':i+1)+'</div><div style="font-size:.75rem;margin-top:.25rem">'+s+'</div></div>').join('')+'</div><p><strong>Total:</strong> '+formatCurrency(o.total)+'</p></div>';}).join('');}

function renderDriverOrdersList(orders){
const pickupsEl=document.getElementById('driver-pickups-list');
const deliveriesEl=document.getElementById('driver-deliveries-list');
if(!pickupsEl&&!deliveriesEl)return;
// Pickups: orders placed online that need to be picked up (received status, pickup_delivery type)
const pickups=orders.filter(o=>o.order_type==='pickup_delivery'&&(o.status==='received'||o.status==='collected'));
// Deliveries: orders that are ready to deliver
const deliveries=orders.filter(o=>o.status==='ready');
if(pickupsEl){pickupsEl.innerHTML=pickups.length===0?'<div class="card" style="text-align:center"><p>No pickups pending</p></div>':pickups.map(o=>'<div class="card" style="margin-bottom:1rem;border-left:4px solid var(--kp-teal)"><div style="display:flex;justify-content:space-between;align-items:center"><h3 style="color:var(--kp-teal)">'+o.order_number+'</h3><span class="badge badge-'+(o.status==='collected'?'collected':'received')+'">'+o.status+'</span></div><p>ğŸ‘¤ '+(o.customer_name||'Walk-in')+'</p><p>ğŸ“ <a href="tel:'+(o.customer_phone?.replace(/\D/g,'')||'')+'" style="color:var(--kp-teal)">'+(o.customer_phone||'N/A')+'</a></p><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px;margin:.5rem 0">ğŸ“ '+(o.customer_address||'No address')+'</div>'+(o.notes?'<p style="font-size:.9rem;color:var(--kp-gray)">'+o.notes+'</p>':'')+'<div style="display:flex;gap:.5rem"><a href="tel:'+(o.customer_phone?.replace(/\D/g,'')||'')+'" class="btn btn-outline btn-sm" style="flex:1">ğŸ“</a><a href="https://maps.google.com/?q='+encodeURIComponent(o.customer_address||'')+'" target="_blank" class="btn btn-outline btn-sm" style="flex:1">ğŸ—ºï¸</a>'+(o.status==='received'?'<button class="btn btn-primary btn-sm" style="flex:2" onclick="markCollected('+o.id+')">âœ“ '+t('collected')+'</button>':'<span class="badge badge-collected" style="flex:2;text-align:center">Collected</span>')+'</div></div>').join('');}
if(deliveriesEl){deliveriesEl.innerHTML=deliveries.length===0?'<div class="card" style="text-align:center"><p>No deliveries pending</p></div>':deliveries.map(o=>'<div class="card" style="margin-bottom:1rem;border-left:4px solid var(--kp-green)"><h3 style="color:var(--kp-green)">'+o.order_number+'</h3><p>ğŸ‘¤ '+(o.customer_name||'Walk-in')+'</p><p>ğŸ“ <a href="tel:'+(o.customer_phone?.replace(/\D/g,'')||'')+'" style="color:var(--kp-teal)">'+(o.customer_phone||'N/A')+'</a></p><div style="background:var(--kp-cream);padding:.5rem;border-radius:6px;margin:.5rem 0">ğŸ“ '+(o.customer_address||'No address')+'</div><p><strong>Total:</strong> '+formatCurrency(o.total)+'</p><div style="display:flex;gap:.5rem"><a href="tel:'+(o.customer_phone?.replace(/\D/g,'')||'')+'" class="btn btn-outline btn-sm" style="flex:1">ğŸ“</a><a href="https://maps.google.com/?q='+encodeURIComponent(o.customer_address||'')+'" target="_blank" class="btn btn-outline btn-sm" style="flex:1">ğŸ—ºï¸</a><button class="btn btn-success btn-sm" style="flex:2" onclick="startDeliveryPhoto('+o.id+')">ğŸ“¸ '+t('delivered')+'</button></div></div>').join('');}
}

function renderPickupDates(){const el=document.getElementById('pickup-dates');if(!el)return;const days=state.settings?.delivery_days?.split(',')||['Monday','Friday'];const dates=getNextDates(days,4);if(!state.selectedPickupDate&&dates.length)state.selectedPickupDate=dates[0].iso;el.innerHTML=dates.map(d=>'<div class="pickup-option '+(state.selectedPickupDate===d.iso?'selected':'')+'" onclick="selectPickupDate(\''+d.iso+'\')"><input type="radio" name="pickup-date" value="'+d.iso+'" '+(state.selectedPickupDate===d.iso?'checked':'')+'><div style="flex:1"><div style="font-size:1.2rem;font-weight:600">'+d.day+'</div><div style="color:var(--kp-gray)">'+d.display+'</div></div><div style="font-size:1.5rem">ğŸ“…</div></div>').join('');}
function selectPickupDate(iso){state.selectedPickupDate=iso;renderPickupDates();}

function renderUsersList(){const el=document.getElementById('users-list');if(!el)return;el.innerHTML=state.users.map(u=>'<div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem;border-bottom:1px solid var(--kp-light-gray)"><div><strong>'+u.name+'</strong> ('+u.username+')<br><span style="color:var(--kp-gray)">'+u.role+'</span></div><button class="btn btn-sm btn-outline" onclick="editUser('+u.id+')">Edit</button></div>').join('');}

// CART
function addToCart(id){const s=state.services.find(x=>x.id===id);if(!s)return;const e=state.cart.find(c=>c.id===id);if(e)e.quantity++;else state.cart.push({...s,quantity:1});renderCart();}
function updateCartQty(id,d){const i=state.cart.find(c=>c.id===id);if(i){i.quantity+=d;if(i.quantity<=0)state.cart=state.cart.filter(c=>c.id!==id);}renderCart();}
function setCartQty(id,qty){const i=state.cart.find(c=>c.id===id);if(i){if(qty<=0)state.cart=state.cart.filter(c=>c.id!==id);else i.quantity=qty;}renderCart();}
function removeFromCart(id){state.cart=state.cart.filter(c=>c.id!==id);renderCart();}
function clearCart(){state.cart=[];state.selectedCustomer=null;state.adjustment=0;const el=document.getElementById('order-adjustment');if(el)el.value=0;renderCart();}
function addMinimumOrder(){const wf=state.services.find(s=>s.name==='Wash & Fold - Regular'&&s.active);if(wf){state.cart=[{...wf,quantity:10}];renderCart();toast('Minimum 10 lbs added');}else{toast('Service not found','error');}}

// DRIVER ACTIONS  
async function markCollected(id){try{await api('/orders/'+id+'/status',{method:'PUT',body:{status:'collected'}});toast('Marked as collected!');loadDriverOrders();}catch(e){toast(e.message,'error');}}

// CUSTOMER
function showCustomerModal(){state.modal='customer';render();}
function searchCustomer(q){const m=state.customers.filter(c=>c.phone?.replace(/\D/g,'').includes(q.replace(/\D/g,''))||c.name?.toLowerCase().includes(q.toLowerCase()));document.getElementById('search-results').innerHTML=m.length===0?'<p style="color:var(--kp-gray)">No match</p>':m.slice(0,5).map(c=>'<div style="padding:.5rem;border:1px solid var(--kp-light-gray);border-radius:6px;margin-bottom:.25rem;cursor:pointer" onclick="selectFoundCustomer('+c.id+')"><strong>'+c.name+'</strong> - '+c.phone+'</div>').join('');}
function selectFoundCustomer(id){const c=state.customers.find(x=>x.id===id);if(c){document.getElementById('cust-name').value=c.name||'';document.getElementById('cust-phone').value=c.phone||'';document.getElementById('cust-address').value=c.address||'';state.selectedCustomer=c;}}
async function saveCustomer(){const n=document.getElementById('cust-name').value,p=document.getElementById('cust-phone').value,a=document.getElementById('cust-address').value;if(!n||!p){toast('Name & phone required','error');return;}try{let c=state.customers.find(x=>x.phone?.replace(/\D/g,'')===p.replace(/\D/g,''));if(c)c=await api('/customers/'+c.id,{method:'PUT',body:{name:n,phone:p,address:a}});else{c=await api('/customers',{method:'POST',body:{name:n,phone:p,address:a}});state.customers.push(c);}state.selectedCustomer=c;closeModal();renderCart();toast('Saved!');}catch(e){toast(e.message,'error');}}
async function editCustomerProfile(id){const c=state.customers.find(x=>x.id===id);if(c){state.editingCustomer=c;state.modal='edit-customer';render();}}

// ORDERS
async function submitOrder(){
  // Validation
  if(!state.cart.length){toast('Cart is empty','error');return;}
  if(!state.paymentMethod){toast('Select a payment method','error');return;}
  
  const w=state.cart.filter(c=>c.unit==='lb').reduce((s,c)=>s+c.quantity,0);
  const disc=state.selectedCustomer?.discount||0;
  const adj=state.adjustment||0;
  const sub=state.cart.reduce((s,c)=>s+c.price*c.quantity,0);
  const discAmt=sub*(disc/100);
  const afterDisc=sub-discAmt+adj;
  const tax=afterDisc*0.08875;
  const total=Math.max(0,afterDisc+tax);
  
  try{
    const o=await api('/orders',{method:'POST',body:{customer_id:state.selectedCustomer?.id,customer_name:state.selectedCustomer?.name||'Walk-in',customer_phone:state.selectedCustomer?.phone||'',customer_address:state.selectedCustomer?.address||'',order_type:'counter',items:state.cart.map(c=>({service_id:c.id,service_name:c.name,quantity:c.quantity,price:c.price})),payment_method:state.paymentMethod==='terminal'?'card':state.paymentMethod,weight:w,adjustment:state.adjustment,discount:state.selectedCustomer?.discount||0}});
    if(state.paymentMethod==='terminal'){const paid=await processCardPayment(o.id,total,o.order_number);if(!paid){toast('Order created but payment pending','error');}}
    else if(['cash','card'].includes(state.paymentMethod)){await api('/orders/'+o.id+'/payment',{method:'PUT',body:{payment_status:'paid',payment_method:state.paymentMethod}});}
    toast('Order '+o.order_number+' created!');clearCart();
  }catch(e){toast(e.message,'error');}
}
function viewOrder(id){state.selectedOrder=state.orders.find(o=>o.id===id);state.modal='order-detail';render();}
async function updateOrderStatus(id,s){try{await api('/orders/'+id+'/status',{method:'PUT',body:{status:s}});toast('Updated!');state.selectedOrder.status=s;render();loadOrders();}catch(e){toast(e.message,'error');}}

// CUSTOMER ORDER
async function submitCustomerOrder(e){
  e.preventDefault();
  const addr=document.getElementById('order-address').value;
  const notes=document.getElementById('order-notes').value;
  
  // Validation
  if(!addr||addr.trim().length<5){toast('Please enter a valid address','error');return;}
  if(!state.selectedPickupDate){toast('Please select a pickup date','error');return;}
  
  // Get selected payment method
  const paymentMethod=state.customerPaymentMethod||'pay_later';
  
  try{
    await api('/public/orders',{method:'POST',body:{customer_name:state.customer.name,customer_phone:state.customer.phone,customer_email:state.customer.email,customer_address:addr,order_type:'pickup_delivery',payment_method:paymentMethod,items:[{service_id:1,service_name:'Wash & Fold',quantity:1,price:1.40}],notes:'Pickup: '+state.selectedPickupDate+'. Payment: '+paymentMethod+'. '+notes,weight:0}});
    toast('Pickup scheduled! We\'ll contact you soon.');
    navigate('my-orders');
  }catch(e){toast(e.message,'error');}
}

// DRIVER
function startDeliveryPhoto(id){state.photoOrderId=id;state.photoData=null;state.modal='photo';render();setTimeout(initCamera,100);}
async function initCamera(){const v=document.getElementById('camera-feed');if(!v)return;try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});v.srcObject=s;}catch(e){toast('Camera denied','error');closeModal();}}
function capturePhoto(){const v=document.getElementById('camera-feed'),c=document.getElementById('photo-canvas');if(!v||!c)return;c.width=v.videoWidth;c.height=v.videoHeight;c.getContext('2d').drawImage(v,0,0);state.photoData=c.toDataURL('image/jpeg',0.7);const s=v.srcObject;if(s)s.getTracks().forEach(t=>t.stop());render();}
function retakePhoto(){state.photoData=null;render();setTimeout(initCamera,100);}
async function confirmDelivery(){if(!state.photoData||!state.photoOrderId)return;try{await api('/orders/'+state.photoOrderId+'/deliver',{method:'POST',body:{photo:state.photoData}});toast('Delivered!');closeModal();loadDriverOrders();}catch(e){toast(e.message,'error');}}

// STAFF
async function clockIn(){try{await api('/time-entries/clock-in',{method:'POST'});toast('Clocked in!');loadStaffData();}catch(e){toast(e.message,'error');}}
async function clockOut(){try{await api('/time-entries/clock-out',{method:'POST'});toast('Clocked out!');loadStaffData();}catch(e){toast(e.message,'error');}}
let cashType='opening';
function showCashTab(type,el){cashType=type;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderCashForm();}
function renderCashForm(){const el=document.getElementById('cash-form-area');if(!el)return;if(cashType==='expense'){el.innerHTML='<div style="margin-top:1rem"><div class="form-group"><label class="form-label">Expense Amount</label><div style="display:flex;align-items:center;gap:.5rem"><span style="font-size:1.2rem">$</span><input type="number" id="expense-amount" step="0.01" min="0" value="0" style="width:120px;padding:.75rem;font-size:1.1rem"></div></div><div class="form-group"><label class="form-label">Description / Reason</label><input type="text" id="expense-desc" placeholder="e.g. Supplies, Inventory payment..." style="padding:.75rem"></div><div class="form-group"><label class="form-label">Notes</label><textarea id="expense-notes" rows="2" placeholder="Additional details..." style="padding:.75rem"></textarea></div><button class="btn btn-primary" onclick="submitExpense()">Submit Expense</button></div>';}else{el.innerHTML='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin-top:1rem">'+['100','50','20','10','5','1'].map(d=>'<div style="text-align:center"><label style="font-weight:600">$'+d+'</label><input type="number" id="cash-'+d+'" min="0" value="0" oninput="calculateCashTotal()" style="text-align:center;padding:.5rem;font-size:1.1rem"></div>').join('')+'<div style="text-align:center"><label style="font-weight:600">Coins</label><input type="number" id="cash-change" min="0" step="0.01" value="0" oninput="calculateCashTotal()" style="text-align:center;padding:.5rem;font-size:1.1rem"></div><div style="text-align:center"><label style="font-weight:600">Total</label><input type="text" id="cash-total" readonly value="$0.00" style="text-align:center;padding:.5rem;font-size:1.1rem;font-weight:700;background:var(--kp-cream)"></div></div><div class="form-group" style="margin-top:1rem"><label class="form-label">Shift Notes (optional)</label><textarea id="cash-notes" rows="2" placeholder="Notes about your shift..." style="padding:.75rem"></textarea></div><button class="btn btn-primary" style="margin-top:.5rem" onclick="submitCashCount()">Submit '+(cashType==='opening'?'Opening':'Closing')+' Count</button>';}}
function calculateCashTotal(){const t=(parseInt(document.getElementById('cash-100')?.value||0)*100)+(parseInt(document.getElementById('cash-50')?.value||0)*50)+(parseInt(document.getElementById('cash-20')?.value||0)*20)+(parseInt(document.getElementById('cash-10')?.value||0)*10)+(parseInt(document.getElementById('cash-5')?.value||0)*5)+(parseInt(document.getElementById('cash-1')?.value||0)*1)+parseFloat(document.getElementById('cash-change')?.value||0);document.getElementById('cash-total').value=formatCurrency(t);}
async function submitCashCount(){try{await api('/cash-drawer',{method:'POST',body:{type:cashType,hundreds:parseInt(document.getElementById('cash-100').value)||0,fifties:parseInt(document.getElementById('cash-50').value)||0,twenties:parseInt(document.getElementById('cash-20').value)||0,tens:parseInt(document.getElementById('cash-10').value)||0,fives:parseInt(document.getElementById('cash-5').value)||0,ones:parseInt(document.getElementById('cash-1').value)||0,change:parseFloat(document.getElementById('cash-change').value)||0,notes:document.getElementById('cash-notes')?.value||''}});toast('Submitted!');loadStaffData();}catch(e){toast(e.message,'error');}}
async function submitExpense(){const amt=parseFloat(document.getElementById('expense-amount').value)||0;const desc=document.getElementById('expense-desc').value;if(amt<=0){toast('Enter amount','error');return;}if(!desc){toast('Enter description','error');return;}try{await api('/cash-drawer',{method:'POST',body:{type:'expense',amount:amt,description:desc,notes:document.getElementById('expense-notes')?.value||''}});toast('Expense recorded!');document.getElementById('expense-amount').value='0';document.getElementById('expense-desc').value='';document.getElementById('expense-notes').value='';loadStaffData();}catch(e){toast(e.message,'error');}}
function renderExpensesList(expenses){const el=document.getElementById('expenses-list');if(!el)return;if(!expenses||!expenses.length){el.innerHTML='<p style="color:var(--kp-gray)">No expenses today</p>';return;}el.innerHTML='<table><thead><tr><th>Time</th><th>Amount</th><th>Description</th><th>By</th></tr></thead><tbody>'+expenses.map(e=>'<tr><td>'+new Date(e.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+'</td><td style="color:var(--kp-red)">-'+formatCurrency(e.amount)+'</td><td>'+e.description+(e.notes?' <span style="color:var(--kp-gray)">- '+e.notes+'</span>':'')+'</td><td>'+e.user+'</td></tr>').join('')+'</tbody></table>';}

// SERVICES
async function updateServicePrice(id,p){try{await api('/services/'+id,{method:'PUT',body:{price:parseFloat(p)}});toast('Updated!');}catch(e){toast(e.message,'error');}}
async function toggleServiceActive(id,a){try{await api('/services/'+id,{method:'PUT',body:{active:a?1:0}});loadServices();}catch(e){toast(e.message,'error');}}

// SETTINGS
async function saveDeliverySettings(){try{await api('/settings',{method:'PUT',body:{delivery_days:document.getElementById('set-delivery-days').value,pickup_time_start:document.getElementById('set-pickup-start').value,pickup_time_end:document.getElementById('set-pickup-end').value}});toast('Saved!');}catch(e){toast(e.message,'error');}}

// CLEARENT TERMINAL
async function saveClearentSettings(){const apiKey=document.getElementById('set-clearent-api').value;const terminalId=document.getElementById('set-clearent-terminal').value;if(apiKey==='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'){toast('Enter new API key or leave unchanged','error');return;}try{await api('/settings',{method:'PUT',body:{clearent_api_key:apiKey,clearent_terminal_id:terminalId}});toast('Terminal settings saved!');checkClearentStatus();}catch(e){toast(e.message,'error');}}
async function checkClearentStatus(){try{const s=await api('/payments/clearent/status');const el=document.getElementById('clearent-status');if(el)el.innerHTML=s.configured?'<span style="color:var(--kp-green)">âœ… Terminal connected</span>':'<span style="color:var(--kp-red)">âš ï¸ Not configured</span>';}catch{}}
async function processCardPayment(orderId,amount,orderNumber){try{toast('Sending to terminal...');const r=await api('/payments/clearent',{method:'POST',body:{orderId,amount,orderNumber}});if(r.success){toast('Payment approved!');return true;}else{toast(r.error||'Payment declined','error');return false;}}catch(e){if(e.message.includes('not configured')){toast('Configure Clearent in Settings first','error');}else{toast(e.message||'Terminal error','error');}return false;}}

// USERS
function editUser(id){state.editingUser=state.users.find(u=>u.id===id);state.modal='edit-user';render();}
async function addUser(e){e.preventDefault();try{await api('/users',{method:'POST',body:{name:document.getElementById('new-user-name').value,username:document.getElementById('new-user-username').value,password:document.getElementById('new-user-password').value,role:document.getElementById('new-user-role').value}});toast('Added!');closeModal();loadSettingsPage();}catch(e){toast(e.message,'error');}}
async function updateUser(e){e.preventDefault();const b={name:document.getElementById('edit-user-name').value,username:document.getElementById('edit-user-username').value,role:document.getElementById('edit-user-role').value};const pw=document.getElementById('edit-user-password').value;if(pw)b.password=pw;try{await api('/users/'+state.editingUser.id,{method:'PUT',body:b});toast('Saved!');closeModal();loadSettingsPage();}catch(e){toast(e.message,'error');}}

// INIT
(async()=>{
const path=window.location.pathname.slice(1)||'home';
const validPages=['home','login','register','my-orders','place-order','driver','pos','orders','customers','staff','reports','services-admin','settings','contact'];
state.page=validPages.includes(path)?path:'home';
history.replaceState({page:state.page},'','/'+state.page);
if(state.token){try{state.user=await api('/auth/me');}catch{state.token=null;localStorage.removeItem('token');}}
if(state.customerToken){try{state.customer=await api('/public/customer-info');}catch{state.customerToken=null;localStorage.removeItem('customerToken');}}
render();
})();
</script>
</body>
</html>
